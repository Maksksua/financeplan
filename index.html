<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивний Планувальник Ліквідності (36 Місяців)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .input-group { background-color: #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .data-input { 
            border: 1px solid #d1d5db; 
            padding: 0.25rem; 
            font-size: 0.875rem; 
            border-radius: 0.25rem;
            text-align: center;
        }
        .data-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
        }
        .warning-text {
            color: #ef4444; /* Tailwind red-500 */
            font-weight: 600;
        }
        .text-purple-700 {
            color: #7c3aed; /* Tailwind purple-600 */
        }
        .text-blue-700 {
            color: #1d4ed8; /* Tailwind blue-700 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Інтерактивна Таблиця Ліквідності (3 Роки)</h1>
            <p class="text-md text-gray-600 mt-2">Ви повністю контролюєте **Продажі**, **Закупівлі** та **Фіксовані Витрати**.</p>
        </header>

        <main>
            <!-- Input Data Section -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-semibold mb-4 text-blue-700">1. Ключові вхідні дані</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Фінансування та Податкові фактори</h4>
                        
                        <!-- СТАРТОВИЙ КАПІТАЛ - ТЕПЕР РЕДАГУЄТЬСЯ -->
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold">Стартовий Капітал (Грант, €):</span>
                            <input type="number" id="grant" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold">Власні Кошти/Заощадження (€):</span>
                            <input type="number" id="savings" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        
                        <!-- ДЕПОЗИТ І ЙОГО РОЗПОДІЛ -->
                        <label class="block mb-2 mt-4"><span class="text-gray-700 text-sm font-bold">Застава оренди (Депозит, €):</span>
                            <input type="number" id="rentDeposit" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold">Розподіл депозиту (міс., 0=у М1):</span>
                            <input type="number" id="rentDepositSpreadMonths" value="0" class="mt-1 block w-full rounded-md shadow-sm p-2" min="0" max="12">
                        </label>


                        <!-- ОСОБИСТІ ВИТРАТИ: Залишаються у внутрішніх розрахунках -->
                        <input type="hidden" id="healthInsurance" value="400"> 
                        <input type="hidden" id="personalCosts" value="1450">
                        
                        <p class="text-sm mt-4 p-2 bg-blue-100 rounded-md font-semibold">
                            Тип діяльності: Малий приватний підприємець (Einzelunternehmen)
                        </p>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Юніт-економіка (на 1 авто)</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Середня ціна продажу (БРУТТО, €):</span>
                            <input type="number" id="avgSalePrice" value="4500" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Ціна закупівлі (€):</span>
                            <input type="number" id="carPurchase" value="2300" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Витрати на підготовку (€):</span>
                            <input type="number" id="prepCosts" value="850" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <p class="text-sm mt-4 p-2 bg-yellow-100 rounded-md">Вартість 1 авто (закупка + підготовка) = <span id="costPerCarDisplay" class="font-bold"></span></p>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Податковий Режим та Jobcenter</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Режим ПДВ:</span>
                            <select id="ustRegime" class="mt-1 block w-full rounded-md shadow-sm p-2">
                                <option value="regular">Стандартний (Regelbesteuerung)</option>
                                <option value="margin">Differenzbesteuerung (§25a UStG)</option>
                                <option value="kleinunternehmer">Малий підприємець (§19 UStG)</option>
                            </select>
                        </label>
                        
                        <!-- Jobcenter Coverage -->
                        <div class="mt-4 p-2 bg-pink-100 rounded-md">
                            <h5 class="font-semibold text-sm mb-1">Покриття Jobcenter (Перші 6 міс.)</h5>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="jobcenterCoversHousing" class="rounded">
                                <span class="text-gray-700 text-sm">Jobcenter покриває житло</span>
                            </label>
                            <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="jobcenterCoversInsurance" class="rounded">
                                <span class="text-gray-700 text-sm">Jobcenter покриває мед/соц</span>
                            </label>
                        </div>
                        
                        <!-- VAT OPTIONS -->
                        <label id="purchaseWithVAT_label" class="flex items-center space-x-2 mt-4">
                            <input type="checkbox" id="purchaseWithVAT" checked class="rounded">
                            <span class="text-gray-700 text-sm">Закупівля авто з ПДВ (є Vorsteuer)</span>
                        </label>
                        <label id="rentHasVAT_label" class="flex items-center space-x-2 mt-1">
                            <input type="checkbox" id="rentHasVAT" class="rounded">
                            <span class="text-gray-700 text-sm">Оренда площі з ПДВ</span>
                        </label>
                       

                        <p class="text-xs text-red-500 mt-4">Усі податки (GwSt, ESt) розраховуються на річній основі та сплачуються щоквартальними авансами.</p>
                        <button id="calculate-button" class="mt-4 w-full px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-md">Перерахувати</button>
                    </div>
                </div>
            </div>

            <!-- SALES PLAN (Integrated in the table/scrollable) -->
            <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
                <h3 class="p-0 font-semibold text-lg text-blue-700 mb-4">Детальний Фінансовий Звіт (36 місяців)</h3>
                <p class="text-sm text-gray-600 mb-4">Ви можете редагувати **Продажі**, **Куплено** та **Місячні Витрати** безпосередньо в таблиці.</p>
                <div class="overflow-x-auto">
                    <table id="dataTable" class="min-w-full text-sm text-left text-gray-500 border-collapse">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th scope="col" class="px-3 py-2">Міс.</th>
                                <th scope="col" class="px-3 py-2 w-20">Продажі (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20">Куплено (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20">Оренда площі (бізнес) €</th>
                                <th scope="col" class="px-3 py-2 w-20">Інші Пост. (€)</th>
                                <th scope="col" class="px-3 py-2">Запас</th>
                                <th scope="col" class="px-3 py-2 text-green-700">EBIT (Прибуток)</th>
                                <th scope="col" class="px-3 py-2 text-blue-700">Cash Flow (Чистий)</th>
                                <th scope="col" class="px-3 py-2 text-red-700">USt (Сплата)</th>
                                <th scope="col" class="px-3 py-2 font-bold">Аванс ESt+GwSt</th>
                                <th scope="col" class="px-3 py-2">GwSt (Річний)</th>
                                <th scope="col" class="px-3 py-2">ESt (Річний)</th>
                                <th scope="col" class="px-3 py-2 text-green-800 font-bold">Чистий Прибуток (Фінал)</th>
                                <th scope="col" class="px-3 py-2 font-bold">Залишок (Подуш. безп.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const NUM_MONTHS = 36;
        const FREIBETRAG_GEWST = 24500; 
        const GRUNDFREIBETRAG_EST = 12096; 
        const UST_RATE = 0.19;
        const UST_SATZ = 19;
        const HEBESATZ = 467; 
        
        let processedData;
        
        function calculateESt(taxableIncome, gewStCredit = 0) {
            let tax = 0;
            if (taxableIncome < 0) return { tax: 0, finalTax: 0 };
            const Y = (taxableIncome - GRUNDFREIBETRAG_EST) / 10000;
            if (taxableIncome < GRUNDFREIBETRAG_EST) {
                tax = 0;
            } else if (taxableIncome <= 15999) {
                tax = (980.14 * Y + 1400) * Y;
            } else if (taxableIncome <= 62809) {
                tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
            } else if (taxableIncome <= 277825) {
                tax = 0.42 * taxableIncome - 9877.94;
            } else {
                tax = 0.45 * taxableIncome - 17316.5;
            }
            const finalTax = Math.max(0, tax - gewStCredit);
            return { tax: Math.max(0, tax), finalTax: finalTax };
        }

        function formatCurrency(value) {
            if (value === "TBD" || isNaN(value) || value === null) return "0.00 €";
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(value);
        }
        
        function getInputs() {
            const salesPlan = [];
            const purchasePlan = [];
            const rentPlan = []; 
            const otherFixedPlan = []; 
            
            // Collect data directly from the dynamic table inputs
            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesInput = document.getElementById(`salesPlan_${i}`);
                const purchaseInput = document.getElementById(`purchasePlan_${i}`);
                const rentInput = document.getElementById(`rentPlan_${i}`); 
                const otherFixedInput = document.getElementById(`otherFixedPlan_${i}`); 

                // Sales plan (user input)
                salesPlan.push(parseInt(salesInput?.value) || 0);
                
                // Purchase plan (user input)
                purchasePlan.push(parseInt(purchaseInput?.value) || 0);
                
                // Monthly Rent/Lease (NEW)
                rentPlan.push(parseFloat(rentInput?.value) || 0);
                
                // Other Fixed Monthly Costs (NEW)
                otherFixedPlan.push(parseFloat(otherFixedInput?.value) || 0);
            }
            
            // Collect editable inputs (now includes grant, savings, deposit, insurance)
            return {
                grant: parseFloat(document.getElementById('grant').value) || 0, 
                savings: parseFloat(document.getElementById('savings').value) || 0, 
                avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
                carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
                prepCosts: parseFloat(document.getElementById('prepCosts').value) || 0,
                healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0, 
                personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0, 
                ustRegime: document.getElementById('ustRegime').value,
                purchaseWithVAT: document.getElementById('purchaseWithVAT')?.checked ?? true, // NEW CHECKBOX ID
                rentHasVAT: document.getElementById('rentHasVAT')?.checked ?? false,
                jobcenterCoversHousing: document.getElementById('jobcenterCoversHousing')?.checked ?? false, // FIX: Default to false
                jobcenterCoversInsurance: document.getElementById('jobcenterCoversInsurance')?.checked ?? false, // FIX: Default to false
                salesPlan: salesPlan,
                purchasePlan: purchasePlan,
                rentDeposit: parseFloat(document.getElementById('rentDeposit').value) || 0, 
                rentDepositSpreadMonths: parseInt(document.getElementById('rentDepositSpreadMonths').value) || 0,
                rentPlan: rentPlan, 
                otherFixedPlan: otherFixedPlan 
            };
        }
        
        // Function to set up the initial *realistic* plan
        function populateInitialSalesPlan() {
             const initialSalesPlan = [];
             for (let i = 0; i < NUM_MONTHS; i++) {
                if (i < 2) {
                    initialSalesPlan.push(1); 
                } else if (i < 4) {
                    initialSalesPlan.push(2); 
                } else if (i < 6) {
                    initialSalesPlan.push(3); 
                } else if (i < 9) {
                    initialSalesPlan.push(4); 
                } else if (i < 12) {
                    initialSalesPlan.push(5); 
                } else if (i < 24) {
                    initialSalesPlan.push(7);
                } else {
                    initialSalesPlan.push(10);
                }
            }
            return initialSalesPlan;
        }

        function populateInitialRentPlan() {
            return Array(NUM_MONTHS).fill(560); // Set default to 560 EUR
        }

        function populateInitialOtherFixedPlan() {
            return Array(NUM_MONTHS).fill(740); // 1300 (total fixed) - 560 (rent) = 740 EUR
        }

        // AUTO-GENERATING INITIAL PURCHASE PLAN based on the logic: buy 1 more than needed for M1, then follow sales
        function generateInitialPurchasePlan(salesPlan) {
            const initialPurchasePlan = [];
            let inventory = 0; 

            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesTarget = salesPlan[i];
                let carsToBuy = 0;
                
                // Assuming sales and purchase are synced for minimal risk, M1 needs initial stock
                if (i === 0) {
                    // M1: Buy 2 (to match sales and maintain zero initial stock)
                    carsToBuy = 2;
                } else {
                    // M2 and onwards: Buy exactly what you sell this month
                    carsToBuy = salesTarget;
                }
                
                // Update inventory for next loop
                inventory += carsToBuy - salesTarget;
                initialPurchasePlan.push(carsToBuy);
            }
            
            return initialPurchasePlan;
        }


        function processData() {
            const inputs = getInputs();
            const data = [];
            
            const isRegular = inputs.ustRegime === 'regular';
            const isMargin  = inputs.ustRegime === 'margin';
            const isKU      = inputs.ustRegime === 'kleinunternehmer';

            // FIX: accumulatedCashBalance starts with 10k. No double injection.
            let accumulatedCashBalance = inputs.grant + inputs.savings; 
            let currentInventory = 0;
            let yearlyEbit = 0;
            let yearly_gew_ertrag = 0;
            let last_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0 };
            let ust_period_due = 0;
            const COST_PER_CAR = inputs.carPurchase + inputs.prepCosts;
            const PERSONAL_COSTS_HOUSING = inputs.personalCosts; // Житло
            const PERSONAL_COSTS_INSURANCE = inputs.healthInsurance; // Соц. внески

            for (let i = 0; i < NUM_MONTHS; i++) {
                const carsSoldTarget = inputs.salesPlan[i];
                const carsBought = inputs.purchasePlan[i];
                
                // Monthly Fixed Costs from the table inputs
                const rentCostMonthly = inputs.rentPlan[i]; 
                const otherFixedCostMonthly = inputs.otherFixedPlan[i]; 
                
                // --- P&L EXPENSE COMPONENTS (NETTO/BRUTTO) ---
                const totalFixedCostsPnlNetto = rentCostMonthly + otherFixedCostMonthly; // Base P&L fixed cost (before VAT factor)
                
                // INVENTORY CHECK & CLAMPING
                const potentialInventory = currentInventory + carsBought;
                const carsSold = Math.min(carsSoldTarget, potentialInventory); // CLAMP SALES
                const inventoryWarning = carsSoldTarget > potentialInventory;

                // --- P&L EXPENSE COMPONENTS ---
                const expensePnlFactor = isKU ? (1 + UST_RATE) : 1;
                const cogsPnl = carsSold * COST_PER_CAR * expensePnlFactor; // COGS is Gross for KU, Net for Regular/Margin
                let totalExpensesPnl = totalFixedCostsPnlNetto * expensePnlFactor + cogsPnl;
                
                // --- CASH FLOW OUTFLOW COMPONENTS (BRUTTO FOR MOST) ---
                
                // 1. Personal Costs (Jobcenter Coverage Logic)
                const inJobcenterWindow = i < 6; // M1-M6
                let housingCashOutflow = PERSONAL_COSTS_HOUSING; 
                let insuranceCashOutflow = PERSONAL_COSTS_INSURANCE; 

                // FIX: Jobcenter coverage
                if (inJobcenterWindow && inputs.jobcenterCoversHousing) housingCashOutflow = 0;
                if (inJobcenterWindow && inputs.jobcenterCoversInsurance) insuranceCashOutflow = 0;
                
                // 2. Operating Fixed Costs (VAT logic)
                const rentVatFactor = inputs.rentHasVAT ? (1 + UST_RATE) : 1;
                const operatingRentOutflow = rentCostMonthly * rentVatFactor;
                const operatingOtherFixedOutflow = otherFixedCostMonthly * (1 + UST_RATE); // Assume other fixed are VAT-inclusive
                
                const operatingFixedOutflow = operatingRentOutflow + operatingOtherFixedOutflow;
                
                // 3. RENT DEPOSIT: Paid without VAT, with optional spreading
                let rentDepositCashOutflow = 0;
                if (i === 0 && inputs.rentDepositSpreadMonths === 0) {
                    rentDepositCashOutflow = inputs.rentDeposit;
                } else if (i < inputs.rentDepositSpreadMonths && inputs.rentDepositSpreadMonths > 0) {
                    rentDepositCashOutflow = inputs.rentDeposit / inputs.rentDepositSpreadMonths;
                }
                
                // 4. CAR PURCHASE: Split purchase (Netto/Brutto) and prep (Brutto)
                const purchaseWithVAT = inputs.purchaseWithVAT; // Checkbox state
                
                // LOGIC FIX: Car purchase factor (For Cash Outflow)
                // KU factor is 1.19 (MUST pay brutto)
                const carPurchaseFactor = isKU
                    ? (1 + UST_RATE)
                    : (isMargin || (isRegular && !purchaseWithVAT))
                        ? 1 // Margin / Regular(25a): Pay NETTO/§25a
                        : (1 + UST_RATE); // Regular + VAT: Pay BRUTTO
                
                const carPurchaseOutflow = carsBought * inputs.carPurchase * carPurchaseFactor; 
                
                // Prep: Always paid Brutto (1.19)
                const prepOutflow = carsBought * inputs.prepCosts * (1 + UST_RATE); 

                const carRelatedCashOutflow = carPurchaseOutflow + prepOutflow;

                // --- P&L REVENUE & VAT CALCULATION ---
                let salesRevenueGross = carsSold * inputs.avgSalePrice;
                let salesRevenuePnl;
                let ustDue = 0;
                let ustVorsteuer = 0;

                if (isRegular) {
                    salesRevenuePnl = salesRevenueGross / (1 + UST_RATE);
                    ustDue = salesRevenueGross - salesRevenuePnl;
                    
                    // Vorsteuer calculation for Regular (on all business expenses/purchases)
                    const rentVorsteuer = inputs.rentHasVAT ? rentCostMonthly * UST_RATE : 0; // FIX: Rent Vorsteuer only if rentHasVAT
                    const otherFixedVorsteuer = otherFixedCostMonthly * UST_RATE; 
                    const prepVorsteuer = (carsBought * inputs.prepCosts) * UST_RATE;
                    
                    // FIX: Apply Vorsteuer ONLY if purchase IS CHECKED
                    const carPurchaseVorsteuer = (isRegular && purchaseWithVAT) ? (carsBought * inputs.carPurchase) * UST_RATE : 0;
                    ustVorsteuer = rentVorsteuer + otherFixedVorsteuer + prepVorsteuer + carPurchaseVorsteuer;
                    
                } else if (isMargin) {
                    const margin = salesRevenueGross - (carsSold * inputs.carPurchase);
                    const ustOnMargin = margin > 0 ? margin * UST_SATZ / (100 + UST_SATZ) : 0;
                    ustDue = ustOnMargin;
                    salesRevenuePnl = salesRevenueGross - ustOnMargin;
                    
                    // Vorsteuer allowed only on general business expenses, NOT on car purchase/COGS
                    const rentVorsteuer = inputs.rentHasVAT ? rentCostMonthly * UST_RATE : 0;
                    const otherFixedVorsteuer = otherFixedCostMonthly * UST_RATE; 
                    const prepVorsteuer  = (carsBought * inputs.prepCosts) * UST_RATE;
                    ustVorsteuer = rentVorsteuer + otherFixedVorsteuer + prepVorsteuer;

                } else { // kleinunternehmer
                    salesRevenuePnl = salesRevenueGross;
                    ustDue = 0;
                    ustVorsteuer = 0;
                }

                // Final EBIT Calculation (FIX: Deposit removed from EBIT)
                const ebit = salesRevenuePnl - totalExpensesPnl; 

                // Update yearly totals BEFORE tax calculation logic
                yearlyEbit += ebit;
                yearly_gew_ertrag += ebit;

                // --- INVENTORY LOGIC (UPDATE) ---
                currentInventory = potentialInventory - carsSold;
                
                // --- TAXES & CASH FLOW ---
                
                let ustCashFlowMovement = ustDue - ustVorsteuer;
                let ustPaidThisMonth = 0;
                let ustOutflowFinal = 0;

                if (!isKU) { // Only calculate VAT flow if not KU
                    ust_period_due += ustCashFlowMovement;
                    if ((i + 1) % 3 === 0) {
                        ustPaidThisMonth = ust_period_due;
                        ustOutflowFinal = ustPaidThisMonth;
                        ust_period_due = 0;
                    }
                }
                
                let current_yearly_tax_data = { ...last_yearly_tax_data };
                let taxesPaidThisMonth = 0;

                if ( (i + 1) % 12 === 0 || i === NUM_MONTHS - 1) {
                    let taxable_profit = yearlyEbit;
                    current_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0, yearly_ebit: yearlyEbit };

                    if (taxable_profit > 0) {
                        // Health insurance is deductible from taxable income for ESt
                        let est_taxable_income = taxable_profit - (PERSONAL_COSTS_INSURANCE * 12); 
                        let est_tax = calculateESt(est_taxable_income).tax;
                        
                        let gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
                        let messbetrag = gewStTaxableBase * 0.035;
                        let gewSt = messbetrag * (HEBESATZ / 100); 
                        
                        let gewSt_credit = Math.min(est_tax, messbetrag * 3.8);
                        let est_final = Math.max(0, est_tax - gewSt_credit);

                        current_yearly_tax_data.Einkommensteuer = est_final;
                        current_yearly_tax_data.Gewerbesteuer = gewSt;
                        current_yearly_tax_data.total = est_final + gewSt;
                    }
                    // Reset yearly accumulators for the next year's calculation
                    yearlyEbit = 0;
                    yearly_gew_ertrag = 0;
                }
                
                // Авансові платежі за ESt/GwSt ідуть з минулого річного розрахунку
                if (last_yearly_tax_data.total > 0 && (i + 1) % 3 === 0) {
                    taxesPaidThisMonth = last_yearly_tax_data.total / 4;
                }
                
                // Total Cash Outflow (FIX: Deposit must be subtracted from 10k, not added to expenses)
                // Total outflow = OperatingFixed + Personal + Deposit + Car-related + USt + Taxes
                const totalCashOutflow = operatingFixedOutflow + housingCashOutflow + insuranceCashOutflow + rentDepositCashOutflow + carRelatedCashOutflow + ustOutflowFinal + taxesPaidThisMonth;
                
                // Cash Inflow: Only sales revenue (initial 10k already set as accumulatedBalance start)
                const netCashFlow = salesRevenueGross - totalCashOutflow;
                
                accumulatedCashBalance += netCashFlow;
                // FIX END
                

                data.push({
                    month: `Міс. ${i + 1}`,
                    carsSoldTarget: carsSoldTarget, // Sold target
                    carsSold: carsSold, // Actual sold (clamped)
                    carsBought: carsBought,
                    rentCostMonthly: rentCostMonthly, // NEW
                    otherFixedCostMonthly: otherFixedCostMonthly, // NEW
                    currentInventory: currentInventory,
                    ebit: ebit,
                    netCashFlow: netCashFlow,
                    housingCashOutflow: housingCashOutflow,
                    insuranceCashOutflow: insuranceCashOutflow,
                    ustPaidThisMonth: ustPaidThisMonth,
                    taxesPaidThisMonth: taxesPaidThisMonth,
                    accumulatedBalance: accumulatedCashBalance,
                    yearly_tax_data: current_yearly_tax_data,
                    inventoryWarning: inventoryWarning,
                    netProfitFinal: ebit - (current_yearly_tax_data.total / 12)
                });
                last_yearly_tax_data = current_yearly_tax_data;
            }
            return data;
        }

        function recalculatePlan() {
            processedData = processData();
            updateDataTable();
            updateCostPerCarDisplay();
            updatePurchase25aVisibility();
        }

        function updateCostPerCarDisplay() {
            const carPurchase = parseFloat(document.getElementById('carPurchase').value) || 0;
            const prepCosts = parseFloat(document.getElementById('prepCosts').value) || 0;
            const isKU = document.getElementById('ustRegime').value === 'kleinunternehmer';

            // FIX: Cost display should be BRUTTO for KU P&L
            const totalCost = (carPurchase + prepCosts) * (isKU ? (1 + UST_RATE) : 1);
            
            document.getElementById('costPerCarDisplay').textContent = formatCurrency(totalCost);
        }

        function updatePurchase25aVisibility() {
            const purchase25aLabel = document.getElementById('purchaseWithVAT_label');
            const ustRegime = document.getElementById('ustRegime').value;
            
            if (ustRegime === 'regular') {
                purchase25aLabel.style.display = 'flex';
            } else {
                purchase25aLabel.style.display = 'none';
            }
        }
        
        function updateDataTable() {
            const tableBody = document.querySelector('#dataTable tbody');
            
            let bodyHtml = '';
            for(let i = 0; i < NUM_MONTHS; i++) {
                const data = processedData[i];
                const yearlyData = data.yearly_tax_data;

                // Display annual tax totals in the final month of the year/period
                const gwst_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Gewerbesteuer) : '0.00 €';
                const est_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Einkommensteuer) : '0.00 €';
                
                // Display advance payment in the dedicated column
                const advance_val = data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(data.taxesPaidThisMonth) : '0.00 €';


                // Generate input fields for Sales and Purchase plans
                const salesInput = `<input type="number" id="salesPlan_${i}" value="${data.carsSoldTarget}" min="0" class="w-16 data-input">`;
                const purchaseInput = `<input type="number" id="purchasePlan_${i}" value="${data.carsBought}" min="0" class="w-16 data-input">`;
                const rentInput = `<input type="number" id="rentPlan_${i}" value="${data.rentCostMonthly}" min="0" class="w-20 data-input">`;
                const otherFixedInput = `<input type="number" id="otherFixedPlan_${i}" value="${data.otherFixedCostMonthly}" min="0" class="w-20 data-input">`;

                let inventoryClass = data.currentInventory < 0 ? 'warning-text' : ''; // Use 'let' instead of 'const'
                if (data.inventoryWarning) inventoryClass = 'warning-text'; // Highlight if sold more than in stock

                // Apply special warning to sales if they were clamped
                const salesCellClass = data.carsSoldTarget !== data.carsSold ? 'warning-text' : '';
                
                // Personal cash flow display (negative for outflow)
                const housingCfDisplay = formatCurrency(-data.housingCashOutflow);
                const insuranceCfDisplay = formatCurrency(-data.insuranceCashOutflow);


                let ustClass = 'text-gray-500';
                if (data.ustPaidThisMonth > 0) {
                    ustClass = 'text-red-700';
                } else if (data.ustPaidThisMonth < 0) {
                    ustClass = 'text-green-600 font-bold';
                }
                
                bodyHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2 ${salesCellClass}">${salesInput}</td>
                    <td class="px-3 py-2">${purchaseInput}</td>
                    <td class="px-3 py-2">${rentInput}</td>
                    <td class="px-3 py-2">${otherFixedInput}</td>
                    <td class="px-3 py-2 ${inventoryClass}">${data.currentInventory}</td>
                    <td class="px-3 py-2 ${data.ebit < 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(data.ebit)}</td>
                    <td class="px-3 py-2 ${data.netCashFlow < 0 ? 'text-red-500' : ''}">${formatCurrency(data.netCashFlow)}</td>
                    <td class="px-3 py-2 text-red-700 ${ustClass}">${formatCurrency(data.ustPaidThisMonth)}</td>
                    <td class="px-3 py-2 font-bold">${advance_val}</td>
                    <td class="px-3 py-2">${gwst_val}</td>
                    <td class="px-3 py-2">${est_val}</td>
                    <td class="px-3 py-2 ${data.netProfitFinal < 0 ? 'text-red-500' : 'text-green-800 font-bold'}">${formatCurrency(data.netProfitFinal)}</td>
                    <td class="px-3 py-2 ${data.accumulatedBalance < 0 ? 'warning-text' : 'font-bold'}">${formatCurrency(data.accumulatedBalance)}</td>
                </tr>`;
            }
            tableBody.innerHTML = bodyHtml;
            
            // Re-attach listeners to the new input fields in the table
            document.querySelectorAll('#dataTable input[type="number"]').forEach(input => {
                input.addEventListener('change', recalculatePlan);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial dummy data generation
            const initialSalesPlan = populateInitialSalesPlan();
            const initialPurchasePlan = generateInitialPurchasePlan(initialSalesPlan); 
            const initialRentPlan = populateInitialRentPlan();
            const initialOtherFixedPlan = populateInitialOtherFixedPlan();
            
            const tableBody = document.querySelector('#dataTable tbody');
            let initialHtml = '';
            initialSalesPlan.forEach((val, i) => {
                const initialPurchase = initialPurchasePlan[i]; 
                const initialRent = initialRentPlan[i];
                const initialOtherFixed = initialOtherFixedPlan[i];

                initialHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2"><input type="number" id="salesPlan_${i}" value="${val}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="purchasePlan_${i}" value="${initialPurchase}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="rentPlan_${i}" value="${initialRent}" min="0" class="w-20 data-input"></td> 
                    <td class="px-3 py-2"><input type="number" id="otherFixedPlan_${i}" value="${initialOtherFixed}" min="0" class="w-20 data-input"></td> 
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            });
            tableBody.innerHTML = initialHtml;

            // Attach listeners to main inputs (outside the dynamic table)
            document.querySelectorAll('#grant, #savings, #rentDeposit, #rentDepositSpreadMonths, #healthInsurance, #personalCosts, #avgSalePrice, #carPurchase, #prepCosts').forEach(input => { 
                input.addEventListener('change', recalculatePlan);
            });
            document.getElementById('ustRegime').addEventListener('change', recalculatePlan);
            document.getElementById('purchaseWithVAT').addEventListener('change', recalculatePlan);
            document.getElementById('rentHasVAT').addEventListener('change', recalculatePlan);
            document.getElementById('jobcenterCoversHousing').addEventListener('change', recalculatePlan);
            document.getElementById('jobcenterCoversInsurance').addEventListener('change', recalculatePlan);
            document.getElementById('calculate-button').addEventListener('click', recalculatePlan);

            // Initial calculation
            updatePurchase25aVisibility(); // Set initial visibility
            recalculatePlan();
        });
    </script>

</body>
</html>
