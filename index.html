<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прогноз Ліквідності: Автодилер (3 Роки)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .chart-container { position: relative; height: 350px; max-height: 400px; }
        .kpi-card { 
            background-color: white; 
            border-radius: 0.75rem; 
            padding: 1rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
            min-height: 100px; 
        }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.25rem; }
        .kpi-label { font-size: 0.875rem; color: #6b7280; }
        .input-group { background-color: #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        /* Custom styles for slider thumb to make it green */
        #month-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #10b981; cursor: pointer; border-radius: 50%; margin-top: -5px; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Прогноз Ліквідності: Автодилер (3 Роки)</h1>
            <p class="text-md text-gray-600 mt-2">Спрощений фінансовий план для ФОП (Einzelunternehmen) на 36 місяців.</p>
        </header>

        <main>
            <!-- Input Data Section -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-semibold mb-4 text-blue-700">1. Ключові вхідні дані</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Старт та Фінансування</h4>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Грант Jobcenter (€):</span>
                            <input type="number" id="grant" value="5000" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Власні кошти/Запозичення (€):</span>
                            <input type="number" id="savings" value="5000" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                         <label class="block"><span class="text-gray-700 text-sm">Особисті витрати/Житло (€/міс):</span>
                            <input type="number" id="personalCosts" value="1450" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Юніт-економіка (на 1 авто)</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Середня ціна продажу (БРУТТО, €):</span>
                            <input type="number" id="avgSalePrice" value="4800" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Ціна закупівлі (€):</span>
                            <input type="number" id="carPurchase" value="2300" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Витрати на підготовку (детейлінг, гарантія, €):</span>
                            <input type="number" id="prepCosts" value="850" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block"><span class="text-gray-700 text-sm font-semibold">Цільовий запас авто (для реінвестування):</span>
                            <input type="number" id="targetInventory" value="5" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2 bg-yellow-100">
                        </label>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Постійні та Податкові умови</h4>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Загальні постійні витрати бізнесу (€/міс):</span>
                            <input type="number" id="fixedMonthlyCosts" value="1300" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Прогнозована Мед. страховка/Пенсія (€/міс):</span>
                            <input type="number" id="healthInsurance" value="400" min="0" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                         <label class="block"><span class="text-gray-700 text-sm">Режим ПДВ (для розрахунку):</span>
                            <select id="ustRegime" class="mt-1 block w-full rounded-md shadow-sm p-2">
                                <option value="regular">Стандартний (Regelbesteuerung)</option>
                                <option value="margin">Differenzbesteuerung (§25a UStG)</option>
                                <option value="kleinunternehmer">Малий підприємець (§19 UStG)</option>
                            </select>
                        </label>
                    </div>

                    <div class="input-group col-span-full">
                        <h4 class="font-semibold text-gray-800 mb-3">4. План продажів (Місяці 1-36)</h4>
                        <div id="salesPlanInputs" class="grid grid-cols-6 md:grid-cols-12 gap-3 max-h-48 overflow-y-auto p-2">
                            <!-- JS will populate these -->
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button id="calculate-button" class="px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-md">Перерахувати прогноз</button>
                </div>
            </div>

            <!-- KPI Cards & Slider -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                    <div class="kpi-card border-l-4 border-blue-500">
                        <div id="kpi-sales" class="kpi-value">0</div>
                        <div class="kpi-label">Продано авто</div>
                    </div>
                    <div class="kpi-card border-l-4 border-green-500">
                        <div id="kpi-ebit" class="kpi-value">€0</div>
                        <div class="kpi-label">EBIT (Прибуток до податків)</div>
                    </div>
                    <div class="kpi-card border-l-4 border-red-500">
                        <div id="kpi-tax-burden" class="kpi-value">€0</div>
                        <div class="kpi-label">Податковий тягар (Річний)</div>
                    </div>
                    <div class="kpi-card border-l-4 border-purple-500">
                        <div id="kpi-balance" class="kpi-value">€0</div>
                        <div class="kpi-label">Накопичений баланс (Cash-Flow)</div>
                    </div>
                </div>
                <div>
                    <label for="month-slider" class="block mb-2 text-sm font-medium text-gray-900">Місяць для аналізу:</label>
                    <input id="month-slider" type="range" min="0" max="35" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gray-300">
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>Місяць 1</span>
                        <span id="slider-label-month" class="font-bold text-blue-600">Місяць 1</span>
                        <span>Місяць 36</span>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600">Ліквідність та Баланс</h3>
                    <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600">EBIT vs Постійні витрати</h3>
                    <div class="chart-container"><canvas id="ebitChart"></canvas></div>
                </div>
            </div>
            
            <!-- Detailed Data Table -->
            <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
                <h3 class="p-0 font-semibold text-lg text-blue-700">Детальний фінансовий звіт (36 місяців)</h3>
                <div class="p-0 border-t border-gray-200 mt-4">
                    <div class="overflow-x-auto">
                        <table id="dataTable" class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Міс.</th>
                                    <th scope="col" class="px-6 py-3">Продажі (шт)</th>
                                    <th scope="col" class="px-6 py-3">EBIT (Прибуток)</th>
                                    <th scope="col" class="px-6 py-3">Cash Flow (Чистий)</th>
                                    <th scope="col" class="px-6 py-3">USt (ПДВ, сплата)</th>
                                    <th scope="col" class="px-6 py-3">GwSt (Торг. податок)</th>
                                    <th scope="col" class="px-6 py-3">ESt (Податок на дохід)</th>
                                    <th scope="col" class="px-6 py-3">Баланс (Накопич.)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const NUM_MONTHS = 36;
        const FREIBETRAG_GEWST = 24500; 
        const GRUNDFREIBETRAG_EST = 12096; 
        const UST_RATE = 0.19;
        const UST_SATZ = 19;
        const HEBESATZ = 467; 
        
        let processedData;
        let chartInstances = {};

        function calculateESt(taxableIncome, gewStCredit = 0) {
            let tax = 0;
            if (taxableIncome < 0) return { tax: 0, finalTax: 0 };
            const Y = (taxableIncome - GRUNDFREIBETRAG_EST) / 10000;
            if (taxableIncome < GRUNDFREIBETRAG_EST) {
                tax = 0;
            } else if (taxableIncome <= 15999) {
                tax = (980.14 * Y + 1400) * Y;
            } else if (taxableIncome <= 62809) {
                tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
            } else if (taxableIncome <= 277825) {
                tax = 0.42 * taxableIncome - 9877.94;
            } else {
                tax = 0.45 * taxableIncome - 17316.5;
            }
            const finalTax = Math.max(0, tax - gewStCredit);
            return { tax: Math.max(0, tax), finalTax: finalTax };
        }

        function formatCurrency(value) {
            if (value === "TBD" || isNaN(value) || value === null) return "0.00 €";
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(value);
        }
        
        function getInputs() {
            const salesPlan = [];
            for (let i = 0; i < NUM_MONTHS; i++) {
                const inputElement = document.getElementById(`salesPlan_${i}`);
                if(inputElement) {
                   salesPlan.push(parseInt(inputElement.value) || 0);
                } else {
                   salesPlan.push(0);
                }
            }
            return {
                grant: parseFloat(document.getElementById('grant').value) || 0,
                savings: parseFloat(document.getElementById('savings').value) || 0,
                avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
                carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
                prepCosts: parseFloat(document.getElementById('prepCosts').value) || 0,
                fixedMonthlyCosts: parseFloat(document.getElementById('fixedMonthlyCosts').value) || 0,
                healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0,
                personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0, 
                targetInventory: parseFloat(document.getElementById('targetInventory').value) || 0, // NEW INPUT
                ustRegime: document.getElementById('ustRegime').value,
                salesPlan: salesPlan
            };
        }

        function processData() {
            const inputs = getInputs();
            const data = [];
            const purchaseHasVAT = inputs.ustRegime === 'regular';
            const lagMonths = 1; // Закупка відбувається на місяць раніше продажу

            let accumulatedCashBalance = inputs.grant + inputs.savings;
            let currentInventory = 0; // Tracks number of cars owned
            let yearlyEbit = 0;
            let yearly_gew_ertrag = 0;
            let last_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0 };
            let ust_period_due = 0;

            const purchasePlan = new Array(NUM_MONTHS).fill(0);
            for (let i = 0; i < NUM_MONTHS; i++) {
                // Determine cars needed next month (based on sales plan)
                const salesNextMonth = inputs.salesPlan[i + 1] || 0;
                
                // Cars to buy: Sales for next month + (Target Inventory - Current Inventory)
                let carsToBuy = 0;
                if (i === 0) {
                     // Initial purchase to reach target inventory and cover next month's sale
                     carsToBuy = inputs.salesPlan[i] + salesNextMonth + inputs.targetInventory;
                } else {
                     // Calculate inventory needed for sale next month + maintaining target
                     const neededToCoverNextSale = salesNextMonth;
                     const neededToReachTarget = Math.max(0, inputs.targetInventory - currentInventory);
                     carsToBuy = neededToCoverNextSale + neededToReachTarget;
                     
                     // Ensure we don't overbuy if cash is low (simplification: only buy what we can afford)
                     const costPerCar = inputs.carPurchase * (purchaseHasVAT ? 1 + UST_RATE : 1);
                     const maxCarsAffordable = Math.floor(accumulatedCashBalance / costPerCar);
                     carsToBuy = Math.min(carsToBuy, maxCarsAffordable);
                     
                     // Subtract what's currently in inventory that can cover sales
                     const netCarsNeeded = carsToBuy - currentInventory;
                     carsToBuy = Math.max(0, netCarsNeeded);
                }
                
                purchasePlan[i] = carsToBuy;
            }
            // Reset inventory for loop
            currentInventory = 0;
            
            for (let i = 0; i < NUM_MONTHS; i++) {
                const carsSold = inputs.salesPlan[i];
                const carsBought = purchasePlan[i];
                
                // Update Inventory
                // Start of month inventory = previous end of month inventory
                // Inventory update for loop consistency (this model uses direct purchase plan)
                currentInventory += carsBought;
                currentInventory -= carsSold;

                // 1. P&L Variables
                let salesRevenueGross = carsSold * inputs.avgSalePrice;
                let salesRevenuePnl;
                let ustDue = 0;
                let ustVorsteuer = 0;

                // Витрати (нетто)
                const totalFixedCostsPnl = inputs.fixedMonthlyCosts;

                // 2. VAT (USt) Logic - Affects P&L and Cash Flow
                if (inputs.ustRegime === 'regular') {
                    salesRevenuePnl = salesRevenueGross / (1 + UST_RATE); // Netto Revenue
                    ustDue = salesRevenueGross - salesRevenuePnl;         // Output VAT

                    // Input VAT (Vorsteuer): Fixkosten + PrepCosts + Car Purchase
                    ustVorsteuer = (totalFixedCostsPnl * UST_RATE) + 
                                   (carsSold * inputs.prepCosts * UST_RATE) + 
                                   (carsBought * inputs.carPurchase * UST_RATE);
                    
                } else if (inputs.ustRegime === 'margin') {
                    const margin = salesRevenueGross - (carsSold * inputs.carPurchase);
                    if (margin > 0) {
                        ustDue = margin * UST_SATZ / (100 + UST_SATZ);
                    }
                    salesRevenuePnl = salesRevenueGross - ustDue; // P&L = Gross - USt
                    ustVorsteuer = 0; // Vorsteuer not applicable on goods bought for margin scheme
                } else { // kleinunternehmer
                    salesRevenuePnl = salesRevenueGross; // P&L = Gross Revenue
                    ustDue = 0;
                    ustVorsteuer = 0;
                }

                // Variable Costs for P&L (Gross for KUR, Netto for others)
                let totalVariableCostsPnl = carsSold * inputs.carPurchase;
                if (inputs.ustRegime === 'kleinunternehmer') {
                    totalVariableCostsPnl += carsSold * inputs.prepCosts * (1 + UST_RATE);
                } else {
                     totalVariableCostsPnl += carsSold * inputs.prepCosts;
                }
                
                // Fixed Costs for P&L (Gross for KUR, Netto for others)
                let totalExpensesPnl;
                 if (inputs.ustRegime === 'kleinunternehmer') {
                    // P&L = Fixed Costs (Gross) + Variable Costs (Gross)
                    totalExpensesPnl = totalFixedCostsPnl * (1 + UST_RATE) + totalVariableCostsPnl;
                } else {
                    // P&L = Fixed Costs (Netto) + Variable Costs (Netto)
                    totalExpensesPnl = totalFixedCostsPnl + totalVariableCostsPnl;
                }
                
                const ebit = salesRevenuePnl - totalExpensesPnl;
                yearlyEbit += ebit;
                yearly_gew_ertrag += ebit; // Gewerbeertrag uses EBIT as base (simplified)

                // 3. USt Cash Flow (USt Paid This Month)
                let ustCashFlowMovement = ustDue - ustVorsteuer;
                let ustPaidThisMonth = 0;

                // Quarterly USt Payment Logic
                ust_period_due += ustCashFlowMovement;
                if ((i + 1) % 3 === 0) {
                    ustPaidThisMonth = ust_period_due;
                    ust_period_due = 0; // Reset period due after payment
                }
                
                // 4. Yearly Tax Calculation (ESt/GwSt)
                let current_yearly_tax_data = { ...last_yearly_tax_data };
                let taxesPaidThisMonth = 0;

                // Calculate GwSt/ESt at the end of the year (Month 12, 24, 36)
                if ( (i + 1) % 12 === 0 || i === NUM_MONTHS - 1) {
                    let taxable_profit = yearlyEbit;
                    current_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0, yearly_ebit: yearlyEbit };

                    if (taxable_profit > 0) {
                        // Einkommensteuer Calculation (simplified)
                        let est_taxable_income = taxable_profit - (inputs.healthInsurance * 12);
                        let est_tax = calculateESt(est_taxable_income).tax;
                        
                        // Gewerbesteuer Calculation (simplified)
                        let gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
                        let messbetrag = gewStTaxableBase * 0.035;
                        let gewSt = messbetrag * (HEBESATZ / 100); 
                        
                        // Gewerbesteuer Credit (§35 EStG)
                        let gewSt_credit = Math.min(est_tax, messbetrag * 3.8);
                        let est_final = Math.max(0, est_tax - gewSt_credit);

                        current_yearly_tax_data.Einkommensteuer = est_final;
                        current_yearly_tax_data.Gewerbesteuer = gewSt;
                        current_yearly_tax_data.total = est_final + gewSt;
                    }
                    yearlyEbit = 0;
                    yearly_gew_ertrag = 0;
                }
                
                // 5. ESt/GwSt Cash Flow (Quarterly Vorauszahlungen)
                // Payment occurs in Q1, Q2, Q3, Q4 based on LAST year's calculation
                if (last_yearly_tax_data.total > 0 && (i + 1) % 3 === 0) {
                    taxesPaidThisMonth = last_yearly_tax_data.total / 4;
                }

                // 6. Total Cash Flow
                const fixedCostsCashOutflow = inputs.fixedMonthlyCosts * (purchaseHasVAT ? 1 + UST_RATE : 1);
                const prepCostsCashOutflow = carsSold * inputs.prepCosts * (purchaseHasVAT ? 1 + UST_RATE : 1);
                const carPurchaseCashOutflow = carsBought * inputs.carPurchase * (purchaseHasVAT ? 1 + UST_RATE : 1);
                const personalCashOutflow = inputs.healthInsurance + inputs.personalCosts; 
                
                const salesCashInflow = salesRevenueGross;
                
                const totalCashOutflow = fixedCostsCashOutflow + prepCostsCashOutflow + carPurchaseCashOutflow + ustPaidThisMonth + taxesPaidThisMonth + personalCashOutflow;
                const netCashFlow = (salesCashInflow + (i === 0 ? inputs.grant + inputs.savings : 0)) - totalCashOutflow;
                
                accumulatedCashBalance += netCashFlow;

                data.push({
                    month: `Міс. ${i + 1}`,
                    carsSold: carsSold,
                    carsBought: carsBought, // Added for clearer debugging
                    currentInventory: currentInventory, // Added for clearer debugging
                    ebit: ebit,
                    netCashFlow: netCashFlow,
                    ustPaidThisMonth: ustPaidThisMonth,
                    taxesPaidThisMonth: taxesPaidThisMonth,
                    accumulatedBalance: accumulatedCashBalance,
                    yearly_tax_data: current_yearly_tax_data,
                });
                last_yearly_tax_data = current_yearly_tax_data;
            }
            return data;
        }

        function recalculatePlan() {
            processedData = processData();
            
            // Re-render charts
            if (chartInstances.cashFlowChart) chartInstances.cashFlowChart.destroy();
            if (chartInstances.ebitChart) chartInstances.ebitChart.destroy();
            
            createCharts();
            updateDashboard(0);
            updateDataTable();
            document.getElementById('month-slider').max = NUM_MONTHS - 1;
            document.getElementById('month-slider').value = 0;
            document.getElementById('slider-label-month').textContent = `Місяць 1`;
        }

        function createCharts() {
            const months = Array.from({ length: NUM_MONTHS }, (_, i) => `М. ${i + 1}`);
            const inputs = getInputs();

            // 1. Cash Flow Chart (Accumulated Balance)
            chartInstances.cashFlowChart = new Chart(document.getElementById('cashFlowChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Накопичений Баланс (€)',
                        data: processedData.map(d => d.accumulatedBalance),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `Баланс: ${formatCurrency(c.raw)}` } } },
                    scales: { y: { ticks: { callback: formatCurrency } } }
                }
            });
            
            // 2. EBIT Chart (EBIT vs Fixed Costs Line)
             // Get inputs for fixed costs line
            const fixedCostsLine = Array(NUM_MONTHS).fill(inputs.fixedMonthlyCosts);

            chartInstances.ebitChart = new Chart(document.getElementById('ebitChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'EBIT (Прибуток до податків) (€)',
                            data: processedData.map(d => d.ebit),
                            backgroundColor: processedData.map(d => d.ebit >= 0 ? '#3b82f6' : '#ef4444'),
                        },
                        {
                             label: 'Фіксовані витрати (€/міс)',
                             data: fixedCostsLine.map(fc => -fc), // Відображаємо лінію фіксованих витрат як негативну
                             type: 'line',
                             borderColor: '#f97316',
                             borderWidth: 2,
                             pointRadius: 0,
                             tension: 0.1,
                             yAxisID: 'y1'
                        }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, ticks: { callback: formatCurrency } } }
                }
            });
        }

        function updateDashboard(monthIndex) {
            const data = processedData[monthIndex];
            
            document.getElementById('slider-label-month').textContent = `Місяць ${monthIndex + 1}`;
            
            const totalTax = data.taxesPaidThisMonth + data.ustPaidThisMonth;

            document.getElementById('kpi-sales').textContent = data.carsSold;
            document.getElementById('kpi-ebit').textContent = formatCurrency(data.ebit);
            document.getElementById('kpi-tax-burden').textContent = formatCurrency(totalTax);
            document.getElementById('kpi-balance').textContent = formatCurrency(data.accumulatedBalance);
        }

        function updateDataTable() {
            const tableBody = document.querySelector('#dataTable tbody');
            
            let bodyHtml = '';
            for(let i = 0; i < NUM_MONTHS; i++) {
                const data = processedData[i];
                
                // Get annual tax values for the year just ended or current month (for Q4)
                const yearlyData = data.yearly_tax_data;

                // Display only the final calculated annual amount or quarterly payment
                const gwst_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Gewerbesteuer) : 
                                 (data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(data.taxesPaidThisMonth) : '0.00 €');
                
                const est_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Einkommensteuer) :
                                (data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(data.taxesPaidThisMonth) : '0.00 €');

                bodyHtml += `<tr class="bg-white border-b">
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-6 py-4">${data.carsSold}</td>
                    <td class="px-6 py-4 ${data.ebit < 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(data.ebit)}</td>
                    <td class="px-6 py-4 ${data.netCashFlow < 0 ? 'text-red-500' : ''}">${formatCurrency(data.netCashFlow)}</td>
                    <td class="px-6 py-4">${formatCurrency(data.ustPaidThisMonth)}</td>
                    <td class="px-6 py-4">${gwst_val}</td>
                    <td class="px-6 py-4">${est_val}</td>
                    <td class="px-6 py-4 ${data.accumulatedBalance < 0 ? 'text-red-500' : 'font-semibold'}">${formatCurrency(data.accumulatedBalance)}</td>
                </tr>`;
            }
            tableBody.innerHTML = bodyHtml;
        }

        function populateSalesInputs() {
            const container = document.getElementById('salesPlanInputs');
            container.innerHTML = '';
            for (let i = 0; i < NUM_MONTHS; i++) {
                const defaultValue = i < 6 ? 2 : (i < 12 ? 3 : 4); // Default plan: 2 for M1-M6, 3 for M7-M12, 4+ for M13+
                const month = i + 1;
                const label = `Міс. ${month}`;
                const inputHtml = `
                    <label class="block col-span-1">
                        <span class="text-gray-700 text-xs">${label}</span>
                        <input type="number" id="salesPlan_${i}" value="${defaultValue}" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1 text-sm">
                    </label>
                `;
                container.innerHTML += inputHtml;
            }
             // Add listeners after elements are created
            document.querySelectorAll('#salesPlanInputs input[type="number"]').forEach(input => {
                input.addEventListener('change', recalculatePlan);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Populate inputs first
            populateSalesInputs();
            
            // Attach listeners to main inputs
            document.querySelectorAll('#grant, #savings, #avgSalePrice, #carPurchase, #prepCosts, #fixedMonthlyCosts, #healthInsurance, #personalCosts, #ustRegime, #targetInventory').forEach(input => {
                input.addEventListener('change', recalculatePlan);
            });
            document.getElementById('calculate-button').addEventListener('click', recalculatePlan);

            document.getElementById('month-slider').addEventListener('input', (e) => {
                updateDashboard(parseInt(e.target.value));
            });

            // Initial calculation
            recalculatePlan();
        });
    </script>

</body>
</html>
