<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивний Планувальник Ліквідності (36 Місяців)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .input-group { background-color: #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .data-input { 
            border: 1px solid #d1d5db; 
            padding: 0.25rem; 
            font-size: 0.875rem; 
            border-radius: 0.25rem;
            text-align: center;
        }
        .data-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
        }
        .warning-text {
            color: #ef4444; /* Tailwind red-500 */
            font-weight: 600;
        }
        .text-purple-700 {
            color: #7c3aed; /* Tailwind purple-600 */
        }
        .text-blue-700 {
            color: #1d4ed8; /* Tailwind blue-700 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900" data-i18n="title">Інтерактивна Таблиця Ліквідності (3 Роки)</h1>
            <p class="text-md text-gray-600 mt-2" data-i18n="subtitle">Ви повністю контролюєте **Продажі**, **Закупівлі** та **Фіксовані Витрати**.</p>
        </header>

        <main>
            <div class="flex justify-center mb-6 space-x-4">
                <button class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600 transition-colors" onclick="setLanguage('uk')">Українська</button>
                <button class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-gray-500 hover:bg-gray-600 transition-colors" onclick="setLanguage('de')">Deutsch</button>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-semibold mb-4 text-blue-700" data-i18n="section_1_title">1. Ключові вхідні дані</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3" data-i18n="group_funding">Фінансування та Податкові фактори</h4>
                        
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold" data-i18n="input_grant">Стартовий Капітал (Грант, €):</span>
                            <input type="number" id="grant" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold" data-i18n="input_savings">Власні Кошти/Заощадження (€):</span>
                            <input type="number" id="savings" value="7500" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        
                        <label class="block mb-2 mt-4"><span class="text-gray-700 text-sm font-bold" data-i18n="input_deposit">Застава оренди (Депозит, €):</span>
                            <input type="number" id="rentDeposit" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold" data-i18n="input_deposit_spread">Розподіл депозиту (міс., 0=у М1):</span>
                            <input type="number" id="rentDepositSpreadMonths" value="0" class="mt-1 block w-full rounded-md shadow-sm p-2" min="0" max="12">
                        </label>


                        <input type="hidden" id="healthInsurance" value="400"> 
                        <input type="hidden" id="personalCosts" value="1450">
                        
                        <p class="text-sm mt-4 p-2 bg-blue-100 rounded-md font-semibold" data-i18n="business_type">
                            Тип діяльності: Малий приватний підприємець (Einzelunternehmen)
                        </p>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3" data-i18n="group_unit_econ">Юніт-економіка (на 1 авто)</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input_sale_price">Середня ціна продажу (БРУТТО, €):</span>
                            <input type="number" id="avgSalePrice" value="4500" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input_car_purchase">Ціна закупівлі (БРУТТО, €):</span>
                            <input type="number" id="carPurchase" value="2300" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input_prep_costs">Витрати на підготовку (€):</span>
                            <input type="number" id="prepCosts" value="850" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <p class="text-sm mt-4 p-2 bg-yellow-100 rounded-md" data-i18n="cost_per_car">Вартість 1 авто (закупка + підготовка) = <span id="costPerCarDisplay" class="font-bold"></span></p>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3" data-i18n="group_taxes_jc">Податковий Режим та Jobcenter</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input_vat_regime">Режим ПДВ:</span>
                            <select id="ustRegime" class="mt-1 block w-full rounded-md shadow-sm p-2">
                                <option value="regular" data-i18n="option_regular">Стандартний (Regelbesteuerung)</option>
                                <option value="margin" data-i18n="option_margin">Differenzbesteuerung (§25a UStG)</option>
                                <option value="kleinunternehmer" data-i18n="option_ku">Малий підприємець (§19 UStG)</option>
                            </select>
                        </label>
                        
                        <div class="mt-4 p-2 bg-pink-100 rounded-md">
                            <h5 class="font-semibold text-sm mb-1" data-i18n="jc_coverage_title">Покриття Jobcenter (Перші 6 міс.)</h5>
                            <label class="flex items-center space-x-2"><input type="checkbox" id="jobcenterCoversHousing" class="rounded">
                                <span class="text-gray-700 text-sm" data-i18n="jc_covers_housing">Jobcenter покриває житло</span>
                            </label>
                            <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="jobcenterCoversInsurance" class="rounded">
                                <span class="text-gray-700 text-sm" data-i18n="jc_covers_insurance">Jobcenter покриває мед/соц</span>
                            </label>
                        </div>
                        
                        <label id="purchaseWithVAT_label" class="flex items-center space-x-2 mt-4">
                            <input type="checkbox" id="purchaseWithVAT" checked class="rounded">
                            <span class="text-gray-700 text-sm" data-i18n="input_purchase_vat">Закупівля авто з ПДВ (є Vorsteuer)</span>
                        </label>
                        <label id="rentHasVAT_label" class="flex items-center space-x-2 mt-1">
                            <input type="checkbox" id="rentHasVAT" class="rounded">
                            <span class="text-gray-700 text-sm" data-i18n="input_rent_vat">Оренда площі з ПДВ</span>
                        </label>
                        

                        <p class="text-xs text-red-500 mt-4" data-i18n="taxes_note">Усі податки (GwSt, ESt) розраховуються на річній основі та сплачуються щоквартальними авансами.</p>
                        <button id="calculate-button" class="mt-4 w-full px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-md" data-i18n="calculate_button">Перерахувати</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
                <h3 class="p-0 font-semibold text-lg text-blue-700 mb-4" data-i18n="section_2_title">Детальний Фінансовий Звіт (36 місяців)</h3>
                <p class="text-sm text-gray-600 mb-4" data-i18n="table_note">Ви можете редагувати **Продажі**, **Куплено** та **Місячні Витрати** безпосередньо в таблиці.</p>
                <div class="overflow-x-auto">
                    <table id="dataTable" class="min-w-full text-sm text-left text-gray-500 border-collapse">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th scope="col" class="px-3 py-2" data-i18n="col_month">Міс.</th>
                                <th scope="col" class="px-3 py-2 w-20" data-i18n="col_sales">Продажі (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20" data-i18n="col_purchase">Куплено (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20" data-i18n="col_rent">Оренда площі (бізнес) €</th>
                                <th scope="col" class="px-3 py-2 w-20" data-i18n="col_other_fixed">Інші Пост. (€)</th>
                                <th scope="col" class="px-3 py-2" data-i18n="col_inventory">Запас</th>
                                <th scope="col" class="px-3 py-2 text-green-700" data-i18n="col_ebit">EBIT (Прибуток)</th>
                                <th scope="col" class="px-3 py-2 text-blue-700" data-i18n="col_cf_net">Cash Flow (Чистий)</th>
                                <th scope="col" class="px-3 py-2 text-red-700" data-i18n="col_ust">USt (Сплата)</th>
                                <th scope="col" class="px-3 py-2 font-bold" data-i18n="col_tax_advance">Аванс ESt+GwSt</th>
                                <th scope="col" class="px-3 py-2" data-i18n="col_gwst_annual">GwSt (Річний)</th>
                                <th scope="col" class="px-3 py-2" data-i18n="col_est_annual">ESt (Річний)</th>
                                <th scope="col" class="px-3 py-2 text-green-800 font-bold" data-i18n="col_net_profit_final">Чистий Прибуток (Фінал)</th>
                                <th scope="col" class="px-3 py-2 font-bold" data-i18n="col_balance_final">Залишок (Подуш. безп.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const NUM_MONTHS = 36;
        const FREIBETRAG_GEWST = 24500; 
        const GRUNDFREIBETRAG_EST = 12096; 
        const UST_RATE = 0.19;
        const UST_SATZ = 19;
        const HEBESATZ = 467; 
        
        let processedData;
        
        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            uk: {
                "title": "Інтерактивна Таблиця Ліквідності (3 Роки)",
                "subtitle": "Ви повністю контролюєте **Продажі**, **Закупівлі** та **Фіксовані Витрати**.",
                "section_1_title": "1. Ключові вхідні дані",
                "group_funding": "Фінансування та Податкові фактори",
                "input_grant": "Стартовий Капітал (Грант, €):",
                "input_savings": "Власні Кошти/Заощадження (€):",
                "input_deposit": "Застава оренди (Депозит, €):",
                "input_deposit_spread": "Розподіл депозиту (міс., 0=у М1):",
                "business_type": "Тип діяльності: Малий приватний підприємець (Einzelunternehmen)",
                "group_unit_econ": "Юніт-економіка (на 1 авто)",
                "input_sale_price": "Середня ціна продажу (БРУТТО, €):",
                "input_car_purchase": "Ціна закупівлі (БРУТТО, €):",
                "input_prep_costs": "Витрати на підготовку (€):",
                "cost_per_car": "Вартість 1 авто (закупка + підготовка) =",
                "group_taxes_jc": "Податковий Режим та Jobcenter",
                "input_vat_regime": "Режим ПДВ:",
                "option_regular": "Стандартний (Regelbesteuerung)",
                "option_margin": "Differenzbesteuerung (§25a UStG)",
                "option_ku": "Малий підприємець (§19 UStG)",
                "jc_coverage_title": "Покриття Jobcenter (Перші 6 міс.)",
                "jc_covers_housing": "Jobcenter покриває житло",
                "jc_covers_insurance": "Jobcenter покриває мед/соц",
                "input_purchase_vat": "Закупівля авто з ПДВ (є Vorsteuer)",
                "input_rent_vat": "Оренда площі з ПДВ",
                "taxes_note": "Усі податки (GwSt, ESt) розраховуються на річній основі та сплачуються щоквартальними авансами.",
                "calculate_button": "Перерахувати",
                "section_2_title": "Детальний Фінансовий Звіт (36 місяців)",
                "table_note": "Ви можете редагувати **Продажі**, **Куплено** та **Місячні Витрати** безпосередньо в таблиці.",
                "col_month": "Міс.",
                "col_sales": "Продажі (шт)",
                "col_purchase": "Куплено (шт)",
                "col_rent": "Оренда площі (бізнес) €",
                "col_other_fixed": "Інші Пост. (€)",
                "col_inventory": "Запас",
                "col_ebit": "EBIT (Прибуток)",
                "col_cf_net": "Cash Flow (Чистий)",
                "col_ust": "USt (Сплата)",
                "col_tax_advance": "Аванс ESt+GwSt",
                "col_gwst_annual": "GwSt (Річний)",
                "col_est_annual": "ESt (Річний)",
                "col_net_profit_final": "Чистий Прибуток (Фінал)",
                "col_balance_final": "Залишок (Подуш. безп.)",
            },
            de: {
                "title": "Interaktive Liquiditätsplanung (36 Monate)",
                "subtitle": "Sie kontrollieren **Verkäufe**, **Einkäufe** und **Fixkosten** vollständig.",
                "section_1_title": "1. Schlüssel-Eingabedaten",
                "group_funding": "Finanzierung und Steuerfaktoren",
                "input_grant": "Startkapital (Zuschuss, €):",
                "input_savings": "Eigenmittel/Ersparnisse (€):",
                "input_deposit": "Mietkaution (Depot, €):",
                "input_deposit_spread": "Verteilung Kaution (Monate, 0=in M1):",
                "business_type": "Geschäftsart: Kleingewerbetreibender (Einzelunternehmen)",
                "group_unit_econ": "Unit Economics (pro Auto)",
                "input_sale_price": "Durchschnittlicher Verkaufspreis (BRUTTO, €):",
                "input_car_purchase": "Einkaufspreis (BRUTTO, €):",
                "input_prep_costs": "Vorbereitungskosten (€):",
                "cost_per_car": "Kosten pro Auto (Einkauf + Vorbereitung) =",
                "group_taxes_jc": "Steuerregime und Jobcenter",
                "input_vat_regime": "USt-Regime:",
                "option_regular": "Standard (Regelbesteuerung)",
                "option_margin": "Differenzbesteuerung (§25a UStG)",
                "option_ku": "Kleinunternehmer (§19 UStG)",
                "jc_coverage_title": "Jobcenter-Abdeckung (Erste 6 Monate)",
                "jc_covers_housing": "Jobcenter übernimmt Wohnkosten",
                "jc_covers_insurance": "Jobcenter übernimmt Kranken-/Sozialversicherung",
                "input_purchase_vat": "Einkauf Auto mit USt (Vorsteuerabzug)",
                "input_rent_vat": "Miete der Fläche mit USt",
                "taxes_note": "Alle Steuern (GwSt, ESt) werden auf Jahresbasis berechnet und vierteljährlich im Voraus bezahlt.",
                "calculate_button": "Berechnen",
                "section_2_title": "Detaillierter Finanzbericht (36 Monate)",
                "table_note": "Sie können **Verkäufe**, **Einkäufe** und **Monatsausgaben** direkt in der Tabelle bearbeiten.",
                "col_month": "Monat",
                "col_sales": "Verkäufe (Stk)",
                "col_purchase": "Einkäufe (Stk)",
                "col_rent": "Miete Fläche (Business) €",
                "col_other_fixed": "Andere Fixkosten (€)",
                "col_inventory": "Bestand",
                "col_ebit": "EBIT (Gewinn)",
                "col_cf_net": "Cash Flow (Netto)",
                "col_ust": "USt (Zahlung)",
                "col_tax_advance": "Vorauszahlung ESt+GwSt",
                "col_gwst_annual": "GwSt (Jährlich)",
                "col_est_annual": "ESt (Jährlich)",
                "col_net_profit_final": "Nettogewinn (Final)",
                "col_balance_final": "Guthaben (Puffer)",
            }
        };

        function calculateESt(taxableIncome, gewStCredit = 0) {
            let tax = 0;
            if (taxableIncome < 0) return { tax: 0, finalTax: 0 };
            const Y = (taxableIncome - GRUNDFREIBETRAG_EST) / 10000;
            if (taxableIncome < GRUNDFREIBETRAG_EST) {
                tax = 0;
            } else if (taxableIncome <= 15999) {
                tax = (980.14 * Y + 1400) * Y;
            } else if (taxableIncome <= 62809) {
                tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
            } else if (taxableIncome <= 277825) {
                tax = 0.42 * taxableIncome - 9877.94;
            } else {
                tax = 0.45 * taxableIncome - 17316.5;
            }
            const finalTax = Math.max(0, tax - gewStCredit);
            return { tax: Math.max(0, tax), finalTax: finalTax };
        }

        function formatCurrency(value) {
            if (value === "TBD" || isNaN(value) || value === null) return "0.00 €";
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(value);
        }
        
        function setLanguage(lang) {
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
                    const translation = TRANSLATIONS[lang][key];
                    
                    // Handle elements where we need to preserve child elements (like spans)
                    const costPerCarElement = document.getElementById('costPerCarDisplay');
                    if (element.id === costPerCarElement?.parentElement?.id) {
                         // Set text content for the parent, but don't overwrite the span
                        element.firstChild.textContent = translation + ' ';
                    } else {
                        element.innerHTML = translation;
                    }
                }
            });
        }


        function getInputs() {
            const salesPlan = [];
            const purchasePlan = [];
            const rentPlan = []; 
            const otherFixedPlan = []; 
            
            // Collect data directly from the dynamic table inputs
            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesInput = document.getElementById(`salesPlan_${i}`);
                const purchaseInput = document.getElementById(`purchasePlan_${i}`);
                const rentInput = document.getElementById(`rentPlan_${i}`); 
                const otherFixedInput = document.getElementById(`otherFixedPlan_${i}`); 

                salesPlan.push(parseInt(salesInput?.value) || 0);
                purchasePlan.push(parseInt(purchaseInput?.value) || 0);
                rentPlan.push(parseFloat(rentInput?.value) || 0);
                otherFixedPlan.push(parseFloat(otherFixedInput?.value) || 0);
            }
            
            return {
                grant: parseFloat(document.getElementById('grant').value) || 0, 
                savings: parseFloat(document.getElementById('savings').value) || 0, 
                avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
                carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
                prepCosts: parseFloat(document.getElementById('prepCosts').value) || 0,
                healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0, 
                personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0, 
                ustRegime: document.getElementById('ustRegime').value,
                purchaseWithVAT: document.getElementById('purchaseWithVAT')?.checked ?? true, 
                rentHasVAT: document.getElementById('rentHasVAT')?.checked ?? false,
                jobcenterCoversHousing: document.getElementById('jobcenterCoversHousing')?.checked ?? false, 
                jobcenterCoversInsurance: document.getElementById('jobcenterCoversInsurance')?.checked ?? false, 
                salesPlan: salesPlan,
                purchasePlan: purchasePlan,
                rentDeposit: parseFloat(document.getElementById('rentDeposit').value) || 0, 
                rentDepositSpreadMonths: parseInt(document.getElementById('rentDepositSpreadMonths').value) || 0,
                rentPlan: rentPlan, 
                otherFixedPlan: otherFixedPlan 
            };
        }
        
        function populateInitialSalesPlan() {
             const initialSalesPlan = [];
             for (let i = 0; i < NUM_MONTHS; i++) {
                 if (i < 2) {
                     initialSalesPlan.push(2); 
                 } else if (i < 4) {
                     initialSalesPlan.push(3); 
                 } else if (i < 6) {
                     initialSalesPlan.push(4); 
                 } else if (i < 9) {
                     initialSalesPlan.push(5); 
                 } else if (i < 12) {
                     initialSalesPlan.push(6); 
                 } else if (i < 24) {
                     initialSalesPlan.push(8); 
                 } else {
                     initialSalesPlan.push(10);
                 }
            }
            return initialSalesPlan;
        }

        function populateInitialRentPlan() {
            return Array(NUM_MONTHS).fill(560);
        }

        function populateInitialOtherFixedPlan() {
            return Array(NUM_MONTHS).fill(740);
        }

        function generateInitialPurchasePlan(salesPlan) {
            const initialPurchasePlan = [];
            
            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesTarget = salesPlan[i];
                let carsToBuy = 0;
                
                if (i === 0) {
                    carsToBuy = 2; 
                } else {
                    carsToBuy = salesTarget;
                }
                
                initialPurchasePlan.push(carsToBuy);
            }
            
            return initialPurchasePlan;
        }

        // ########## START: ВИПРАВЛЕНА ФУНКЦІЯ РОЗРАХУНКІВ ##########
        function processData() {
            const inputs = getInputs();
            const data = [];
            
            const isRegular = inputs.ustRegime === 'regular';
            const isMargin  = inputs.ustRegime === 'margin';
            const isKU      = inputs.ustRegime === 'kleinunternehmer';

            // --- ЗМІНА ЛОГІКИ: Розраховуємо нетто-ціну закупівлі з брутто ---
            const carPurchaseNet = inputs.carPurchase / (1 + UST_RATE);
            const COST_PER_CAR = carPurchaseNet + inputs.prepCosts; // Собівартість для P&L = нетто закупівля + нетто підготовка

            let accumulatedCashBalance = inputs.grant + inputs.savings; 
            let currentInventory = 0;
            let yearlyEbit = 0;
            let yearly_gew_ertrag = 0;
            let last_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0 };
            let ust_period_due = 0;
            const PERSONAL_COSTS_HOUSING = inputs.personalCosts;
            const PERSONAL_COSTS_INSURANCE = inputs.healthInsurance;

            for (let i = 0; i < NUM_MONTHS; i++) {
                const carsSoldTarget = inputs.salesPlan[i];
                const carsBought = inputs.purchasePlan[i];
                
                const rentCostMonthly = inputs.rentPlan[i]; 
                const otherFixedCostMonthly = inputs.otherFixedPlan[i]; 
                
                const totalFixedCostsPnlNetto = rentCostMonthly + otherFixedCostMonthly;
                
                const potentialInventory = currentInventory + carsBought;
                const carsSold = Math.min(carsSoldTarget, potentialInventory);
                const inventoryWarning = carsSoldTarget > potentialInventory;

                const expensePnlFactor = isKU ? (1 + UST_RATE) : 1;
                const cogsPnl = carsSold * COST_PER_CAR * expensePnlFactor;
                let totalExpensesPnl = totalFixedCostsPnlNetto * expensePnlFactor + cogsPnl;
                
                const inJobcenterWindow = i < 6;
                let housingCashOutflow = PERSONAL_COSTS_HOUSING; 
                let insuranceCashOutflow = PERSONAL_COSTS_INSURANCE; 

                if (inJobcenterWindow && inputs.jobcenterCoversHousing) housingCashOutflow = 0;
                if (inJobcenterWindow && inputs.jobcenterCoversInsurance) insuranceCashOutflow = 0;
                
                const rentVatFactor = inputs.rentHasVAT ? (1 + UST_RATE) : 1;
                const operatingRentOutflow = rentCostMonthly * rentVatFactor;
                const operatingOtherFixedOutflow = otherFixedCostMonthly * (1 + UST_RATE);
                
                const operatingFixedOutflow = operatingRentOutflow + operatingOtherFixedOutflow;
                
                let rentDepositCashOutflow = 0;
                if (i === 0 && inputs.rentDepositSpreadMonths === 0) {
                    rentDepositCashOutflow = inputs.rentDeposit;
                } else if (i < inputs.rentDepositSpreadMonths && inputs.rentDepositSpreadMonths > 0) {
                    rentDepositCashOutflow = inputs.rentDeposit / inputs.rentDepositSpreadMonths;
                }
                
                const purchaseWithVAT = inputs.purchaseWithVAT;
                
                // --- ЗМІНА ЛОГІКИ: Грошовий відтік на закупівлю тепер = брутто-ціні з поля вводу ---
                const carPurchaseOutflow = carsBought * inputs.carPurchase;
                const prepOutflow = carsBought * inputs.prepCosts * (1 + UST_RATE); 
                const carRelatedCashOutflow = carPurchaseOutflow + prepOutflow;

                let salesRevenueGross = carsSold * inputs.avgSalePrice;
                let salesRevenuePnl;
                let ustDue = 0;
                let ustVorsteuer = 0;

                if (isRegular) {
                    salesRevenuePnl = salesRevenueGross / (1 + UST_RATE);
                    ustDue = salesRevenueGross - salesRevenuePnl;
                    
                    const rentVorsteuer = inputs.rentHasVAT ? rentCostMonthly * UST_RATE : 0;
                    const otherFixedVorsteuer = otherFixedCostMonthly * UST_RATE; 
                    const prepVorsteuer = (carsBought * inputs.prepCosts) * UST_RATE;

                    // --- ЗМІНА ЛОГІКИ: Vorsteuer розраховується з брутто-ціни ---
                    const carPurchaseVorsteuer = (isRegular && purchaseWithVAT) ? (carsBought * carPurchaseNet * UST_RATE) : 0;
                    
                    ustVorsteuer = rentVorsteuer + otherFixedVorsteuer + prepVorsteuer + carPurchaseVorsteuer;
                    
                } else if (isMargin) {
                    // --- ЗМІНА ЛОГІКИ: в режимі Margin закупівля для розрахунку маржі береться нетто ---
                    const margin = salesRevenueGross - (carsSold * carPurchaseNet);
                    const ustOnMargin = margin > 0 ? margin * UST_SATZ / (100 + UST_SATZ) : 0;
                    ustDue = ustOnMargin;
                    salesRevenuePnl = salesRevenueGross - ustOnMargin;
                    
                    const rentVorsteuer = inputs.rentHasVAT ? rentCostMonthly * UST_RATE : 0;
                    const otherFixedVorsteuer = otherFixedCostMonthly * UST_RATE; 
                    const prepVorsteuer  = (carsBought * inputs.prepCosts) * UST_RATE;
                    ustVorsteuer = rentVorsteuer + otherFixedVorsteuer + prepVorsteuer;

                } else { // kleinunternehmer
                    salesRevenuePnl = salesRevenueGross;
                    ustDue = 0;
                    ustVorsteuer = 0;
                }

                const ebit = salesRevenuePnl - totalExpensesPnl; 

                yearlyEbit += ebit;
                yearly_gew_ertrag += ebit;

                currentInventory = potentialInventory - carsSold;
                
                let ustCashFlowMovement = ustDue - ustVorsteuer;
                let ustPaidThisMonth = 0;
                let ustOutflowFinal = 0;

                if (!isKU) {
                    ust_period_due += ustCashFlowMovement;
                    if ((i + 1) % 3 === 0) {
                        ustPaidThisMonth = ust_period_due;
                        ustOutflowFinal = ustPaidThisMonth;
                        ust_period_due = 0;
                    }
                }
                
                let current_yearly_tax_data = { ...last_yearly_tax_data };
                let taxesPaidThisMonth = 0;

                if ( (i + 1) % 12 === 0 || i === NUM_MONTHS - 1) {
                    let taxable_profit = yearlyEbit;
                    current_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0, yearly_ebit: yearlyEbit };

                    if (taxable_profit > 0) {
                        let est_taxable_income = taxable_profit - (PERSONAL_COSTS_INSURANCE * 12); 
                        let est_tax = calculateESt(est_taxable_income).tax;
                        
                        let gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
                        let messbetrag = gewStTaxableBase * 0.035;
                        let gewSt = messbetrag * (HEBESATZ / 100); 
                        
                        let gewSt_credit = Math.min(est_tax, messbetrag * 3.8);
                        let est_final = Math.max(0, est_tax - gewSt_credit);

                        current_yearly_tax_data.Einkommensteuer = est_final;
                        current_yearly_tax_data.Gewerbesteuer = gewSt;
                        current_yearly_tax_data.total = est_final + gewSt;
                    }
                    yearlyEbit = 0;
                    yearly_gew_ertrag = 0;
                }
                
                if (last_yearly_tax_data.total > 0 && (i + 1) % 3 === 0) {
                    taxesPaidThisMonth = last_yearly_tax_data.total / 4;
                }
                
                const totalCashOutflow = operatingFixedOutflow + housingCashOutflow + insuranceCashOutflow + rentDepositCashOutflow + carRelatedCashOutflow + ustOutflowFinal + taxesPaidThisMonth;
                
                const netCashFlow = salesRevenueGross - totalCashOutflow;
                
                accumulatedCashBalance += netCashFlow;
                
                data.push({
                    month: `Міс. ${i + 1}`,
                    carsSoldTarget: carsSoldTarget,
                    carsSold: carsSold,
                    carsBought: carsBought,
                    rentCostMonthly: rentCostMonthly,
                    otherFixedCostMonthly: otherFixedCostMonthly,
                    currentInventory: currentInventory,
                    ebit: ebit,
                    netCashFlow: netCashFlow,
                    ustPaidThisMonth: ustPaidThisMonth,
                    taxesPaidThisMonth: taxesPaidThisMonth,
                    accumulatedBalance: accumulatedCashBalance,
                    yearly_tax_data: current_yearly_tax_data,
                    inventoryWarning: inventoryWarning,
                    netProfitFinal: ebit - (current_yearly_tax_data.total / 12)
                });
                last_yearly_tax_data = current_yearly_tax_data;
            }
            return data;
        }
        // ########## END: ВИПРАВЛЕНА ФУНКЦІЯ РОЗРАХУНКІВ ##########


        function recalculatePlan() {
            processedData = processData();
            updateDataTable();
            updateCostPerCarDisplay();
            updatePurchase25aVisibility();
        }

        function updateCostPerCarDisplay() {
            const carPurchase = parseFloat(document.getElementById('carPurchase').value) || 0;
            const prepCosts = parseFloat(document.getElementById('prepCosts').value) || 0;
            const isKU = document.getElementById('ustRegime').value === 'kleinunternehmer';
            
            // P&L Cost for KU is the gross price they pay
            // P&L Cost for others is the net price
            const carPurchaseCost = isKU ? carPurchase : carPurchase / (1 + UST_RATE);
            const prepCost = isKU ? prepCosts * (1 + UST_RATE) : prepCosts;

            const totalCost = carPurchaseCost + prepCost;
            
            document.getElementById('costPerCarDisplay').textContent = formatCurrency(totalCost);
        }

        function updatePurchase25aVisibility() {
            const purchase25aLabel = document.getElementById('purchaseWithVAT_label');
            const ustRegime = document.getElementById('ustRegime').value;
            
            if (ustRegime === 'regular') {
                purchase25aLabel.style.display = 'flex';
            } else {
                purchase25aLabel.style.display = 'none';
            }
        }
        
        function updateDataTable() {
            const tableBody = document.querySelector('#dataTable tbody');
            
            let bodyHtml = '';
            for(let i = 0; i < NUM_MONTHS; i++) {
                const data = processedData[i];
                const yearlyData = data.yearly_tax_data;

                const gwst_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Gewerbesteuer) : '0.00 €';
                const est_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Einkommensteuer) : '0.00 €';
                
                const advance_val = data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(data.taxesPaidThisMonth) : '0.00 €';

                const salesInput = `<input type="number" id="salesPlan_${i}" value="${data.carsSoldTarget}" min="0" class="w-16 data-input">`;
                const purchaseInput = `<input type="number" id="purchasePlan_${i}" value="${data.carsBought}" min="0" class="w-16 data-input">`;
                const rentInput = `<input type="number" id="rentPlan_${i}" value="${data.rentCostMonthly}" min="0" class="w-20 data-input">`;
                const otherFixedInput = `<input type="number" id="otherFixedPlan_${i}" value="${data.otherFixedCostMonthly}" min="0" class="w-20 data-input">`;

                let inventoryClass = data.currentInventory < 0 ? 'warning-text' : '';
                if (data.inventoryWarning) inventoryClass = 'warning-text'; 

                const salesCellClass = data.carsSoldTarget !== data.carsSold ? 'warning-text' : '';
                
                let ustClass = 'text-gray-500';
                if (data.ustPaidThisMonth > 0) {
                    ustClass = 'text-red-700';
                } else if (data.ustPaidThisMonth < 0) {
                    ustClass = 'text-green-600 font-bold';
                }
                
                bodyHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2 ${salesCellClass}">${salesInput}</td>
                    <td class="px-3 py-2">${purchaseInput}</td>
                    <td class="px-3 py-2">${rentInput}</td>
                    <td class="px-3 py-2">${otherFixedInput}</td>
                    <td class="px-3 py-2 ${inventoryClass}">${data.currentInventory}</td>
                    <td class="px-3 py-2 ${data.ebit < 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(data.ebit)}</td>
                    <td class="px-3 py-2 ${data.netCashFlow < 0 ? 'text-red-500' : ''}">${formatCurrency(data.netCashFlow)}</td>
                    <td class="px-3 py-2 ${ustClass}">${formatCurrency(data.ustPaidThisMonth)}</td>
                    <td class="px-3 py-2 font-bold">${advance_val}</td>
                    <td class="px-3 py-2">${gwst_val}</td>
                    <td class="px-3 py-2">${est_val}</td>
                    <td class="px-3 py-2 ${data.netProfitFinal < 0 ? 'text-red-500' : 'text-green-800 font-bold'}">${formatCurrency(data.netProfitFinal)}</td>
                    <td class="px-3 py-2 ${data.accumulatedBalance < 0 ? 'warning-text' : 'font-bold'}">${formatCurrency(data.accumulatedBalance)}</td>
                </tr>`;
            }
            tableBody.innerHTML = bodyHtml;
            
            document.querySelectorAll('#dataTable input[type="number"]').forEach(input => {
                input.addEventListener('change', recalculatePlan);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('uk'); // Set default language
            
            const initialSalesPlan = populateInitialSalesPlan();
            const initialPurchasePlan = generateInitialPurchasePlan(initialSalesPlan); 
            const initialRentPlan = populateInitialRentPlan();
            const initialOtherFixedPlan = populateInitialOtherFixedPlan();
            
            const tableBody = document.querySelector('#dataTable tbody');
            let initialHtml = '';
            initialSalesPlan.forEach((val, i) => {
                const initialPurchase = initialPurchasePlan[i]; 
                const initialRent = initialRentPlan[i];
                const initialOtherFixed = initialOtherFixedPlan[i];

                initialHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2"><input type="number" id="salesPlan_${i}" value="${val}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="purchasePlan_${i}" value="${initialPurchase}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="rentPlan_${i}" value="${initialRent}" min="0" class="w-20 data-input"></td> 
                    <td class="px-3 py-2"><input type="number" id="otherFixedPlan_${i}" value="${initialOtherFixed}" min="0" class="w-20 data-input"></td> 
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            });
            tableBody.innerHTML = initialHtml;

            document.querySelectorAll('#grant, #savings, #rentDeposit, #rentDepositSpreadMonths, #healthInsurance, #personalCosts, #avgSalePrice, #carPurchase, #prepCosts').forEach(input => { 
                input.addEventListener('change', recalculatePlan);
            });
            document.getElementById('ustRegime').addEventListener('change', recalculatePlan);
            document.getElementById('purchaseWithVAT').addEventListener('change', recalculatePlan);
            document.getElementById('rentHasVAT').addEventListener('change', recalculatePlan);
            document.getElementById('jobcenterCoversHousing').addEventListener('change', recalculatePlan);
            document.getElementById('jobcenterCoversInsurance').addEventListener('change', recalculatePlan);
            document.getElementById('calculate-button').addEventListener('click', recalculatePlan);

            updatePurchase25aVisibility();
            recalculatePlan();
        });
    </script>

</body>
</html>
