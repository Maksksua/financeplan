<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Професійна фінансова панель: Автодилер, Нюрнберг</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#2563eb; --ok:#16a34a; --bad:#ef4444; --muted:#6b7280; }
    body{font-family:'Inter',sans-serif;background:#f6f8fb}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(2,6,23,.06);padding:24px}
    .chart-container{position:relative;width:100%;height:360px}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .v{font-size:28px;font-weight:800;color:#111827}
    .kpi .l{font-size:12px;color:var(--muted)}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
    .grid-inputs{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
    @media (max-width:1024px){.grid-inputs{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:640px){.grid-inputs{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .subtle{color:#374151}
    .pill{font-size:12px;border:1px solid #e5e7eb;border-radius:9999px;padding:.25rem .5rem;background:#f9fafb}
  </style>
</head>
<body class="antialiased text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900" data-i18n="title">Професійна фінансова панель</h1>
      <p class="text-md text-gray-600 mt-2" data-i18n="subtitle">Аналіз фінансового плану автодилера в Нюрнберзі</p>
    </header>

    <!-- Language -->
    <div class="flex justify-center gap-2 mb-6">
      <button class="px-3 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700" onclick="setLanguage('uk')">Українська</button>
      <button class="px-3 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700" onclick="setLanguage('ru')">Русский</button>
      <button class="px-3 py-2 text-sm font-medium rounded-lg text-white bg-gray-600 hover:bg-gray-700" onclick="setLanguage('de')">Deutsch</button>
    </div>

    <!-- Inputs -->
    <section class="card mb-8">
      <h3 class="text-lg font-semibold mb-4" data-i18n="input-data-title">Введення даних для моделювання</h3>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Sales -->
        <div class="bg-gray-100 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-sales">План продажів та дохід</h4>
          <div class="grid-inputs">
            <!-- 24 months sales -->
            <template id="sales-template">
              <label class="block">
                <span class="text-gray-700 text-xs"></span>
                <input type="number" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"/>
              </label>
            </template>
            <div id="sales-grid" class="contents"></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
            <label class="block">
              <span class="text-gray-700 text-sm" data-i18n="input-avg-price">Середня ціна продажу (€):</span>
              <input type="number" id="avgSalePrice" value="4200" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200">
            </label>
            <label class="block">
              <span class="text-gray-700 text-sm" data-i18n="input-car-purchase">Закупка авто (€/авто):</span>
              <input type="number" id="carPurchase" value="2300" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200">
            </label>
          </div>
        </div>

        <!-- Funding & Private -->
        <div class="bg-gray-100 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-funding">Початкове фінансування</h4>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-grant">Безповоротний грант (€):</span>
            <input type="number" id="grant" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-savings">Інвестиції, заощадження (€):</span>
            <input type="number" id="savings" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <h4 class="font-semibold text-gray-800 mb-2 mt-4" data-i18n="input-group-private">Особисті витрати</h4>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-health-insurance">Мед. страховка/Пенсія (€/міс):</span>
            <input type="number" id="healthInsurance" value="400" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <label class="block">
            <span class="text-gray-700 text-sm" data-i18n="input-personal-costs">Особисті витрати (€/міс):</span>
            <input type="number" id="personalCosts" value="1000" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
        </div>

        <!-- Fixed/Taxes -->
        <div class="flex flex-col gap-4">
          <div class="bg-gray-100 rounded-xl p-4">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-costs">Постійні витрати</h4>
            <div class="grid grid-cols-2 gap-3">
              <label><span class="text-sm" data-i18n="input-rent">Оренда (€/міс):</span><input id="rent" type="number" value="600" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-accounting-monthly">Бухгалтерія (€/міс):</span><input id="accounting" type="number" value="171" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-insurance">Страхування (€/міс):</span><input id="insurance" type="number" value="193" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-communication">Зв'язок (€/міс):</span><input id="communication" type="number" value="65" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-contingency">Інші фікс. (€/міс):</span><input id="contingency" type="number" value="100" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-software">ПЗ (€/міс):</span><input id="software" type="number" value="37.33" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-office-supplies">Бюро/Кава (€/міс):</span><input id="officeSupplies" type="number" value="40" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-working-materials">Роб. матеріали (€/міс):</span><input id="workingMaterials" type="number" value="23.75" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-transport-costs">Трансп. витрати (€/міс):</span><input id="transportCosts" type="number" value="166" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label><span class="text-sm" data-i18n="input-ad-costs">Реклама (€/міс):</span><input id="adCosts" type="number" value="30.83" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label class="col-span-2"><span class="text-sm" data-i18n="input-bank-fees">Банківські збори (€/міс):</span><input id="bankFees" type="number" value="17" class="mt-1 w-full rounded-md border-gray-300"/></label>
              <label class="col-span-2"><span class="text-sm" data-i18n="input-repair-costs">Ремонт приміщення (€/міс):</span><input id="repairCosts" type="number" value="5.83" class="mt-1 w-full rounded-md border-gray-300"/></label>
            </div>
          </div>

          <div class="bg-gray-100 rounded-xl p-4">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-taxes">Податкова інформація</h4>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="tax-form">Форма оподаткування:</span>
              <select id="taxForm" class="mt-1 w-full rounded-md border-gray-300">
                <option value="einz" data-i18n="option-einz">ФОП (Einzelunternehmen)</option>
                <option value="gmbh" data-i18n="option-gmbh">ТОВ (GmbH)</option>
              </select>
            </label>
            <label class="block mb-2" id="ust-regime-label">
              <span class="text-gray-700 text-sm" data-i18n="ust-regime">Режим ПДВ:</span>
              <select id="ustRegime" class="mt-1 w-full rounded-md border-gray-300">
                <option value="regular" data-i18n="option-regular">Стандартний (Regelbesteuerung)</option>
                <option value="margin" data-i18n="option-margin">Differenzbesteuerung (§25a UStG)</option>
                <option value="kleinunternehmer" data-i18n="option-kleinunternehmer">Kleinunternehmer (§19 UStG)</option>
              </select>
            </label>
            <div id="ust-frequency-block">
              <label class="block">
                <span class="text-gray-700 text-sm" data-i18n="ust-payment-frequency">Частота сплати ПДВ:</span>
                <select id="ustFrequency" class="mt-1 w-full rounded-md border-gray-300">
                  <option value="monthly" data-i18n="option-monthly">Щомісячно</option>
                  <option value="quarterly" data-i18n="option-quarterly">Щоквартально</option>
                </select>
              </label>
            </div>
            <label class="block mt-2" id="gebesatz-label">
              <span class="text-gray-700 text-sm" data-i18n="business-tax-rate">Hebesatz Gewerbesteuer (Nürnberg, %):</span>
              <input type="number" id="gebesatz" value="467" min="0" class="mt-1 block w-full rounded-md border-gray-300">
            </label>
            <p class="text-xs text-red-500 mt-1" data-i18n="note-gebesatz">Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.</p>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-center">
        <button id="calculate-button" class="px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700" data-i18n="calculate-button">Розрахувати</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="card mb-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
        <div class="kpi card">
          <div id="kpi-sales" class="v">0</div>
          <div class="l" data-i18n="kpi-sales-label">Авто продано</div>
        </div>
        <div class="kpi card">
          <div id="kpi-revenue" class="v">€0</div>
          <div class="l" data-i18n="kpi-revenue-label">Загальний дохід (P&L)</div>
        </div>
        <div class="kpi card">
          <div id="kpi-ebit" class="v">€0</div>
          <div class="l" data-i18n="kpi-ebit-label">EBIT (прибуток до податків)</div>
        </div>
        <div class="kpi card">
          <div id="kpi-balance" class="v">€0</div>
          <div class="l" data-i18n="kpi-balance-label">Накопичений баланс (Cash-Flow)</div>
        </div>
      </div>
      <div>
        <label for="month-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label">Оберіть місяць для аналізу:</label>
        <input id="month-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 mt-2">
          <span data-i18n="month-1">Місяць 1</span>
          <span id="slider-label-month" class="font-bold text-blue-600">Місяць 1</span>
          <span data-i18n="month-24">Місяць 24</span>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="card">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-1-title">Прогноз ліквідності (Накопичений баланс)</h3>
        <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-2-title">Доходи vs. Витрати (P&L)</h3>
        <div class="chart-container"><canvas id="revenueVsExpensesChart"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-3-title">Динаміка продажів (Авто, шт.)</h3>
        <div class="chart-container"><canvas id="salesChart"></canvas></div>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold mb-2">
          <span data-i18n="chart-4-title">Структура витрат (P&L) (Місяць</span>
          <span class="selected-month-label">1</span>)
        </h3>
        <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
      </div>
    </section>

    <!-- Table -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-lg" data-i18n="table-summary">Показати детальну фінансову інформацію</h3>
        <span class="pill subtle" data-i18n="pnl-note">Прибуток/збиток до сплати податків (EBT).</span>
      </div>
      <p class="text-sm text-gray-600 mb-4" data-i18n="table-description">У таблиці представлені розгорнуті дані P&L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.</p>
      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full text-sm text-left text-gray-700">
          <thead class="text-xs uppercase bg-gray-50"></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Analysis -->
    <section class="card mt-8">
      <h3 class="text-lg font-semibold mb-4" data-i18n="analysis-title">Детальний аналіз</h3>
      <div>
        <label for="analysis-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label-analysis">Оберіть місяць для детального аналізу:</label>
        <input id="analysis-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 mt-2">
          <span data-i18n="month-1">Місяць 1</span>
          <span id="slider-label-analysis-month" class="font-bold text-blue-600">Місяць 1</span>
          <span data-i18n="month-24">Місяць 24</span>
        </div>
      </div>
      <div id="analysis-content" class="text-sm text-gray-700 space-y-4 mt-6"></div>
    </section>
  </div>

  <script>
/* =================== I18N =================== */
const TRANSLATIONS = {
  uk:{title:"Професійна фінансова панель",subtitle:"Аналіз фінансового плану автодилера в Нюрнберзі",
    "input-data-title":"Введення даних для моделювання","input-group-sales":"План продажів та дохід",
    "input-avg-price":"Середня ціна продажу (€):","input-car-purchase":"Закупка авто (€/авто):",
    "input-group-funding":"Початкове фінансування","input-grant":"Безповоротний грант (€):",
    "input-savings":"Інвестиції, заощадження (€):","input-group-private":"Особисті витрати",
    "input-health-insurance":"Мед. страховка/Пенсія (€/міс):","input-personal-costs":"Особисті витрати (€/міс):",
    "input-group-costs":"Постійні витрати","input-rent":"Оренда (€/міс):","input-accounting-monthly":"Бухгалтерія (€/міс):",
    "input-insurance":"Страхування (€/міс):","input-communication":"Зв'язок (€/міс):","input-contingency":"Інші фікс. (€/міс):",
    "input-software":"ПЗ (€/міс):","input-office-supplies":"Бюро/Кава (€/міс):","input-working-materials":"Роб. матеріали (€/міс):",
    "input-transport-costs":"Трансп. витрати (€/міс):","input-ad-costs":"Реклама (€/міс):","input-bank-fees":"Банківські збори (€/міс):",
    "input-repair-costs":"Ремонт приміщення (€/міс):","input-group-taxes":"Податкова інформація","tax-form":"Форма оподаткування:",
    "option-einz":"ФОП (Einzelunternehmen)","option-gmbh":"ТОВ (GmbH)","ust-regime":"Режим ПДВ:",
    "option-regular":"Стандартний (Regelbesteuerung)","option-margin":"Differenzbesteuerung (§25a UStG)",
    "option-kleinunternehmer":"Kleinunternehmer (§19 UStG)","ust-payment-frequency":"Частота сплати ПДВ:",
    "option-monthly":"Щомісячно","option-quarterly":"Щоквартально","business-tax-rate":"Hebesatz Gewerbesteuer (Nürnberg, %):",
    "note-gebesatz":"Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.","calculate-button":"Розрахувати",
    "kpi-sales-label":"Авто продано","kpi-revenue-label":"Загальний дохід (P&L)","kpi-ebit-label":"EBIT (прибуток до податків)",
    "kpi-balance-label":"Накопичений баланс (Cash-Flow)","slider-label":"Оберіть місяць для аналізу:","month-1":"Місяць 1",
    "month-current":"Місяць ","month-24":"Місяць 24","chart-1-title":"Прогноз ліквідності (Накопичений баланс)",
    "chart-2-title":"Доходи vs. Витрати (P&L)","chart-3-title":"Динаміка продажів (Авто, шт.)",
    "chart-4-title":"Структура витрат (P&L) (Місяць","table-summary":"Показати детальну фінансову інформацію",
    "table-description":"У таблиці представлені розгорнуті дані P&L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.",
    "table-headers":["Міс.","Продажі","P&L","Cash Flow","ПДВ (сплачено/отримано)","Податок на торгівлю","Податок на дохід","Баланс"],
    "chart-labels":{"cashFlow":"Накопичений баланс","ebit":"EBIT (P&L)","revenue":"Загальний дохід (P&L)","expenses":"Загальні витрати (P&L)","sales":"Продано автомобілів","cashInflow":"Грошовий приплив","cashOutflow":"Грошовий відплив"},
    "analysis-title":"Детальний аналіз","analysis-summary-title":"Місячний P&L","analysis-month-title":"Фінансовий звіт за ",
    "analysis-revenue-title":"Доходи (P&L)","analysis-variable-costs-title":"Змінні витрати (P&L)","analysis-fixed-costs-title":"Постійні витрати (P&L)",
    "analysis-taxes-title":"Розрахунки по податках","analysis-cash-flow-title":"Рух грошових коштів (Cash Flow)","analysis-total-revenue":"Загальний дохід:",
    "analysis-total-variable-cost":"Всього змінні витрати:","analysis-total-fixed-cost":"Всього постійні витрати:","analysis-net-profit":"Чистий дохід (EBT):",
    "analysis-ebit":"EBIT (прибуток до податків):","analysis-after-tax-profit":"Чистий дохід після податків:","analysis-taxes":"Податки:",
    "analysis-net-cashflow":"Чистий грошовий потік:","analysis-final-balance":"Накопичений баланс:","analysis-profit-per-car":"EBIT на 1 авто",
    "pnl-note":"Прибуток/збиток до сплати податків (EBT).","ust-note":"Податок на додану вартість. Сплачується окремо від прибутку.",
    "yearly-profit-for-taxes":"Податкова база за рік:","gebesatz-tax":"Податок на торгівлю:","einkommensteuer":"Податок на дохід:",
    "koerperschaftsteuer":"Податок на прибуток корпорацій:","soli-tax":"Надбавка солідарності:","final-tax-for-year":"Разом податків за рік:",
    "tax-paid-this-month":"Сплачено в цьому місяці:","car-purchase-cash-flow":"Закупка авто (відплив коштів):","ust-paid":"Сплачений ПДВ:",
    "ust-received":"Отриманий ПДВ:","investments-cash-flow":"Інвестиції/Грант:","fixed-costs-cat":"Постійні витрати",
    "variable-costs-cat":"Змінні витрати","taxes-cat":"Податки","ust-cash-cat":"Рух ПДВ","inventory-cat":"Закупівлі авто"
  },
  ru:{/* сокращено — те же ключи/смыслы */}, de:{/* сокращено — те же ключи/смыслы */}
};
// для краткости: ru/de содержат те же ключи, что и uk (из твоей версии). 

/* ============== CONSTANTS ============== */
const NUM_MONTHS=24, FREIBETRAG_GEWST=24500, GRUNDFREIBETRAG_EST_2025=12096, UST_RATE=0.19, UST_SATZ=19, SOLI_RATE=0.055, KST_RATE=0.15;

/* ============== HELPERS ============== */
function nf(value){
  const lang=document.documentElement.lang;
  const loc=lang==='de'?'de-DE':(lang==='uk'?'uk-UA':'ru-RU');
  if(value===null||value===undefined||Number.isNaN(value)) return '—';
  return new Intl.NumberFormat(loc,{style:'currency',currency:'EUR',minimumFractionDigits:2}).format(value);
}
function clamp(n){return Math.round((n+Number.EPSILON)*100)/100}
function calcESt(taxableIncome){
  let tax=0;
  const Y=(taxableIncome-GRUNDFREIBETRAG_EST_2025)/10000;
  if(taxableIncome<GRUNDFREIBETRAG_EST_2025) tax=0;
  else if(taxableIncome<=15999) tax=(980.14*Y+1400)*Y;
  else if(taxableIncome<=62809) tax=(212.02*(Y-1.5)+2397)*(Y-1.5)+1400;
  else if(taxableIncome<=277825) tax=0.42*taxableIncome-9877.94;
  else tax=0.45*taxableIncome-17316.5;
  return Math.max(0,tax);
}

/* ===== GLOBAL STATE ===== */
let processedData=[], charts={};

/* ====== CORE CALC ====== */
function processData(){
  const salesPlan=[...Array(NUM_MONTHS)].map((_,i)=>parseInt(document.getElementById(`sales_${i}`).value)||0);
  const lag=1; // закупка на месяц раньше продажи
  const fin={
    grant: +document.getElementById('grant').value||0,
    savings: +document.getElementById('savings').value||0,
    avgSalePrice: +document.getElementById('avgSalePrice').value||0,
    carPurchase: +document.getElementById('carPurchase').value||0,
    gebesatz: +document.getElementById('gebesatz').value||0,
    healthInsurance:+document.getElementById('healthInsurance').value||0,
    personalCosts:+document.getElementById('personalCosts').value||0,
    fixed:{
      rent:+rent.value, accounting:+accounting.value, insurance:+insurance.value, communication:+communication.value,
      contingency:+contingency.value, software:+software.value, officeSupplies:+officeSupplies.value, workingMaterials:+workingMaterials.value,
      transportCosts:+transportCosts.value, adCosts:+adCosts.value, bankFees:+bankFees.value, repairCosts:+repairCosts.value
    },
    varPerCar:{
      carWash:+carWash.value, carRepair:+carRepair.value, tuvDiag:+tuvDiag.value, logistics:+logistics.value, warranty:+warranty.value, carAd:+carAd.value
    },
    taxForm: document.getElementById('taxForm').value,
    ustRegime: document.getElementById('ustRegime').value,
    ustFrequency: document.getElementById('ustFrequency').value
  };
  const fixedSum=Object.values(fin.fixed).reduce((a,b)=>a+b,0);
  const varPerCarSum=Object.values(fin.varPerCar).reduce((a,b)=>a+b,0);

  // План закупок (лаг)
  const purchasePlan=Array(NUM_MONTHS).fill(0);
  for(let i=0;i<NUM_MONTHS;i++){ if(i-lag>=0) purchasePlan[i-lag]=salesPlan[i]; }

  let cashBalance=fin.grant+fin.savings;
  let yEBIT=0, yGewBase=0;
  let ustCarry=0; // накопленное ПДВ к уплате/возврату до срока

  processedData=[];
  for(let i=0;i<NUM_MONTHS;i++){
    const sold=salesPlan[i], bought=purchasePlan[i];

    // --- USt ---
    let grossRevenue=sold*fin.avgSalePrice; // цена ввода считаем БРУТТО (для регулярного НДС и маржи)
    let pnlRevenueNet=grossRevenue; // позже скорректируем
    let ustDueOut=0, inputUst=0, ustPaymentThisMonth=0;

    if(fin.ustRegime==='regular'){
      ustDueOut=clamp(grossRevenue*UST_RATE);               // выходной НДС
      inputUst=clamp((fixedSum + sold*varPerCarSum + bought*fin.carPurchase)*UST_RATE); // ВХОДНОЙ НДС (упрощённо)
      pnlRevenueNet=clamp(grossRevenue-ustDueOut);          // P&L нетто
      ustCarry=clamp(ustCarry + ustDueOut - inputUst);      // накапливаем к платежу/возврату
      // платёж по частоте
      const isDue = fin.ustFrequency==='monthly' ? true : ((i+1)%3===0);
      if(isDue){ ustPaymentThisMonth=ustCarry; ustCarry=0; }
    } else if(fin.ustRegime==='margin'){
      // НДС с маржи: 19/119 от маржи (маржа = цена - закупка; прочие переменные в §25a не уменьшают базу)
      const margin = clamp(sold*(fin.avgSalePrice - fin.carPurchase));
      const ustOnMargin = margin>0 ? clamp(margin*UST_SATZ/(100+UST_SATZ)) : 0;
      ustCarry=clamp(ustCarry + ustOnMargin);
      pnlRevenueNet=clamp(grossRevenue - ustOnMargin); // P&L исключает НДС с маржи
      const isDue = fin.ustFrequency==='monthly' ? true : ((i+1)%3===0);
      if(isDue){ ustPaymentThisMonth=ustCarry; ustCarry=0; }
    } else { // kleinunternehmer
      pnlRevenueNet=grossRevenue; ustDueOut=0; inputUst=0; ustPaymentThisMonth=0;
      // никаких движений по USt
    }

    // --- P&L ---
    const cogs = clamp(sold*fin.carPurchase);
    const varCosts = clamp(sold*varPerCarSum + cogs);
    const fixedCosts = clamp(fixedSum);
    const totalExpenses = clamp(varCosts + fixedCosts);
    const ebit = clamp(pnlRevenueNet - totalExpenses);
    yEBIT += ebit; yGewBase += ebit;

    // --- Годовые налоги (выплата в 12/24 месяц) ---
    let taxesThisMonth=0;
    if((i+1)%12===0){ // конец года
      let totalTax=0;
      if(fin.taxForm==='einz'){
        // Gewerbesteuer
        const gewBase = Math.max(0, yGewBase - FREIBETRAG_GEWST);
        const messbetrag = gewBase * 0.035;
        const gewSt = clamp(messbetrag * (fin.gebesatz/100));
        // Einkommensteuer (приближение): база = прибыль - страх.взносы
        const estBase = Math.max(0, yEBIT - (fin.healthInsurance*12));
        const est = clamp(calcESt(estBase));
        // Зачёт GewSt по §35 EStG: до 3.8*faktor (в упрощении до суммы ESt)
        const credit = Math.min(est, clamp(gewSt*3.8));
        const estFinal = clamp(Math.max(0, est - credit));
        totalTax = clamp(estFinal + gewSt);
      } else { // gmbh
        const kst = clamp(yEBIT*KST_RATE);
        const soli = clamp(kst*SOLI_RATE);
        const gewBase = Math.max(0, yEBIT); // без Freibetrag для GmbH
        const messbetrag = gewBase*0.035;
        const gewSt = clamp(messbetrag * (fin.gebesatz/100));
        totalTax = clamp(kst+soli+gewSt);
      }
      taxesThisMonth = totalTax; // платим в конце года
      yEBIT=0; yGewBase=0; // обнуляем для следующего года
    }

    // --- Cash Flow ---
    const cashInflow = clamp(pnlRevenueNet + (i===0 ? (fin.grant+fin.savings) : 0)); // входящий USt не добавляем, т.к. pnlRevenueNet уже net; USt в cash — отдельной строкой
    const fixedCash = clamp(fixedCosts + (fin.ustRegime==='regular'? 0 : 0)); // не добавляем USt второй раз
    const varCash = clamp(sold*varPerCarSum);
    const purchasesCash = clamp(bought*fin.carPurchase);
    const ownerDraw = clamp(fin.healthInsurance + fin.personalCosts);
    // движение по НДС (уплата +/− возврат)
    const ustCashMovement = clamp(ustPaymentThisMonth); // может быть <0 (возврат)
    const netCF = clamp(cashInflow - fixedCash - varCash - purchasesCash - ustCashMovement - taxesThisMonth - ownerDraw);
    cashBalance = clamp(cashBalance + netCF);

    processedData.push({
      idx:i,
      monthLabel:i+1,
      carsSold:sold,
      carsBought:bought,
      totalRevenuePnl:pnlRevenueNet,
      totalExpensesPnl:totalExpenses,
      ebit,
      netCashFlow:netCF,
      accumulatedBalance:cashBalance,
      ustDueDisplay: (fin.ustRegime==='regular'||fin.ustRegime==='margin') ? ustCashMovement : 0, // что реально уплачено/получено в этом месяце
      taxesPaidThisMonth: taxesThisMonth,
      totalFixedCostsPnl: fixedCosts,
      totalVariableCostsPnl: varCosts,
      carPurchaseOut: purchasesCash,
      ownerDraw,
      // для анализа
      yearly_tax_snapshot: taxesThisMonth, // показывает сумму годовых налогов в конце года
    });
  }
}

/* ====== CHARTS ====== */
function makeCharts(){
  const labels=processedData.map(d=>`${TRANSLATIONS[document.documentElement.lang]["month-current"]}${d.monthLabel}`);

  charts.cashFlow = new Chart(document.getElementById('cashFlowChart'),{
    type:'line',
    data:{labels,
      datasets:[{label:TRANSLATIONS[document.documentElement.lang]["chart-labels"]["cashFlow"],
        data:processedData.map(d=>d.accumulatedBalance), borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.12)', fill:true, tension:.2}]
    },
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${nf(c.raw)}`}}},
      scales:{y:{ticks:{callback:v=>nf(v)}}}
    }
  });

  charts.revExp = new Chart(document.getElementById('revenueVsExpensesChart'),{
    type:'bar',
    data:{labels,
      datasets:[
        {label:TRANSLATIONS[document.documentElement.lang]["chart-labels"]["revenue"], data:processedData.map(d=>d.totalRevenuePnl), backgroundColor:'#16a34a'},
        {label:TRANSLATIONS[document.documentElement.lang]["chart-labels"]["expenses"], data:processedData.map(d=>d.totalExpensesPnl), type:'line', borderColor:'#ef4444', backgroundColor:'#ef4444', fill:false, tension:.2}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${nf(c.raw)}`}}},
      scales:{y:{beginAtZero:true,ticks:{callback:v=>nf(v)}}}
    }
  });

  charts.sales = new Chart(document.getElementById('salesChart'),{
    type:'bar',
    data:{labels, datasets:[{label:TRANSLATIONS[document.documentElement.lang]["chart-labels"]["sales"], data:processedData.map(d=>d.carsSold), backgroundColor:'#8b5cf6'}]},
    options:{responsive:true,maintainAspectRatio:false, plugins:{legend:{display:false}} ,scales:{y:{beginAtZero:true}}}
  });

  charts.break = new Chart(document.getElementById('costBreakdownChart'),{
    type:'doughnut',
    data:{
      labels:[
        TRANSLATIONS[document.documentElement.lang]["fixed-costs-cat"],
        TRANSLATIONS[document.documentElement.lang]["variable-costs-cat"],
        TRANSLATIONS[document.documentElement.lang]["taxes-cat"],
        TRANSLATIONS[document.documentElement.lang]["ust-cash-cat"],
        TRANSLATIONS[document.documentElement.lang]["inventory-cat"]
      ],
      datasets:[{data: [0,0,0,0,0], backgroundColor:['#3b82f6','#f97316','#22c55e','#ef4444','#6b7280']}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:c=>`${c.label}: ${nf(c.parsed)}`}}}}
  });
}
function updateBreakdown(i){
  const d=processedData[i];
  charts.break.data.datasets[0].data=[
    d.totalFixedCostsPnl,
    d.totalVariableCostsPnl,
    d.taxesPaidThisMonth,
    d.ustDueDisplay,
    d.carPurchaseOut
  ];
  charts.break.update();
}

/* ====== UI UPDATERS ====== */
function updateKpi(i){
  const d=processedData[i];
  document.getElementById('slider-label-month').textContent=TRANSLATIONS[document.documentElement.lang]["month-current"]+(i+1);
  document.querySelectorAll('.selected-month-label').forEach(el=>el.textContent=(i+1));
  document.getElementById('kpi-sales').textContent=d.carsSold;
  document.getElementById('kpi-revenue').textContent=nf(d.totalRevenuePnl);
  document.getElementById('kpi-ebit').textContent=nf(d.ebit);
  document.getElementById('kpi-balance').textContent=nf(d.accumulatedBalance);
  updateBreakdown(i);
}
function updateTable(){
  const th=document.querySelector('#dataTable thead');
  const tb=document.querySelector('#dataTable tbody');
  const headers=TRANSLATIONS[document.documentElement.lang]["table-headers"];
  th.innerHTML = `<tr>${headers.map(h=>`<th class="px-4 py-2">${h}</th>`).join('')}</tr>`;
  tb.innerHTML = processedData.map(d=>`
    <tr class="border-b">
      <td class="px-4 py-2">${d.monthLabel}</td>
      <td class="px-4 py-2">${d.carsSold}</td>
      <td class="px-4 py-2">${nf(d.ebit)}</td>
      <td class="px-4 py-2">${nf(d.netCashFlow)}</td>
      <td class="px-4 py-2">${nf(d.ustDueDisplay)}</td>
      <td class="px-4 py-2">${(d.taxesPaidThisMonth>0)?nf(d.taxesPaidThisMonth):'—'}</td>
      <td class="px-4 py-2">${'—' /* для GmbH/Einz подробное разложение в анализе */}</td>
      <td class="px-4 py-2">${nf(d.accumulatedBalance)}</td>
    </tr>
  `).join('');
}
function updateAnalysis(lang,i){
  const d=processedData[i];
  const content=document.getElementById('analysis-content');
  content.innerHTML=`
    <div class="space-y-4">
      <p class="font-bold text-lg">${TRANSLATIONS[lang]["analysis-month-title"]}${i+1}</p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="p-4 bg-gray-50 rounded-lg">
          <h4 class="font-bold mb-2">${TRANSLATIONS[lang]["analysis-summary-title"]}</h4>
          <ul class="space-y-1">
            <li><b>${TRANSLATIONS[lang]["analysis-total-revenue"]}</b> ${nf(d.totalRevenuePnl)}</li>
            <li><b>${TRANSLATIONS[lang]["analysis-total-variable-cost"]}</b> ${nf(d.totalVariableCostsPnl)}</li>
            <li><b>${TRANSLATIONS[lang]["analysis-total-fixed-cost"]}</b> ${nf(d.totalFixedCostsPnl)}</li>
            <li class="font-bold text-green-700">${TRANSLATIONS[lang]["analysis-ebit"]} ${nf(d.ebit)}</li>
            <li><b>${TRANSLATIONS[lang]["analysis-profit-per-car"]}:</b> ${d.carsSold?nf(d.ebit/d.carsSold):nf(0)}</li>
          </ul>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg lg:col-span-2">
          <h4 class="font-bold mb-2">${TRANSLATIONS[lang]["analysis-taxes-title"]}</h4>
          <p class="text-xs">${TRANSLATIONS[lang]["ust-note"]}</p>
          <ul class="space-y-1 mt-2">
            <li><b>${TRANSLATIONS[lang]["ust-paid"]}</b> ${nf(d.ustDueDisplay)}</li>
            ${d.taxesPaidThisMonth>0?`<li class="font-bold text-blue-700">${TRANSLATIONS[lang]["final-tax-for-year"]} ${nf(d.taxesPaidThisMonth)} (${TRANSLATIONS[lang]["tax-paid-this-month"]})</li>`:''}
          </ul>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg lg:col-span-3">
          <h4 class="font-bold mb-2">${TRANSLATIONS[lang]["analysis-cash-flow-title"]}</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <h5 class="font-semibold">${TRANSLATIONS[lang]["chart-labels"]["cashInflow"]}</h5>
              <ul class="list-disc list-inside space-y-1 mt-1">
                <li>${TRANSLATIONS[lang]["analysis-total-revenue"]} ${nf(d.totalRevenuePnl)}</li>
                <li>${TRANSLATIONS[lang]["investments-cash-flow"]} ${nf(i===0?processedData[0].accumulatedBalance - d.netCashFlow - d.totalFixedCostsPnl - d.totalVariableCostsPnl - d.carPurchaseOut - d.ustDueDisplay - d.taxesPaidThisMonth - d.ownerDraw:0)}</li>
              </ul>
            </div>
            <div>
              <h5 class="font-semibold">${TRANSLATIONS[lang]["chart-labels"]["cashOutflow"]}</h5>
              <ul class="list-disc list-inside space-y-1 mt-1">
                <li>${TRANSLATIONS[lang]["car-purchase-cash-flow"]} ${nf(d.carPurchaseOut)}</li>
                <li>${TRANSLATIONS[lang]["analysis-fixed-costs-title"]} ${nf(d.totalFixedCostsPnl)}</li>
                <li>${TRANSLATIONS[lang]["variable-costs-sold-cars"]} ${nf(d.totalVariableCostsPnl)}</li>
                <li>${TRANSLATIONS[lang]["analysis-taxes"]} ${nf(d.taxesPaidThisMonth)}</li>
                <li><b>${TRANSLATIONS[lang]["ust-paid"]}</b> ${nf(d.ustDueDisplay)}</li>
                <li class="subtle"><b>Личные выплаты</b> ${nf(d.ownerDraw)}</li>
              </ul>
            </div>
          </div>
          <p class="font-bold mt-3">${TRANSLATIONS[lang]["analysis-net-cashflow"]} ${nf(d.netCashFlow)}</p>
          <p class="font-bold">${TRANSLATIONS[lang]["analysis-final-balance"]} ${nf(d.accumulatedBalance)}</p>
        </div>
      </div>
    </div>
  `;
}
function setLanguage(lang){
  document.documentElement.lang=lang;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    if(TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) el.textContent=TRANSLATIONS[lang][key];
  });
  // восстановить "Місяць (span)":
  document.querySelector('#month-slider') && (document.getElementById('slider-label-month').textContent=TRANSLATIONS[lang]["month-current"]+(parseInt(document.getElementById('month-slider').value)+1));
  document.getElementById('slider-label-analysis-month').textContent=TRANSLATIONS[lang]["month-current"]+(parseInt(document.getElementById('analysis-slider').value)+1);

  if(processedData.length){
    charts.cashFlow.data.datasets[0].label=TRANSLATIONS[lang]["chart-labels"]["cashFlow"];
    charts.revExp.data.datasets[0].label=TRANSLATIONS[lang]["chart-labels"]["revenue"];
    charts.revExp.data.datasets[1].label=TRANSLATIONS[lang]["chart-labels"]["expenses"];
    charts.sales.data.datasets[0].label=TRANSLATIONS[lang]["chart-labels"]["sales"];
    charts.cashFlow.update(); charts.revExp.update(); charts.sales.update();
    updateTable();
    const i=parseInt(document.getElementById('month-slider').value)||0;
    updateKpi(i); updateAnalysis(lang,i);
  }
}

/* ====== WIRING ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // построить 24 инпута продаж
  const grid=document.getElementById('sales-grid');
  const tpl=document.getElementById('sales-template').content;
  const defaultPlan=[1,1,2,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,10,10,10,10,10,10];
  for(let i=0;i<NUM_MONTHS;i++){
    const node=tpl.cloneNode(true);
    const label=node.querySelector('span');
    const input=node.querySelector('input');
    label.textContent=(document.documentElement.lang==='ru'?'Мес. ':'Міс. ')+ (i+1);
    input.id=`sales_${i}`; input.value=defaultPlan[i];
    grid.appendChild(node);
  }

  const recalc=()=>{
    processData();
    // уничтожить старые графики (если есть)
    Object.values(charts).forEach(ch=>{try{ch.destroy()}catch(_){}}); charts={};
    makeCharts();
    updateKpi(0); updateTable(); updateAnalysis(document.documentElement.lang,0);
    document.getElementById('month-slider').value=0;
    document.getElementById('analysis-slider').value=0;
  };

  document.getElementById('calculate-button').addEventListener('click', recalc);
  document.getElementById('month-slider').addEventListener('input', e=>{updateKpi(parseInt(e.target.value));});
  document.getElementById('analysis-slider').addEventListener('input', e=>{
    document.getElementById('slider-label-analysis-month').textContent=TRANSLATIONS[document.documentElement.lang]["month-current"]+(parseInt(e.target.value)+1);
    updateAnalysis(document.documentElement.lang, parseInt(e.target.value));
  });

  document.getElementById('taxForm').addEventListener('change', ()=>{
    const v=document.getElementById('taxForm').value;
    document.getElementById('gebesatz-label').style.display='block';
    document.getElementById('ustRegime').disabled=false;
    recalc();
  });
  document.getElementById('ustRegime').addEventListener('change', ()=>{
    const v=document.getElementById('ustRegime').value;
    document.getElementById('ust-frequency-block').style.display=(v==='kleinunternehmer')?'none':'block';
    recalc();
  });
  document.getElementById('ustFrequency').addEventListener('change', recalc);
  document.querySelectorAll('input[type="number"]').forEach(inp=>inp.addEventListener('change',recalc));

  // старт
  setLanguage('uk');
  recalc();
});
  </script>
</body>
</html>
