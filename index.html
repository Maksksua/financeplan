
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивний Планувальник Ліквідності (36 Місяців)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .input-group { background-color: #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .data-input { 
            border: 1px solid #d1d5db; 
            padding: 0.25rem; 
            font-size: 0.875rem; 
            border-radius: 0.25rem;
            text-align: center;
        }
        .data-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
        }
        .warning-text {
            color: #ef4444; /* Tailwind red-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Інтерактивна Таблиця Ліквідності (3 Роки)</h1>
            <p class="text-md text-gray-600 mt-2">Ви повністю контролюєте **Продажі**, **Закупівлі** та **Фіксовані Витрати**.</p>
        </header>

        <main>
            <!-- Input Data Section -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-lg font-semibold mb-4 text-blue-700">1. Ключові вхідні дані</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Фінансування та Постійні витрати</h4>
                        
                        <!-- СТАРТОВИЙ КАПІТАЛ - ТЕПЕР РЕДАГУЄТЬСЯ -->
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold">Стартовий Капітал (Грант, €):</span>
                            <input type="number" id="grant" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm font-bold">Власні Кошти/Заощадження (€):</span>
                            <input type="number" id="savings" value="5000" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>

                        <!-- НОВІ РЕДАГОВАНІ ВХІДНІ ДАНІ -->
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Цільовий Запас Авто (шт):</span>
                             <input type="number" id="targetInventory" value="10" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Щомісячні Особисті/Соц. Внески (€/міс):</span>
                             <input type="number" id="healthInsurance" value="400" class="mt-1 block w-full rounded-sm p-2">
                        </label>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Особисті Витрати на Життя (€/міс):</span>
                            <input type="number" id="personalCosts" value="1450" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <input type="hidden" id="rentDeposit" value="5000"> 
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Юніт-економіка (на 1 авто)</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Середня ціна продажу (БРУТТО, €):</span>
                            <input type="number" id="avgSalePrice" value="4500" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Ціна закупівлі (€):</span>
                            <input type="number" id="carPurchase" value="2300" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <label class="block mb-2"><span class="text-gray-700 text-sm">Витрати на підготовку (€):</span>
                            <input type="number" id="prepCosts" value="850" class="mt-1 block w-full rounded-md shadow-sm p-2">
                        </label>
                        <p class="text-sm mt-4 p-2 bg-yellow-100 rounded-md">Вартість 1 авто (закупка + підготовка) = <span id="costPerCarDisplay" class="font-bold"></span></p>
                    </div>

                    <div class="input-group">
                        <h4 class="font-semibold text-gray-800 mb-3">Податковий Режим</h4>
                         <label class="block mb-2"><span class="text-gray-700 text-sm">Режим ПДВ:</span>
                            <select id="ustRegime" class="mt-1 block w-full rounded-md shadow-sm p-2">
                                <option value="regular">Стандартний (Regelbesteuerung)</option>
                                <option value="margin">Differenzbesteuerung (§25a UStG)</option>
                                <option value="kleinunternehmer">Малий підприємець (§19 UStG)</option>
                            </select>
                        </label>
                        <p class="text-xs text-red-500 mt-4">Усі податки (GwSt, ESt) розраховуються на річній основі та сплачуються щоквартальними авансами.</p>
                        <button id="calculate-button" class="mt-4 w-full px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-md">Перерахувати</button>
                    </div>
                </div>
            </div>

            <!-- SALES PLAN (Integrated in the table/scrollable) -->
            <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
                <h3 class="p-0 font-semibold text-lg text-blue-700 mb-4">Детальний Фінансовий Звіт (36 місяців)</h3>
                <p class="text-sm text-gray-600 mb-4">Ви можете редагувати **Продажі**, **Куплено** та **Місячні Витрати** безпосередньо в таблиці.</p>
                <div class="overflow-x-auto">
                    <table id="dataTable" class="min-w-full text-sm text-left text-gray-500 border-collapse">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th scope="col" class="px-3 py-2">Міс.</th>
                                <th scope="col" class="px-3 py-2 w-20">Продажі (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20">Куплено (шт)</th>
                                <th scope="col" class="px-3 py-2 w-20">Оренда Місця (€)</th> <!-- НОВА КОЛОНКА -->
                                <th scope="col" class="px-3 py-2 w-20">Інші Пост. (€)</th> <!-- НОВА КОЛОНКА -->
                                <th scope="col" class="px-3 py-2">Запас</th>
                                <th scope="col" class="px-3 py-2 text-green-700">EBIT (Прибуток)</th>
                                <th scope="col" class="px-3 py-2 text-blue-700">Cash Flow (Чистий)</th>
                                <th scope="col" class="px-3 py-2 text-purple-700">Особистий CF</th>
                                <th scope="col" class="px-3 py-2 text-red-700">USt (Сплата)</th>
                                <th scope="col" class="px-3 py-2">GwSt</th>
                                <th scope="col" class="px-3 py-2">ESt</th>
                                <th scope="col" class="px-3 py-2 font-bold">Залишок (Подуш. безп.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const NUM_MONTHS = 36;
        const FREIBETRAG_GEWST = 24500; 
        const GRUNDFREIBETRAG_EST = 12096; 
        const UST_RATE = 0.19;
        const UST_SATZ = 19;
        const HEBESATZ = 467; 
        
        let processedData;
        
        function calculateESt(taxableIncome, gewStCredit = 0) {
            let tax = 0;
            if (taxableIncome < 0) return { tax: 0, finalTax: 0 };
            const Y = (taxableIncome - GRUNDFREIBETRAG_EST) / 10000;
            if (taxableIncome < GRUNDFREIBETRAG_EST) {
                tax = 0;
            } else if (taxableIncome <= 15999) {
                tax = (980.14 * Y + 1400) * Y;
            } else if (taxableIncome <= 62809) {
                tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
            } else if (taxableIncome <= 277825) {
                tax = 0.42 * taxableIncome - 9877.94;
            } else {
                tax = 0.45 * taxableIncome - 17316.5;
            }
            const finalTax = Math.max(0, tax - gewStCredit);
            return { tax: Math.max(0, tax), finalTax: finalTax };
        }

        function formatCurrency(value) {
            if (value === "TBD" || isNaN(value) || value === null) return "0.00 €";
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(value);
        }
        
        function getInputs() {
            const salesPlan = [];
            const purchasePlan = [];
            const rentPlan = []; // NEW
            const otherFixedPlan = []; // NEW
            
            // Collect data directly from the dynamic table inputs
            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesInput = document.getElementById(`salesPlan_${i}`);
                const purchaseInput = document.getElementById(`purchasePlan_${i}`);
                const rentInput = document.getElementById(`rentPlan_${i}`); 
                const otherFixedInput = document.getElementById(`otherFixedPlan_${i}`); 

                // Sales plan (user input)
                salesPlan.push(parseInt(salesInput?.value) || 0);
                
                // Purchase plan (user input)
                purchasePlan.push(parseInt(purchaseInput?.value) || 0);
                
                // Monthly Rent/Lease (NEW)
                rentPlan.push(parseFloat(rentInput?.value) || 0);
                
                // Other Fixed Monthly Costs (NEW)
                otherFixedPlan.push(parseFloat(otherFixedInput?.value) || 0);
            }
            
            // Collect editable inputs (now includes grant, savings, deposit, insurance)
            return {
                grant: parseFloat(document.getElementById('grant').value) || 0, 
                savings: parseFloat(document.getElementById('savings').value) || 0, 
                avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
                carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
                prepCosts: parseFloat(document.getElementById('prepCosts').value) || 0,
                healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0, 
                personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0, 
                ustRegime: document.getElementById('ustRegime').value,
                salesPlan: salesPlan,
                purchasePlan: purchasePlan,
                rentDeposit: parseFloat(document.getElementById('rentDeposit').value) || 0, 
                rentPlan: rentPlan, 
                otherFixedPlan: otherFixedPlan 
            };
        }
        
        function populateInitialSalesPlan() {
            // Generates initial default sales plan values for the first time
            const initialSalesPlan = [];
             for (let i = 0; i < NUM_MONTHS; i++) {
                // STARTING WITH A CONSERVATIVE, REALISTIC SCALING PLAN: 
                if (i < 2) {
                    initialSalesPlan.push(1);
                } else if (i < 6) {
                    initialSalesPlan.push(2);
                } else if (i < 12) {
                    initialSalesPlan.push(3);
                } else if (i < 24) {
                    initialSalesPlan.push(5);
                } else {
                    initialSalesPlan.push(8);
                }
            }
            return initialSalesPlan;
        }

        // NEW: Initial Rent Plan (e.g., M1-M36: 800 EUR)
        function populateInitialRentPlan() {
            return Array(NUM_MONTHS).fill(560); // Set default to 560 EUR
        }

        // NEW: Initial Other Fixed Costs Plan (e.g., M1-M36: 500 EUR)
        function populateInitialOtherFixedPlan() {
            return Array(NUM_MONTHS).fill(740); // 1300 (total fixed) - 560 (rent) = 740 EUR
        }

        // AUTO-GENERATING INITIAL PURCHASE PLAN based on selling constraints (buy what you need + 1 for stock)
        function generateInitialPurchasePlan(salesPlan) {
            const initialPurchasePlan = [];
            const carCost = 2300 + 850; // Purchase + Prep = 3150 EUR (Hardcoded default for initial plan)
            const rentDeposit = 5000; // Hardcoded default for initial plan
            const initialRent = 560; // New Default
            const initialOtherFixed = 740; // New Default
            const healthInsurance = 400; // Hardcoded default for initial plan
            const personalCosts = 1450; // Hardcoded default for initial plan
            const grant = 5000;
            const savings = 5000;
            
            // Fixed Monthly Operating Costs for M1 for initial calculation (Rent + Other + Personal + Insurance)
            const fixedOps = initialRent + initialOtherFixed + personalCosts + healthInsurance; 

            let cash = grant + savings; // Starting cash
            let inventory = 0; 

            for (let i = 0; i < NUM_MONTHS; i++) {
                const salesTarget = salesPlan[i];
                let carsToBuy = 0;
                
                // --- M1: CRITICAL STARTUP COSTS ---
                if (i === 0) {
                    // M1 cash outflow priority: Deposit (5000) + Fixed Ops (2750) 
                    const m1RequiredCash = rentDeposit + fixedOps; 
                    const availableForCars = cash - m1RequiredCash; // Cash remaining after all M1 fixed/deposit outflows
                    
                    const maxCarsICanAfford = Math.floor(availableForCars / carCost);
                    
                    // We want to buy targetInventory (10) minus current stock (0), but are limited by cash
                    const targetBuy = 10;
                    
                    carsToBuy = Math.min(targetBuy, maxCarsICanAfford); 
                    
                    if (carsToBuy < salesTarget) {
                        carsToBuy = salesTarget; // Must buy at least what we plan to sell
                    }
                    if (carsToBuy > maxCarsICanAfford) {
                         carsToBuy = maxCarsICanAfford; 
                    }
                    
                    // Update cash for the manual tracking
                    cash -= m1RequiredCash + (carsToBuy * carCost); 

                } else {
                    // --- M2 and onwards: REINVESTMENT LOGIC (Simplified) ---
                    
                    // Goal is to reach/maintain 10 cars
                    const currentDeficit = Math.max(0, 10 - inventory);
                    carsToBuy = currentDeficit;
                }
                
                // Update inventory for next loop
                inventory += carsToBuy - salesTarget;
                initialPurchasePlan.push(Math.max(0, carsToBuy));
            }
            
            return initialPurchasePlan;
        }


        function processData() {
            const inputs = getInputs();
            const data = [];
            const purchaseHasVAT = inputs.ustRegime === 'regular';
            
            let accumulatedCashBalance = inputs.grant + inputs.savings; // Starts with 10000
            let currentInventory = 0;
            let yearlyEbit = 0;
            let yearly_gew_ertrag = 0;
            let last_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0 };
            let ust_period_due = 0;
            
            for (let i = 0; i < NUM_MONTHS; i++) {
                const carsSold = inputs.salesPlan[i];
                const carsBought = inputs.purchasePlan[i];
                
                // Monthly Fixed Costs from the table inputs
                const rentCostMonthly = inputs.rentPlan[i]; 
                const otherFixedCostMonthly = inputs.otherFixedPlan[i]; 
                
                // --- P&L EXPENSE COMPONENTS (NO VAT) ---
                const totalFixedCostsPnl = rentCostMonthly + otherFixedCostMonthly; // Uses monthly table inputs
                const cogsPnl = carsSold * (inputs.carPurchase + inputs.prepCosts);
                let totalExpensesPnl = totalFixedCostsPnl + cogsPnl; 
                
                // --- CASH FLOW OUTFLOW COMPONENTS (WITH VAT) ---
                const costPerCarGross = inputs.carPurchase + inputs.prepCosts;
                const grossFactor = purchaseHasVAT ? 1 + UST_RATE : 1;

                const fixedCostsCashOutflow = (rentCostMonthly + otherFixedCostMonthly) * grossFactor; // Uses monthly table inputs
                const personalCashOutflow = inputs.healthInsurance + inputs.personalCosts; // Uses editable inputs
                const rentDepositCashOutflow = i === 0 ? inputs.rentDeposit * grossFactor : 0; // Uses editable deposit

                // Define cashNeededToOperate before use
                const cashNeededToOperate = fixedCostsCashOutflow + personalCashOutflow + rentDepositCashOutflow; 

                // --- P&L REVENUE & VAT CALCULATION ---
                let salesRevenueGross = carsSold * inputs.avgSalePrice;
                let salesRevenuePnl;
                let ustDue = 0;
                let ustVorsteuer = 0;

                if (inputs.ustRegime === 'regular') {
                    salesRevenuePnl = salesRevenueGross / (1 + UST_RATE);
                    ustDue = salesRevenueGross - salesRevenuePnl;
                    
                    ustVorsteuer = (totalFixedCostsPnl * UST_RATE) + (carsSold * inputs.prepCosts * UST_RATE) + (carsBought * inputs.carPurchase * UST_RATE);
                    
                } else if (inputs.ustRegime === 'margin') {
                    const margin = salesRevenueGross - (carsSold * inputs.carPurchase);
                    if (margin > 0) ustDue = margin * UST_SATZ / (100 + UST_SATZ);
                    salesRevenuePnl = salesRevenueGross - ustDue;
                    ustVorsteuer = 0;
                } else { // kleinunternehmer: P&L is Gross
                    salesRevenuePnl = salesRevenueGross;
                    ustDue = 0;
                    ustVorsteuer = 0;
                    totalExpensesPnl = totalFixedCostsPnl * grossFactor + cogsPnl * grossFactor;
                }

                // Final EBIT Calculation (Deposit is 1-time P&L hit in M1)
                const ebit = salesRevenuePnl - totalExpensesPnl - (i === 0 ? inputs.rentDeposit : 0); 

                // Update yearly totals BEFORE tax calculation logic
                yearlyEbit += ebit;
                yearly_gew_ertrag += ebit;

                // --- INVENTORY LOGIC (USER CONTROLLED) ---
                const carPurchaseCashOutflow = carsBought * costPerCarGross;
                currentInventory -= carsSold;
                currentInventory += carsBought;
                
                // Check for inventory warning
                const inventoryWarning = currentInventory < 0;

                // --- TAXES & CASH FLOW ---
                
                let ustCashFlowMovement = ustDue - ustVorsteuer;
                let ustPaidThisMonth = 0;
                let ustOutflowFinal = 0;

                if (inputs.ustRegime !== 'kleinunternehmer') {
                    ust_period_due += ustCashFlowMovement;
                    if ((i + 1) % 3 === 0) {
                        ustPaidThisMonth = ust_period_due;
                        ustOutflowFinal = ustPaidThisMonth;
                        ust_period_due = 0;
                    }
                }
                
                let current_yearly_tax_data = { ...last_yearly_tax_data };
                let taxesPaidThisMonth = 0;

                if ( (i + 1) % 12 === 0 || i === NUM_MONTHS - 1) {
                    let taxable_profit = yearlyEbit;
                    current_yearly_tax_data = { Gewerbesteuer: 0, Einkommensteuer: 0, total: 0, yearly_ebit: yearlyEbit };

                    if (taxable_profit > 0) {
                        // Health insurance is deductible from taxable income for ESt
                        let est_taxable_income = taxable_profit - (inputs.healthInsurance * 12); 
                        let est_tax = calculateESt(est_taxable_income).tax;
                        
                        let gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
                        let messbetrag = gewStTaxableBase * 0.035;
                        let gewSt = messbetrag * (HEBESATZ / 100); 
                        
                        let gewSt_credit = Math.min(est_tax, messbetrag * 3.8);
                        let est_final = Math.max(0, est_tax - gewSt_credit);

                        current_yearly_tax_data.Einkommensteuer = est_final;
                        current_yearly_tax_data.Gewerbesteuer = gewSt;
                        current_yearly_tax_data.total = est_final + gewSt;
                    }
                    yearlyEbit = 0;
                    yearly_gew_ertrag = 0;
                }
                
                if (last_yearly_tax_data.total > 0 && (i + 1) % 3 === 0) {
                    taxesPaidThisMonth = last_yearly_tax_data.total / 4;
                }
                
                // Final Cash Flow (totalCashOutflow MUST include the calculated taxes/purchases)
                const totalCashOutflow = cashNeededToOperate + carPurchaseCashOutflow + ustOutflowFinal + taxesPaidThisMonth;
                
                // FIX: Initial Cash Injection is the full 10k, but only once.
                const initialCashInjection = i === 0 ? inputs.grant + inputs.savings : 0;
                const netCashFlow = (salesRevenueGross + initialCashInjection) - totalCashOutflow;
                
                accumulatedCashBalance += netCashFlow;
                // FIX END
                

                data.push({
                    month: `Міс. ${i + 1}`,
                    carsSold: carsSold,
                    carsBought: carsBought,
                    rentCostMonthly: rentCostMonthly, // NEW
                    otherFixedCostMonthly: otherFixedCostMonthly, // NEW
                    currentInventory: currentInventory,
                    ebit: ebit,
                    netCashFlow: netCashFlow,
                    personalCashOutflow: personalCashOutflow,
                    ustPaidThisMonth: ustPaidThisMonth,
                    taxesPaidThisMonth: taxesPaidThisMonth,
                    accumulatedBalance: accumulatedCashBalance,
                    yearly_tax_data: current_yearly_tax_data,
                    inventoryWarning: inventoryWarning
                });
                last_yearly_tax_data = current_yearly_tax_data;
            }
            return data;
        }

        function recalculatePlan() {
            processedData = processData();
            updateDataTable();
            updateCostPerCarDisplay();
        }

        function updateCostPerCarDisplay() {
            const carPurchase = parseFloat(document.getElementById('carPurchase').value) || 0;
            const prepCosts = parseFloat(document.getElementById('prepCosts').value) || 0;
            const totalCost = carPurchase + prepCosts;
            document.getElementById('costPerCarDisplay').textContent = formatCurrency(totalCost);
        }
        
        function updateDataTable() {
            const tableBody = document.querySelector('#dataTable tbody');
            
            let bodyHtml = '';
            for(let i = 0; i < NUM_MONTHS; i++) {
                const data = processedData[i];
                const yearlyData = data.yearly_tax_data;

                const personalCf = -data.personalCashOutflow; 

                // Display annual tax totals in the final month of the year/period
                const gwst_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Gewerbesteuer) : 
                                 (data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(yearlyData.Gewerbesteuer) : '0.00 €');
                
                const est_val = (i + 1) % 12 === 0 || i === NUM_MONTHS - 1 ? formatCurrency(yearlyData.Einkommensteuer) :
                                (data.taxesPaidThisMonth > 0 && (i + 1) % 3 === 0 ? formatCurrency(yearlyData.Einkommensteuer) : '0.00 €');

                // Generate input fields for Sales and Purchase plans
                const salesInput = `<input type="number" id="salesPlan_${i}" value="${data.carsSold}" min="0" class="w-16 data-input">`;
                const purchaseInput = `<input type="number" id="purchasePlan_${i}" value="${data.carsBought}" min="0" class="w-16 data-input">`;
                const rentInput = `<input type="number" id="rentPlan_${i}" value="${data.rentCostMonthly}" min="0" class="w-20 data-input">`;
                const otherFixedInput = `<input type="number" id="otherFixedPlan_${i}" value="${data.otherFixedCostMonthly}" min="0" class="w-20 data-input">`;

                const inventoryClass = data.currentInventory < 0 ? 'warning-text' : '';

                bodyHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2">${salesInput}</td>
                    <td class="px-3 py-2">${purchaseInput}</td>
                    <td class="px-3 py-2">${rentInput}</td>
                    <td class="px-3 py-2">${otherFixedInput}</td>
                    <td class="px-3 py-2 ${inventoryClass}">${data.currentInventory}</td>
                    <td class="px-3 py-2 ${data.ebit < 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(data.ebit)}</td>
                    <td class="px-3 py-2 ${data.netCashFlow < 0 ? 'text-red-500' : ''}">${formatCurrency(data.netCashFlow)}</td>
                    <td class="px-3 py-2 text-purple-600">${formatCurrency(personalCf)}</td>
                    <td class="px-3 py-2">${formatCurrency(data.ustPaidThisMonth)}</td>
                    <td class="px-3 py-2">${gwst_val}</td>
                    <td class="px-3 py-2">${est_val}</td>
                    <td class="px-3 py-2 ${data.accumulatedBalance < 0 ? 'text-red-500' : 'font-bold'}">${formatCurrency(data.accumulatedBalance)}</td>
                </tr>`;
            }
            tableBody.innerHTML = bodyHtml;
            
            // Re-attach listeners to the new input fields in the table
            document.querySelectorAll('#dataTable input[type="number"]').forEach(input => {
                input.addEventListener('change', recalculatePlan);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial dummy data generation
            const initialSalesPlan = populateInitialSalesPlan();
            const initialPurchasePlan = generateInitialPurchasePlan(initialSalesPlan); 
            const initialRentPlan = populateInitialRentPlan();
            const initialOtherFixedPlan = populateInitialOtherFixedPlan();
            
            const tableBody = document.querySelector('#dataTable tbody');
            let initialHtml = '';
            initialSalesPlan.forEach((val, i) => {
                const initialPurchase = initialPurchasePlan[i]; 
                const initialRent = initialRentPlan[i];
                const initialOtherFixed = initialOtherFixedPlan[i];

                initialHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap">${i + 1}</td>
                    <td class="px-3 py-2"><input type="number" id="salesPlan_${i}" value="${val}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="purchasePlan_${i}" value="${initialPurchase}" min="0" class="w-16 data-input"></td>
                    <td class="px-3 py-2"><input type="number" id="rentPlan_${i}" value="${initialRent}" min="0" class="w-20 data-input"></td> 
                    <td class="px-3 py-2"><input type="number" id="otherFixedPlan_${i}" value="${initialOtherFixed}" min="0" class="w-20 data-input"></td> 
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            });
            tableBody.innerHTML = initialHtml;

            // Attach listeners to main inputs (outside the dynamic table)
            document.querySelectorAll('#grant, #savings, #rentDeposit, #healthInsurance, #personalCosts, #avgSalePrice, #carPurchase, #prepCosts, #ustRegime').forEach(input => { 
                input.addEventListener('change', recalculatePlan);
            });
            document.getElementById('calculate-button').addEventListener('click', recalculatePlan);

            // Initial calculation
            recalculatePlan();
        });
    </script>

</body>
</html>
