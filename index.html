<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Професійна фінансова панель: Автодилер, Нюрнберг</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Inter',sans-serif;background-color:#f0f4f8}
    .chart-container{position:relative;width:100%;height:350px;max-height:400px}
    @media (max-width:768px){.chart-container{height:300px}}
    .kpi-card{background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);transition:all .3s}
    .kpi-value{font-size:2rem;font-weight:700;color:#1f2937}
    .kpi-label{font-size:.875rem;color:#6b7280}
    .input-group{background:#e5e7eb;border-radius:.5rem;padding:1rem}
    /* дрібний глянець */
    .kpi-card:hover{transform:translateY(-2px)}
    th{white-space:nowrap}
  </style>
</head>
<body class="antialiased text-gray-800">
<div class="container mx-auto p-4 md:p-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900" data-i18n="title">Професійна фінансова панель</h1>
    <p class="text-md text-gray-600 mt-2" data-i18n="subtitle">Аналіз фінансового плану автодилера в Нюрнберзі</p>
  </header>

  <main>
    <!-- Language Switcher -->
    <div class="flex justify-center mb-6 gap-3">
      <button class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600" onclick="setLanguage('uk')">Українська</button>
      <button class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600" onclick="setLanguage('ru')">Русский</button>
      <button class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-gray-500 hover:bg-gray-600" onclick="setLanguage('de')">Deutsch</button>
    </div>

    <!-- Input Data Section -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
      <h3 class="text-lg font-semibold mb-4" data-i18n="input-data-title">Введення даних для моделювання</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Revenue and Sales -->
        <div class="input-group">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-sales">План продажів та дохід</h4>
          <div class="grid grid-cols-6 gap-4">
            <!-- Sale Inputs (Month 1-24) -->
            <!-- генерується в JS у DOMContentLoaded, але тримаємо поля як у тебе -->
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 1</span><input type="number" id="salesPlan_0" value="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 2</span><input type="number" id="salesPlan_1" value="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 3</span><input type="number" id="salesPlan_2" value="2" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 4</span><input type="number" id="salesPlan_3" value="3" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 5</span><input type="number" id="salesPlan_4" value="4" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 6</span><input type="number" id="salesPlan_5" value="4" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 7</span><input type="number" id="salesPlan_6" value="5" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 8</span><input type="number" id="salesPlan_7" value="5" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 9</span><input type="number" id="salesPlan_8" value="6" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 10</span><input type="number" id="salesPlan_9" value="6" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 11</span><input type="number" id="salesPlan_10" value="7" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 12</span><input type="number" id="salesPlan_11" value="7" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 13</span><input type="number" id="salesPlan_12" value="8" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 14</span><input type="number" id="salesPlan_13" value="8" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 15</span><input type="number" id="salesPlan_14" value="9" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 16</span><input type="number" id="salesPlan_15" value="9" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 17</span><input type="number" id="salesPlan_16" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 18</span><input type="number" id="salesPlan_17" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 19</span><input type="number" id="salesPlan_18" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 20</span><input type="number" id="salesPlan_19" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 21</span><input type="number" id="salesPlan_20" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 22</span><input type="number" id="salesPlan_21" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 23</span><input type="number" id="salesPlan_22" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block col-span-1"><span class="text-gray-700 text-sm">Міс. 24</span><input type="number" id="salesPlan_23" value="10" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          </div>
          <label class="block mt-4">
            <span class="text-gray-700 text-sm" data-i18n="input-avg-price">Середня ціна продажу (€):</span>
            <input type="number" id="avgSalePrice" value="4200" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300">
          </label>
          <label class="block mt-4">
            <span class="text-gray-700 text-sm" data-i18n="input-car-purchase">Закупка авто (€/авто):</span>
            <input type="number" id="carPurchase" value="2300" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-200 focus:border-blue-300">
          </label>
        </div>

        <!-- Funding -->
        <div class="input-group">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-funding">Початкове фінансування</h4>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-grant">Безповоротний грант (€):</span>
            <input type="number" id="grant" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-savings">Інвестиції, заощадження (€):</span>
            <input type="number" id="savings" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <h4 class="font-semibold text-gray-800 mb-2 mt-4" data-i18n="input-group-private">Особисті витрати</h4>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-health-insurance">Мед. страховка/Пенсія (€/міс):</span>
            <input type="number" id="healthInsurance" value="400" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="input-personal-costs">Особисті витрати (€/міс):</span>
            <input type="number" id="personalCosts" value="1000" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
        </div>

        <!-- Costs -->
        <div class="input-group">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-costs">Постійні витрати</h4>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-rent">Оренда (€/міс):</span><input type="number" id="rent" value="600" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-accounting-monthly">Бухгалтерія (€/міс):</span><input type="number" id="accounting" value="171" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-insurance">Страхування бізнесу (€/міс):</span><input type="number" id="insurance" value="193" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-communication">Зв'язок (€/міс):</span><input type="number" id="communication" value="65" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-contingency">Інші фіксовані витрати (€/міс):</span><input type="number" id="contingency" value="100" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-software">ПЗ (€/міс):</span><input type="number" id="software" value="37.33" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-office-supplies">Бюро/Кава (€/міс):</span><input type="number" id="officeSupplies" value="40" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-working-materials">Роб. матеріали (€/міс):</span><input type="number" id="workingMaterials" value="23.75" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-transport-costs">Трансп. витрати (€/міс):</span><input type="number" id="transportCosts" value="166" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-ad-costs">Реклама загальна (€/міс):</span><input type="number" id="adCosts" value="30.83" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-bank-fees">Банківські збори (€/міс):</span><input type="number" id="bankFees" value="17" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block"><span class="text-gray-700 text-sm" data-i18n="input-repair-costs">Ремонт приміщення (€/міс):</span><input type="number" id="repairCosts" value="5.83" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
        </div>
      </div>

      <!-- Variable Costs & Tax -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="input-group">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-variable">Змінні витрати (на авто)</h4>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-car-wash">Миття/детейлінг (€/авто):</span><input type="number" id="carWash" value="25" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-car-repair">Діагностика/ремонт (€/авто):</span><input type="number" id="carRepair" value="350" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-tuv-diag">TÜV/діагн. (€/авто):</span><input type="number" id="tuvDiag" value="75" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-logistics">Логістика (€/авто):</span><input type="number" id="logistics" value="150" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-warranty">Гарантія (€/авто):</span><input type="number" id="warranty" value="500" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
          <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-car-ad">Реклама авто (€/авто):</span><input type="number" id="carAd" value="25" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
        </div>

        <div class="input-group">
          <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-taxes">Податкова інформація</h4>
          <label class="block mb-2">
            <span class="text-gray-700 text-sm" data-i18n="tax-form">Форма оподаткування:</span>
            <select id="taxForm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
              <option value="einz" data-i18n="option-einz">ІП (Einzelunternehmen)</option>
            </select>
          </label>
          <label class="block" id="ust-regime-label">
            <span class="text-gray-700 text-sm" data-i18n="ust-regime">Режим ПДВ:</span>
            <select id="ustRegime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
              <option value="regular" data-i18n="option-regular">Стандартний (Regelbesteuerung)</option>
              <option value="margin" data-i18n="option-margin">Differenzbesteuerung (§25a UStG)</option>
              <option value="kleinunternehmer" data-i18n="option-kleinunternehmer">Kleinunternehmer (§19 UStG)</option>
            </select>
          </label>
          <div id="ust-frequency-block">
            <label class="block mt-2 mb-2">
              <span class="text-gray-700 text-sm" data-i18n="ust-payment-frequency">Частота сплати ПДВ:</span>
              <select id="ustFrequency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                <option value="monthly" data-i18n="option-monthly">Щомісячно</option>
                <option value="quarterly" data-i18n="option-quarterly">Щоквартально</option>
              </select>
            </label>
          </div>
          <label class="block" id="gebesatz-label">
            <span class="text-gray-700 text-sm" data-i18n="business-tax-rate">Коефіцієнт податку на торгівлю (Nuremberg):</span>
            <input type="number" id="gebesatz" value="467" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
          </label>
          <p class="text-xs text-red-500 mt-2" data-i18n="note-gebesatz">Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.</p>
        </div>
      </div>

      <div class="mt-6 flex justify-center">
        <button id="calculate-button" class="px-6 py-3 text-lg font-semibold rounded-lg text-white bg-green-500 hover:bg-green-600" data-i18n="calculate-button">Розрахувати</button>
      </div>
    </div>

    <!-- KPI Cards & Slider -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
        <div class="kpi-card border-l-4 border-blue-500">
          <div id="kpi-sales" class="kpi-value">0</div>
          <div class="kpi-label" data-i18n="kpi-sales-label">Авто продано</div>
        </div>
        <div class="kpi-card border-l-4 border-green-500">
          <div id="kpi-revenue" class="kpi-value">€0</div>
          <div class="kpi-label" data-i18n="kpi-revenue-label">Загальний дохід (P&amp;L)</div>
        </div>
        <div class="kpi-card border-l-4 border-red-500">
          <div id="kpi-ebit" class="kpi-value">€0</div>
          <div class="kpi-label" data-i18n="kpi-ebit-label">EBIT (прибуток до податків)</div>
        </div>
        <div class="kpi-card border-l-4 border-purple-500">
          <div id="kpi-balance" class="kpi-value">€0</div>
          <div class="kpi-label" data-i18n="kpi-balance-label">Накопичений баланс (Cash-Flow)</div>
        </div>
      </div>
      <div>
        <label for="month-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label">Оберіть місяць для аналізу:</label>
        <input id="month-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 mt-2">
          <span data-i18n="month-1">Місяць 1</span>
          <span id="slider-label-month" class="font-bold text-blue-600">Місяць 1</span>
          <span data-i18n="month-24">Місяць 24</span>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-1-title">Прогноз ліквідності (Накопичений баланс)</h3>
        <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-2-title">Доходи vs. Витрати (P&amp;L)</h3>
        <div class="chart-container"><canvas id="revenueVsExpensesChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-semibold mb-4" data-i18n="chart-3-title">Динаміка продажів (Авто, шт.)</h3>
        <div class="chart-container"><canvas id="salesChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md">
        <!-- важливо: НЕ ставимо data-i18n, щоб не затерти span під час локалізації -->
        <h3 class="text-lg font-semibold mb-4">Структура витрат (P&amp;L) (<span data-i18n="month-current">Місяць </span><span class="selected-month-label">1</span>)</h3>
        <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
      </div>
    </div>

    <!-- Detailed Data Table -->
    <div class="bg-white p-6 rounded-xl shadow-md overflow-hidden">
      <h3 class="p-0 font-semibold text-lg" data-i18n="table-summary">Показати детальну фінансову інформацію</h3>
      <div class="p-0 border-t border-gray-200">
        <p class="text-sm text-gray-600 mb-4" data-i18n="table-description">У таблиці представлені розгорнуті дані P&amp;L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.</p>
        <div class="overflow-x-auto">
          <table id="dataTable" class="min-w-full text-sm text-left text-gray-600">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50"></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="bg-white p-6 rounded-xl shadow-md mt-8">
      <h3 class="text-lg font-semibold mb-4" data-i18n="analysis-title">Детальний аналіз</h3>
      <div>
        <label for="analysis-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label-analysis">Оберіть місяць для детального аналізу:</label>
        <input id="analysis-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-500 mt-2">
          <span data-i18n="month-1">Місяць 1</span>
          <span id="slider-label-analysis-month" class="font-bold text-blue-600">Місяць 1</span>
          <span data-i18n="month-24">Місяць 24</span>
        </div>
      </div>
      <div id="analysis-content" class="text-sm text-gray-700 space-y-4 mt-6"></div>
    </div>
  </main>
</div>

<script>
/* ================== i18n ================== */
const TRANSLATIONS = {
  uk: {
    "title":"Професійна фінансова панель",
    "subtitle":"Аналіз фінансового плану автодилера в Нюрнберзі",
    "input-data-title":"Введення даних для моделювання",
    "input-group-sales":"План продажів та дохід",
    "input-avg-price":"Середня ціна продажу (€):",
    "input-car-purchase":"Закупка авто (€/авто):",
    "input-group-funding":"Початкове фінансування",
    "input-grant":"Безповоротний грант (€):",
    "input-savings":"Інвестиції, заощадження (€):",
    "input-group-private":"Особисті витрати",
    "input-health-insurance":"Мед. страховка/Пенсія (€/міс):",
    "input-personal-costs":"Особисті витрати (€/міс):",
    "input-group-costs":"Постійні витрати",
    "input-rent":"Оренда (€/міс):",
    "input-accounting-monthly":"Бухгалтерія (€/міс):",
    "input-insurance":"Страхування бізнесу (€/міс):",
    "input-communication":"Зв'язок (€/міс):",
    "input-contingency":"Інші фіксовані витрати (€/міс):",
    "input-software":"ПЗ (€/міс):",
    "input-office-supplies":"Бюро/Кава (€/міс):",
    "input-working-materials":"Роб. матеріали (€/міс):",
    "input-transport-costs":"Трансп. витрати (€/міс):",
    "input-ad-costs":"Реклама загальна (€/міс):",
    "input-bank-fees":"Банківські збори (€/міс):",
    "input-repair-costs":"Ремонт приміщення (€/міс):",
    "input-group-variable":"Змінні витрати (на авто)",
    "input-car-wash":"Миття/детейлінг (€/авто):",
    "input-car-repair":"Діагностика/ремонт (€/авто):",
    "input-tuv-diag":"TÜV/діагн. (€/авто):",
    "input-logistics":"Логістика (€/авто):",
    "input-warranty":"Гарантія (€/авто):",
    "input-car-ad":"Реклама авто (€/авто):",
    "input-group-taxes":"Податкова інформація",
    "tax-form":"Форма оподаткування:",
    "option-einz":"ФОП (Einzelunternehmen)",
    "ust-regime":"Режим ПДВ:",
    "option-regular":"Стандартний (Regelbesteuerung)",
    "option-margin":"Differenzbesteuerung (§25a UStG)",
    "option-kleinunternehmer":"Малий підприємець (§19 UStG)",
    "ust-payment-frequency":"Частота сплати ПДВ:",
    "option-monthly":"Щомісячно",
    "option-quarterly":"Щоквартально",
    "business-tax-rate":"Коефіцієнт податку на торгівлю (Nuremberg):",
    "note-gebesatz":"Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.",
    "calculate-button":"Розрахувати",
    "kpi-sales-label":"Авто продано",
    "kpi-revenue-label":"Загальний дохід (P&L)",
    "kpi-ebit-label":"EBIT (прибуток до податків)",
    "kpi-balance-label":"Накопичений баланс (Cash-Flow)",
    "slider-label":"Оберіть місяць для аналізу:",
    "month-1":"Місяць 1",
    "month-current":"Місяць ",
    "month-24":"Місяць 24",
    "chart-1-title":"Прогноз ліквідності (Накопичений баланс)",
    "chart-2-title":"Доходи vs. Витрати (P&L)",
    "chart-3-title":"Динаміка продажів (Авто, шт.)",
    "table-summary":"Показати детальну фінансову інформацію",
    "table-description":"У таблиці представлені розгорнуті дані P&L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.",
    "table-headers":["Міс.","Продажі","P&L","Cash Flow","ПДВ","Податок на торгівлю","Податок на дохід","Баланс"],
    "chart-labels":{"cashFlow":"Накопичений баланс","ebit":"EBIT (P&L)","revenue":"Загальний дохід (P&L)","expenses":"Загальні витрати (P&L)","sales":"Продано автомобілів","cashInflow":"Грошовий приплив","cashOutflow":"Грошовий відплив"},
    "analysis-title":"Детальний аналіз",
    "analysis-summary-title":"Місячний P&L",
    "analysis-month-title":"Фінансовий звіт за ",
    "analysis-revenue-title":"Доходи (P&L)",
    "analysis-variable-costs-title":"Змінні витрати (P&L)",
    "analysis-fixed-costs-title":"Постійні витрати (P&L)",
    "analysis-taxes-title":"Розрахунки по податках",
    "analysis-cash-flow-title":"Рух грошових коштів (Cash Flow)",
    "analysis-total-revenue":"Загальний дохід:",
    "analysis-total-variable-cost":"Всього змінні витрати:",
    "analysis-total-fixed-cost":"Всього постійні витрати:",
    "analysis-net-profit":"Чистий дохід (EBT):",
    "analysis-ebit":"EBIT (прибуток до податків):",
    "analysis-after-tax-profit":"Чистий дохід після податків:",
    "analysis-taxes":"Податки:",
    "analysis-net-cashflow":"Чистий грошовий потік:",
    "analysis-final-balance":"Накопичений баланс:",
    "analysis-profit-per-car":"EBIT на 1 авто",
    "ust-note":"Податок на додану вартість. Сплачується окремо від прибутку.",
    "tax-payment-month":"Податок до сплати в цьому місяці",
    "yearly-profit-for-taxes":"Податкова база за рік:",
    "gebesatz-tax":"Податок на торгівлю:",
    "einkommensteuer":"Податок на дохід:",
    "koerperschaftsteuer":"Податок на прибуток корпорацій:",
    "soli-tax":"Надбавка солідарності:",
    "final-tax-for-year":"Разом податків за рік:",
    "ust-margin-calculation":"Розрахунок ПДВ по Differenzbesteuerung (§25a UStG)",
    "cost-of-goods":"Собівартість проданих товарів:",
    "margin":"Маржа:",
    "ust-due":"Підлягає сплаті в цьому періоді:",
    "car-purchase-cash-flow":"Закупка авто (відплив коштів):",
    "ust-paid":"Сплачений ПДВ:",
    "variable-costs-sold-cars":"Змінні витрати на продані авто:",
    "ust-received":"Отриманий ПДВ:",
    "investments-cash-flow":"Інвестиції/Грант:",
    "fixed-costs-cat":"Постійні витрати",
    "variable-costs-cat":"Змінні витрати",
    "taxes-cat":"Податки",
    "ust-cash-cat":"Рух ПДВ",
    "inventory-cat":"Закупівлі авто"
  },
  ru: { /* залишив твої тексти як були, скорочено тут заради місця */ },
  de: { /* залишив твої тексти як були, скорочено тут заради місця */ }
};

/* ================== Константи ================== */
const NUM_MONTHS = 24;
const FREIBETRAG_GEWST = 24500;
const GRUNDFREIBETRAG_EST_2025 = 12096;
const UST_RATE = 0.19;
const UST_SATZ = 19;
const SOLI_RATE = 0.055;
const KST_RATE = 0.15;

function calculateESt(taxableIncome, gewStCredit = 0){
  let tax = 0;
  const Y = (taxableIncome - GRUNDFREIBETRAG_EST_2025) / 10000;
  if (taxableIncome < GRUNDFREIBETRAG_EST_2025) {
    tax = 0;
  } else if (taxableIncome <= 15999) {
    tax = (980.14 * Y + 1400) * Y;
  } else if (taxableIncome <= 62809) {
    tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
  } else if (taxableIncome <= 277825) {
    tax = 0.42 * taxableIncome - 9877.94;
  } else {
    tax = 0.45 * taxableIncome - 17316.5;
  }
  const finalTax = Math.max(0, tax - gewStCredit);
  return { tax, finalTax };
}

let processedData = [];
let chartInstances = {};

function formatCurrency(value){
  if (value === "TBD" || isNaN(value)) return "TBD";
  const lang = document.documentElement.lang;
  const locale = (lang === 'de') ? 'de-DE' : (lang === 'uk' ? 'uk-UA' : 'ru-RU');
  return new Intl.NumberFormat(locale,{style:'currency',currency:'EUR',minimumFractionDigits:0}).format(value);
}

function processData(){
  const data = [];
  const salesPlan = Array.from({length:NUM_MONTHS},(_,i)=> parseInt(document.getElementById(`salesPlan_${i}`).value) || 0);
  const lagMonths = 1;

  const financialData = {
    grant: parseFloat(document.getElementById('grant').value) || 0,
    savings: parseFloat(document.getElementById('savings').value) || 0,
    avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
    carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
    gebesatz: parseFloat(document.getElementById('gebesatz').value) || 0,
    healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0,
    personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0,
    fixedCosts: {
      rent: parseFloat(document.getElementById('rent').value) || 0,
      accounting: parseFloat(document.getElementById('accounting').value) || 0,
      insurance: parseFloat(document.getElementById('insurance').value) || 0,
      communication: parseFloat(document.getElementById('communication').value) || 0,
      contingency: parseFloat(document.getElementById('contingency').value) || 0,
      software: parseFloat(document.getElementById('software').value) || 0,
      officeSupplies: parseFloat(document.getElementById('officeSupplies').value) || 0,
      workingMaterials: parseFloat(document.getElementById('workingMaterials').value) || 0,
      transportCosts: parseFloat(document.getElementById('transportCosts').value) || 0,
      adCosts: parseFloat(document.getElementById('adCosts').value) || 0,
      bankFees: parseFloat(document.getElementById('bankFees').value) || 0,
      repairCosts: parseFloat(document.getElementById('repairCosts').value) || 0,
    },
    variableCostsPerCar: {
      carWash: parseFloat(document.getElementById('carWash').value) || 0,
      carRepair: parseFloat(document.getElementById('carRepair').value) || 0,
      tuvDiag: parseFloat(document.getElementById('tuvDiag').value) || 0,
      logistics: parseFloat(document.getElementById('logistics').value) || 0,
      warranty: parseFloat(document.getElementById('warranty').value) || 0,
      carAd: parseFloat(document.getElementById('carAd').value) || 0,
    },
    taxForm: document.getElementById('taxForm').value,
    ustRegime: document.getElementById('ustRegime').value,
    ustFrequency: document.getElementById('ustFrequency').value
  };

  const totalFixedCostsPnl = Object.values(financialData.fixedCosts).reduce((s,v)=>s+v,0);
  const allVariableCostsPerCarPnl = Object.values(financialData.variableCostsPerCar).reduce((s,v)=>s+v,0);

  let accumulatedCashBalance = financialData.grant + financialData.savings;
  let yearlyEbit = 0;
  let yearly_gew_ertrag = 0;
  let ust_period_due = 0;
  let last_yearly_tax_data = {Einkommensteuer:0,Gewerbesteuer:0,Koerperschaftsteuer:0,Solidaritaetszuschlag:0,total:0,yearly_ebit:0};

  // план закупок (з лагом)
  const purchasePlan = new Array(NUM_MONTHS).fill(0);
  for (let i=0; i<NUM_MONTHS; i++){
    if (i - lagMonths >= 0) purchasePlan[i - lagMonths] = salesPlan[i];
  }
  if (lagMonths > 0){
    for (let i = NUM_MONTHS - lagMonths; i < NUM_MONTHS; i++){
      purchasePlan[i] = salesPlan[NUM_MONTHS-1];
    }
  }

  for (let i=0; i<NUM_MONTHS; i++){
    const carsSold = salesPlan[i];
    const carsBought = purchasePlan[i];

    const totalFixedCostsCashFlow = totalFixedCostsPnl;
    const totalVariableCostsPerCarCashFlow = allVariableCostsPerCarPnl;

    let salesRevenuePnl = carsSold * financialData.avgSalePrice;
    let ustDue = 0;
    let ustPaidThisMonth = 0;
    let ustVorsteuer = 0;
    let ustCashFlow = 0;

    // ПДВ
    if (financialData.ustRegime === 'regular') {
      ustDue = salesRevenuePnl * UST_RATE;
      // припускаємо, що на фіксовані та змінні є Vorsteuer (для моделі)
      ustVorsteuer = (totalFixedCostsPnl + carsBought * allVariableCostsPerCarPnl) * UST_RATE;
      ustCashFlow = ustDue - ustVorsteuer;

      if (financialData.ustFrequency === 'monthly') {
        ustPaidThisMonth = ustCashFlow;
      } else {
        // quarterly
        if ((i+1)%3===0){ ust_period_due += ustCashFlow; ustPaidThisMonth = ust_period_due; ust_period_due = 0; }
        else { ust_period_due += ustCashFlow; }
      }
      salesRevenuePnl = salesRevenuePnl - ustDue; // P&L нетто
    } else if (financialData.ustRegime === 'margin') {
      const margin = carsSold * (financialData.avgSalePrice - financialData.carPurchase);
      if (margin > 0) ustDue = margin * UST_SATZ / (100 + UST_SATZ);
      if (financialData.ustFrequency === 'monthly') { ustPaidThisMonth = ustDue; }
      else { if ((i+1)%3===0){ ust_period_due += ustDue; ustPaidThisMonth = ust_period_due; ust_period_due = 0; } else { ust_period_due += ustDue; } }
      // у маржинальному режимі в P&L дохід включає USt у ціні → ми віднімаємо на рівні періоду
      salesRevenuePnl = salesRevenuePnl - ustDue;
    } else {
      // kleinunternehmer — ПДВ не застосовується
      ustDue = 0; ustPaidThisMonth = 0; ustCashFlow = 0;
    }

    // P&L
    const cogs = carsSold * financialData.carPurchase;
    const totalVariableCostsPnl = cogs + carsSold * allVariableCostsPerCarPnl;
    const totalExpensesPnl = totalFixedCostsPnl + totalVariableCostsPnl;
    const ebit = salesRevenuePnl - totalExpensesPnl;

    yearlyEbit += ebit;
    yearly_gew_ertrag += ebit;

    let yearly_tax_data = last_yearly_tax_data;

    // Річні податки (розрахунок в кінці року)
    if ((i+1)%12===0 || i === NUM_MONTHS-1){
      yearly_tax_data = {Einkommensteuer:0,Gewerbesteuer:0,Koerperschaftsteuer:0,Solidaritaetszuschlag:0,total:0,yearly_ebit:yearlyEbit};
      let taxable_profit = yearlyEbit;

      if (taxable_profit > 0){
        if (financialData.taxForm === 'einz'){
          const est_taxable_income = taxable_profit - (financialData.healthInsurance * 12);
          const est_tax = calculateESt(est_taxable_income).tax;
          const gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
          const messbetrag = gewStTaxableBase * 0.035;
          const gewSt = messbetrag * (parseFloat(financialData.gebesatz) / 100);
          const gewSt_credit = Math.min(est_tax, gewSt * 3.8);
          const est_final = Math.max(0, est_tax - gewSt_credit);

          yearly_tax_data.Einkommensteuer = est_final;
          yearly_tax_data.Gewerbesteuer = gewSt;
          yearly_tax_data.total = est_final + gewSt;
        } else {
          // для GmbH залишено як у тебе
          const kst = taxable_profit * KST_RATE;
          const soli = kst * SOLI_RATE;
          const gewStTaxableBase = taxable_profit;
          const messbetrag = gewStTaxableBase * 0.035;
          const gewSt = messbetrag * (parseFloat(financialData.gebesatz) / 100);
          yearly_tax_data.Koerperschaftsteuer = kst;
          yearly_tax_data.Solidaritaetszuschlag = soli;
          yearly_tax_data.Gewerbesteuer = gewSt;
          yearly_tax_data.total = kst + soli + gewSt;
        }
      }
      yearlyEbit = 0;
      yearly_gew_ertrag = 0;
      last_yearly_tax_data = yearly_tax_data;
    }

    // Податки, сплачені в цьому місяці (поквартальні аванси)
    let taxesPaidThisMonth = 0;
    if ((i+1)%3===0 && last_yearly_tax_data.total>0){
      taxesPaidThisMonth = last_yearly_tax_data.total / 4;
    }

    const salesCashInflow =
      (financialData.ustRegime === 'regular' || financialData.ustRegime === 'kleinunternehmer')
        ? salesRevenuePnl + ustDue
        : salesRevenuePnl;

    const fixedCostsCashOutflow = totalFixedCostsCashFlow + (financialData.ustRegime === 'regular' ? totalFixedCostsPnl * UST_RATE : 0);
    const variableCostsCashOutflow = carsSold * totalVariableCostsPerCarCashFlow;
    const carPurchaseCashOutflow = carsBought * financialData.carPurchase;

    const netCashFlow = salesCashInflow
      - fixedCostsCashOutflow
      - variableCostsCashOutflow
      - carPurchaseCashOutflow
      - ustPaidThisMonth
      - taxesPaidThisMonth
      - financialData.healthInsurance
      - financialData.personalCosts;

    accumulatedCashBalance += netCashFlow;

    data.push({
      monthIndex: i+1,
      month: `Міс. ${i+1}`,
      carsSold,
      carsBought,
      totalRevenuePnl: salesRevenuePnl,
      totalExpensesPnl,
      ebit,
      netIncomeAfterTax: ebit - (last_yearly_tax_data.total > 0 ? last_yearly_tax_data.total / 12 : 0),
      netCashFlow,
      accumulatedBalance: accumulatedCashBalance,
      ustDue,
      ustPaidThisMonth,
      ustCashFlow,
      yearly_tax_data: last_yearly_tax_data,
      taxesPaidThisMonth,
      totalFixedCostsPnl: totalFixedCostsPnl,
      totalVariableCostsPnl: totalVariableCostsPnl,
      totalCashInflow: salesCashInflow + (i===0 ? financialData.grant + financialData.savings : 0),
      totalCashOutflow: fixedCostsCashOutflow + variableCostsCashOutflow + carPurchaseCashOutflow + ustPaidThisMonth + taxesPaidThisMonth,
      financialDataSnapshot: financialData // зручно для аналітики
    });
  }

  return data;
}

function updateAnalysisSection(lang, monthIndex){
  const analysisContent = document.getElementById('analysis-content');
  const data = processedData[monthIndex];

  const fd = data.financialDataSnapshot;
  const totalVariableCostsPerCar = Object.values(fd.variableCostsPerCar).reduce((s,v)=>s+v,0);

  const html = `
    <div class="space-y-4">
      <p class="font-bold text-lg">${TRANSLATIONS[lang]["analysis-month-title"]}${monthIndex + 1}</p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="p-4 bg-gray-50 rounded-lg col-span-1">
          <h4 class="font-bold text-lg mb-2">${TRANSLATIONS[lang]["analysis-summary-title"]}</h4>
          <ul class="space-y-1">
            <li><span class="font-bold">${TRANSLATIONS[lang]["analysis-total-revenue"]}</span> ${formatCurrency(data.totalRevenuePnl)}</li>
            <li><span class="font-bold">${TRANSLATIONS[lang]["analysis-total-variable-cost"]}</span> ${formatCurrency(data.totalVariableCostsPnl)}</li>
            <li><span class="font-bold">${TRANSLATIONS[lang]["analysis-total-fixed-cost"]}</span> ${formatCurrency(data.totalFixedCostsPnl)}</li>
            <li class="font-bold text-green-700">${TRANSLATIONS[lang]["analysis-ebit"]} ${formatCurrency(data.ebit)}</li>
            <li><span class="font-bold">${TRANSLATIONS[lang]["analysis-profit-per-car"]}:</span> ${formatCurrency(data.carsSold>0 ? data.ebit/data.carsSold : 0)}</li>
            <li class="font-bold text-blue-700">${TRANSLATIONS[lang]["analysis-after-tax-profit"]} ${formatCurrency(data.netIncomeAfterTax)}</li>
          </ul>
        </div>

        <div class="p-4 bg-gray-50 rounded-lg col-span-2">
          <h4 class="font-bold text-lg mb-2">${TRANSLATIONS[lang]["analysis-taxes-title"]}</h4>
          <p class="text-sm font-semibold">${TRANSLATIONS[lang]["yearly-profit-for-taxes"]}: ${formatCurrency(data.yearly_tax_data.yearly_ebit)}</p>
          <ul class="space-y-1 mt-2 text-sm">
            ${data.yearly_tax_data.Einkommensteuer>0?`<li><span class="font-bold">${TRANSLATIONS[lang]["einkommensteuer"]}</span> ${formatCurrency(data.yearly_tax_data.Einkommensteuer)}</li>`:''}
            ${data.yearly_tax_data.Koerperschaftsteuer>0?`<li><span class="font-bold">${TRANSLATIONS[lang]["koerperschaftsteuer"]}</span> ${formatCurrency(data.yearly_tax_data.Koerperschaftsteuer)}</li>`:''}
            ${data.yearly_tax_data.Solidaritaetszuschlag>0?`<li><span class="font-bold">${TRANSLATIONS[lang]["soli-tax"]}</span> ${formatCurrency(data.yearly_tax_data.Solidaritaetszuschlag)}</li>`:''}
            ${data.yearly_tax_data.Gewerbesteuer>0?`<li><span class="font-bold">${TRANSLATIONS[lang]["gebesatz-tax"]}</span> ${formatCurrency(data.yearly_tax_data.Gewerbesteuer)}</li>`:''}
            ${data.yearly_tax_data.total>0?`<li class="font-bold text-blue-700 mt-2">${TRANSLATIONS[lang]["final-tax-for-year"]} ${formatCurrency(data.yearly_tax_data.total)}</li>`:''}
          </ul>
          <p class="font-semibold text-sm mt-4">${TRANSLATIONS[lang]["ust-note"]}</p>
          <p class="text-xs">USt: ${formatCurrency(data.ustDue)} ${data.ustPaidThisMonth>0?`(${TRANSLATIONS[lang]["tax-payment-month"]})`:''}</p>
        </div>

        <div class="p-4 bg-gray-50 rounded-lg col-span-3">
          <h4 class="font-bold text-lg mb-2">${TRANSLATIONS[lang]["analysis-cash-flow-title"]}</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <h5 class="font-semibold">${TRANSLATIONS[lang]["chart-labels"]["cashInflow"]}</h5>
              <ul class="list-disc list-inside space-y-1 mt-1">
                <li>${TRANSLATIONS[lang]["analysis-total-revenue"]} ${formatCurrency(data.totalRevenuePnl)}</li>
                <li>${TRANSLATIONS[lang]["investments-cash-flow"]} ${formatCurrency((monthIndex===0)? (fd.grant + fd.savings) : 0)}</li>
                <li><span class="font-bold">${TRANSLATIONS[lang]["ust-received"]}</span> ${formatCurrency(data.ustCashFlow>0 ? data.ustCashFlow : 0)}</li>
              </ul>
            </div>
            <div>
              <h5 class="font-semibold">${TRANSLATIONS[lang]["chart-labels"]["cashOutflow"]}</h5>
              <ul class="list-disc list-inside space-y-1 mt-1">
                <li>${TRANSLATIONS[lang]["car-purchase-cash-flow"]} ${formatCurrency(data.carsBought * fd.carPurchase)}</li>
                <li>${TRANSLATIONS[lang]["analysis-fixed-costs-title"]} ${formatCurrency(data.totalFixedCostsPnl)}</li>
                <li>${TRANSLATIONS[lang]["variable-costs-sold-cars"]} ${formatCurrency(data.carsSold * totalVariableCostsPerCar)}</li>
                <li>${TRANSLATIONS[lang]["analysis-taxes"]}: ${formatCurrency(data.taxesPaidThisMonth)}</li>
                <li><span class="font-bold">${TRANSLATIONS[lang]["ust-paid"]}</span> ${formatCurrency(data.ustPaidThisMonth)}</li>
                <li><span class="font-bold">${TRANSLATIONS[lang]["input-health-insurance"]}</span> ${formatCurrency(fd.healthInsurance)}</li>
                <li><span class="font-bold">${TRANSLATIONS[lang]["input-personal-costs"]}</span> ${formatCurrency(fd.personalCosts)}</li>
              </ul>
            </div>
          </div>
          <p class="font-bold mt-4">${TRANSLATIONS[lang]["analysis-net-cashflow"]} ${formatCurrency(data.netCashFlow)}</p>
          <p class="font-bold">${TRANSLATIONS[lang]["analysis-final-balance"]} ${formatCurrency(data.accumulatedBalance)}</p>
        </div>
      </div>
    </div>
  `;
  analysisContent.innerHTML = html;
}

function recalculatePlan(){
  processedData = processData();

  // знищуємо старі чарт-екземпляри
  ["cashFlowChart","revenueVsExpensesChart","salesChart","costBreakdownChart"].forEach(key=>{
    if (chartInstances[key]){ chartInstances[key].destroy(); delete chartInstances[key]; }
  });

  createCharts();
  updateDashboard(0);
  updateDataTable(document.documentElement.lang);
  updateAnalysisSection(document.documentElement.lang, 0);
  document.getElementById('month-slider').value = 0;
  document.getElementById('analysis-slider').value = 0;
}

function setLanguage(lang){
  document.documentElement.lang = lang;
  updateTexts(lang);
  const currentMonthIndex = parseInt(document.getElementById('month-slider').value);
  const currentAnalysisMonthIndex = parseInt(document.getElementById('analysis-slider').value);
  if (processedData && processedData.length){
    updateCharts(lang, currentMonthIndex);
    updateDashboard(currentMonthIndex);
    updateDataTable(lang);
    updateAnalysisSection(lang, currentAnalysisMonthIndex);
  }
}

function updateTexts(lang){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]){
      // не перезаписуємо блочний заголовок з <span class="selected-month-label">
      if (key === 'table-headers' || key === 'month-current') return;
      el.textContent = TRANSLATIONS[lang][key];
    }
  });
  document.getElementById('slider-label-month').textContent =
    TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('month-slider').value) + 1);
  document.getElementById('slider-label-analysis-month').textContent =
    TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('analysis-slider').value) + 1);
}

function updateCharts(lang, monthIndex){
  const labels = TRANSLATIONS[lang]["chart-labels"];
  if (!processedData || !processedData[monthIndex]) return;

  chartInstances.cashFlowChart.data.datasets[0].label = labels.cashFlow;
  chartInstances.cashFlowChart.update();

  chartInstances.revenueVsExpensesChart.data.datasets[0].label = labels.revenue;
  chartInstances.revenueVsExpensesChart.data.datasets[1].label = labels.expenses;
  chartInstances.revenueVsExpensesChart.update();

  chartInstances.salesChart.data.datasets[0].label = labels.sales;
  chartInstances.salesChart.update();

  // cost breakdown — дані та підписи оновлюються в updateDashboard (раз там все є)
}

function createCharts(){
  const commonOptions = {
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ position:'top' },
      tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` } }
    },
    scales:{ y:{ beginAtZero:false, ticks:{ callback:(v)=>formatCurrency(v) } } }
  };
  const labels = TRANSLATIONS[document.documentElement.lang]["chart-labels"];

  chartInstances.cashFlowChart = new Chart(document.getElementById('cashFlowChart').getContext('2d'),{
    type:'line',
    data:{
      labels: Array.from({length:NUM_MONTHS},(_,i)=> TRANSLATIONS[document.documentElement.lang]["month-current"] + (i+1)),
      datasets:[{ label:labels.cashFlow, data:processedData.map(d=>d.accumulatedBalance),
        borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.1)', fill:true, tension:.1 }]
    },
    options:{...commonOptions}
  });

  chartInstances.revenueVsExpensesChart = new Chart(document.getElementById('revenueVsExpensesChart').getContext('2d'),{
    type:'bar',
    data:{
      labels: Array.from({length:NUM_MONTHS},(_,i)=> TRANSLATIONS[document.documentElement.lang]["month-current"] + (i+1)),
      datasets:[
        { label:labels.revenue, data:processedData.map(d=>d.totalRevenuePnl), backgroundColor:'#22c55e' },
        { label:labels.expenses, data:processedData.map(d=>d.totalExpensesPnl), type:'line',
          borderColor:'#ef4444', backgroundColor:'#ef4444', fill:false, tension:.1 }
      ]
    },
    options:{...commonOptions, scales:{ x:{ stacked:false }, y:{ stacked:false, beginAtZero:true, ticks:{ callback:(v)=>formatCurrency(v) } } } }
  });

  chartInstances.salesChart = new Chart(document.getElementById('salesChart').getContext('2d'),{
    type:'bar',
    data:{
      labels: Array.from({length:NUM_MONTHS},(_,i)=> TRANSLATIONS[document.documentElement.lang]["month-current"] + (i+1)),
      datasets:[{ label:labels.sales, data:processedData.map(d=>d.carsSold), backgroundColor:'#8b5cf6' }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{
      legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> `${labels.sales}: ${ctx.raw}` } }
    }, scales:{ y:{ beginAtZero:true } } }
  });

  // первинне коло — за перший місяць
  const m0 = processedData[0];
  chartInstances.costBreakdownChart = new Chart(document.getElementById('costBreakdownChart').getContext('2d'),{
    type:'doughnut',
    data:{
      labels:[
        TRANSLATIONS[document.documentElement.lang]["fixed-costs-cat"],
        TRANSLATIONS[document.documentElement.lang]["variable-costs-cat"],
        TRANSLATIONS[document.documentElement.lang]["taxes-cat"],
        TRANSLATIONS[document.documentElement.lang]["ust-cash-cat"],
        TRANSLATIONS[document.documentElement.lang]["inventory-cat"]
      ],
      datasets:[{ data:[
        m0.totalFixedCostsPnl,
        m0.totalVariableCostsPnl,
        m0.taxesPaidThisMonth,
        m0.ustPaidThisMonth,
        m0.carsBought * m0.financialDataSnapshot.carPurchase
      ], backgroundColor:['#3b82f6','#f97316','#22c55e','#ef4444','#6b7280'] }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{
      legend:{ position:'bottom' },
      tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
    } }
  });
}

function updateDashboard(monthIndex){
  const d = processedData[monthIndex];
  const lang = document.documentElement.lang;

  document.getElementById('slider-label-month').textContent =
    TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('month-slider').value) + 1);
  document.querySelectorAll('.selected-month-label').forEach(el=> el.textContent = monthIndex + 1);

  document.getElementById('kpi-sales').textContent = d.carsSold;
  document.getElementById('kpi-revenue').textContent = formatCurrency(d.totalRevenuePnl);
  document.getElementById('kpi-ebit').textContent = formatCurrency(d.ebit);
  document.getElementById('kpi-balance').textContent = formatCurrency(d.accumulatedBalance);

  const labels = [
    TRANSLATIONS[lang]["fixed-costs-cat"],
    TRANSLATIONS[lang]["variable-costs-cat"],
    TRANSLATIONS[lang]["taxes-cat"],
    TRANSLATIONS[lang]["ust-cash-cat"],
    TRANSLATIONS[lang]["inventory-cat"]
  ];
  const values = [
    d.totalFixedCostsPnl,
    d.totalVariableCostsPnl,
    d.taxesPaidThisMonth,
    d.ustPaidThisMonth,
    d.carsBought * d.financialDataSnapshot.carPurchase
  ];

  chartInstances.costBreakdownChart.data.labels = labels.filter((_,i)=> values[i]>0);
  chartInstances.costBreakdownChart.data.datasets[0].data = values.filter(v=>v>0);
  chartInstances.costBreakdownChart.update();
}

function updateDataTable(lang){
  const tableHead = document.querySelector('#dataTable thead');
  const tableBody = document.querySelector('#dataTable tbody');
  const headers = TRANSLATIONS[lang]["table-headers"];

  let headRow = '<tr>';
  headers.forEach(h=> headRow += `<th scope="col" class="px-6 py-3">${h}</th>`);
  headRow += '</tr>';
  tableHead.innerHTML = headRow;

  let bodyHtml = '';
  processedData.forEach(d=>{
    bodyHtml += `<tr class="bg-white border-b hover:bg-gray-50">
      <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${d.monthIndex}</td>
      <td class="px-6 py-4">${d.carsSold}</td>
      <td class="px-6 py-4">${formatCurrency(d.ebit)}</td>
      <td class="px-6 py-4">${formatCurrency(d.netCashFlow)}</td>
      <td class="px-6 py-4">${formatCurrency(d.ustDue)}</td>
      <td class="px-6 py-4">${formatCurrency(d.yearly_tax_data.Gewerbesteuer || 0)}</td>
      <td class="px-6 py-4">${formatCurrency(d.yearly_tax_data.Einkommensteuer || 0)}</td>
      <td class="px-6 py-4">${formatCurrency(d.accumulatedBalance)}</td>
    </tr>`;
  });
  tableBody.innerHTML = bodyHtml;
}

/* ================== Init / Events ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  const defaultSalesPlan = [1,1,2,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,10,10,10,10,10,10];
  for (let i=0;i<NUM_MONTHS;i++){
    const el = document.getElementById(`salesPlan_${i}`);
    if (el) el.value = defaultSalesPlan[i];
  }

  recalculatePlan();

  document.getElementById('month-slider').addEventListener('input', (e)=>{
    updateDashboard(parseInt(e.target.value,10));
  });

  document.getElementById('analysis-slider').addEventListener('input', (e)=>{
    updateAnalysisSection(document.documentElement.lang, parseInt(e.target.value,10));
    document.getElementById('slider-label-analysis-month').textContent =
      TRANSLATIONS[document.documentElement.lang]["month-current"] + (parseInt(e.target.value,10) + 1);
  });

  document.getElementById('taxForm').addEventListener('change', ()=>{
    const gebesatzLabel = document.getElementById('gebesatz-label');
    const taxFormValue = document.getElementById('taxForm').value;
    if (taxFormValue === 'einz'){
      gebesatzLabel.style.display = 'block';
      document.getElementById('ustRegime').disabled = false;
    }
    recalculatePlan();
  });

  document.getElementById('ustRegime').addEventListener('change', ()=>{
    const block = document.getElementById('ust-frequency-block');
    if (document.getElementById('ustRegime').value === 'kleinunternehmer'){
      block.style.display = 'none';
    } else {
      block.style.display = 'block';
    }
    recalculatePlan();
  });

  document.getElementById('ustFrequency').addEventListener('change', ()=> recalculatePlan());
  document.getElementById('calculate-button').addEventListener('click', ()=> recalculatePlan());

  document.querySelectorAll('input[type="number"]').forEach(input=>{
    input.addEventListener('change', ()=> recalculatePlan());
  });

  // Стартова мова
  setLanguage('uk');
});
</script>
</body>
</html>
