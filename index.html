<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Професійна фінансова панель: Автодилер, Нюрнберг</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --brand:#2563eb; --ok:#16a34a; --bad:#ef4444; --ink:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f0f4f8; }
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background-color:var(--bg)}
    .chart-container{position:relative;width:100%;height:360px}
    @media (max-width:768px){.chart-container{height:300px}}
    .kpi-card{background:var(--card);border-radius:0.9rem;padding:1.25rem;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .kpi-value{font-size:2rem;font-weight:800;color:var(--ink)}
    .kpi-label{font-size:.875rem;color:var(--muted)}
    .input-group{background:#eef2f7;border-radius:0.75rem;padding:1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:var(--ok);color:#fff}
    .btn-primary:hover{background:#15803d}
    .btn-lang{background:var(--brand);color:#fff}
    .btn-lang:hover{background:#1d4ed8}
    .card{background:#fff;border-radius:1rem;padding:1.25rem;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .table th{white-space:nowrap}
  </style>
</head>
<body class="antialiased text-gray-800">
  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900" data-i18n="title">Професійна фінансова панель</h1>
      <p class="text-md text-gray-600 mt-2" data-i18n="subtitle">Аналіз фінансового плану автодилера в Нюрнберзі</p>
    </header>

    <main>
      <!-- Language Switcher -->
      <div class="flex justify-center mb-6 gap-3">
        <button class="btn btn-lang" onclick="setLanguage('uk')">Українська</button>
        <button class="btn btn-lang" onclick="setLanguage('ru')">Русский</button>
        <button class="btn btn-lang" onclick="setLanguage('de')">Deutsch</button>
      </div>

      <!-- Input Data -->
      <div class="card mb-8">
        <h3 class="text-lg font-semibold mb-4" data-i18n="input-data-title">Введення даних для моделювання</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Sales -->
          <div class="input-group">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-sales">План продажів та дохід</h4>
            <div class="grid grid-cols-6 gap-3">
              <!-- 1..24 -->
              <script>
                // цей скрипт тільки створює 24 інпута компактно
                document.currentScript.insertAdjacentHTML('afterend',
                  Array.from({length:24},(_,i)=>`
                    <label class="block col-span-1">
                      <span class="text-gray-700 text-sm">Міс. ${i+1}</span>
                      <input type="number" id="salesPlan_${i}" min="0"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"/>
                    </label>
                  `).join(''));
              </script>
            </div>

            <label class="block mt-4">
              <span class="text-gray-700 text-sm" data-i18n="input-avg-price">Середня ціна продажу (€):</span>
              <input type="number" id="avgSalePrice" value="4200" min="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>
            <label class="block mt-4">
              <span class="text-gray-700 text-sm" data-i18n="input-car-purchase">Закупка авто (€/авто):</span>
              <input type="number" id="carPurchase" value="2300" min="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>
          </div>

          <!-- Funding -->
          <div class="input-group">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-funding">Початкове фінансування</h4>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="input-grant">Безповоротний грант (€):</span>
              <input type="number" id="grant" min="0" placeholder="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="input-savings">Інвестиції, заощадження (€):</span>
              <input type="number" id="savings" min="0" placeholder="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>

            <h4 class="font-semibold text-gray-800 mb-2 mt-4" data-i18n="input-group-private">Особисті витрати</h4>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="input-health-insurance">Мед. страховка/Пенсія (€/міс):</span>
              <input type="number" id="healthInsurance" value="400" min="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="input-personal-costs">Особисті витрати (€/міс):</span>
              <input type="number" id="personalCosts" value="1000" min="0"
                     class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </label>
          </div>

          <!-- Fixed costs -->
          <div class="input-group">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-costs">Постійні витрати</h4>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-rent">Оренда (€/міс):</span>
              <input type="number" id="rent" value="600" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-accounting-monthly">Бухгалтерія (€/міс):</span>
              <input type="number" id="accounting" value="171" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-insurance">Страхування бізнесу (€/міс):</span>
              <input type="number" id="insurance" value="193" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-communication">Зв'язок (€/міс):</span>
              <input type="number" id="communication" value="65" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-contingency">Інші фіксовані витрати (€/міс):</span>
              <input type="number" id="contingency" value="100" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-software">ПЗ (€/міс):</span>
              <input type="number" id="software" value="37.33" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-office-supplies">Бюро/Кава (€/міс):</span>
              <input type="number" id="officeSupplies" value="40" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-working-materials">Роб. матеріали (€/міс):</span>
              <input type="number" id="workingMaterials" value="23.75" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-transport-costs">Трансп. витрати (€/міс):</span>
              <input type="number" id="transportCosts" value="166" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-ad-costs">Реклама загальна (€/міс):</span>
              <input type="number" id="adCosts" value="30.83" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-bank-fees">Банківські збори (€/міс):</span>
              <input type="number" id="bankFees" value="17" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block"><span class="text-gray-700 text-sm" data-i18n="input-repair-costs">Ремонт приміщення (€/міс):</span>
              <input type="number" id="repairCosts" value="5.83" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
          </div>
        </div>

        <!-- Variable Costs & Tax -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
          <div class="input-group">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-variable">Змінні витрати (на авто)</h4>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-car-wash">Миття/детейлінг (€/авто):</span>
              <input type="number" id="carWash" value="25" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-car-repair">Діагностика/ремонт (€/авто):</span>
              <input type="number" id="carRepair" value="350" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-tuv-diag">TÜV/діагн. (€/авто):</span>
              <input type="number" id="tuvDiag" value="75" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-logistics">Логістика (€/авто):</span>
              <input type="number" id="logistics" value="150" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block mb-2"><span class="text-gray-700 text-sm" data-i18n="input-warranty">Гарантія (€/авто):</span>
              <input type="number" id="warranty" value="500" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
            <label class="block"><span class="text-gray-700 text-sm" data-i18n="input-car-ad">Реклама авто (€/авто):</span>
              <input type="number" id="carAd" value="25" min="0" class="mt-1 block w-full rounded-md border-gray-300"></label>
          </div>

          <div class="input-group">
            <h4 class="font-semibold text-gray-800 mb-2" data-i18n="input-group-taxes">Податкова інформація</h4>
            <label class="block mb-2">
              <span class="text-gray-700 text-sm" data-i18n="tax-form">Форма оподаткування:</span>
              <select id="taxForm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300">
                <option value="einz" data-i18n="option-einz">ФОП (Einzelunternehmen)</option>
              </select>
            </label>
            <label class="block" id="ust-regime-label">
              <span class="text-gray-700 text-sm" data-i18n="ust-regime">Режим ПДВ:</span>
              <select id="ustRegime" class="mt-1 block w-full rounded-md border-gray-300">
                <option value="regular" data-i18n="option-regular">Стандартний (Regelbesteuerung)</option>
                <option value="margin" data-i18n="option-margin">Differenzbesteuerung (§25a UStG)</option>
                <option value="kleinunternehmer" data-i18n="option-kleinunternehmer">Kleinunternehmer (§19 UStG)</option>
              </select>
            </label>
            <div id="ust-frequency-block">
              <label class="block mt-2 mb-2">
                <span class="text-gray-700 text-sm" data-i18n="ust-payment-frequency">Частота сплати ПДВ:</span>
                <select id="ustFrequency" class="mt-1 block w-full rounded-md border-gray-300">
                  <option value="monthly" data-i18n="option-monthly">Щомісячно</option>
                  <option value="quarterly" data-i18n="option-quarterly">Щоквартально</option>
                </select>
              </label>
            </div>
            <label class="block" id="gebesatz-label">
              <span class="text-gray-700 text-sm" data-i18n="business-tax-rate">Коефіцієнт податку на торгівлю (Nuremberg):</span>
              <input type="number" id="gebesatz" value="467" min="0"
                     class="mt-1 block w-full rounded-md border-gray-300">
            </label>
            <p class="text-xs text-red-500 mt-2" data-i18n="note-gebesatz">Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.</p>
          </div>
        </div>

        <div class="mt-6 flex justify-center">
          <button id="calculate-button" class="btn btn-primary" data-i18n="calculate-button">Розрахувати</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="card mb-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
          <div class="kpi-card border-l-4 border-blue-500">
            <div id="kpi-sales" class="kpi-value">0</div>
            <div class="kpi-label" data-i18n="kpi-sales-label">Авто продано</div>
          </div>
          <div class="kpi-card border-l-4 border-green-500">
            <div id="kpi-revenue" class="kpi-value">€0</div>
            <div class="kpi-label" data-i18n="kpi-revenue-label">Загальний дохід (P&L)</div>
          </div>
          <div class="kpi-card border-l-4 border-red-500">
            <div id="kpi-ebit" class="kpi-value">€0</div>
            <div class="kpi-label" data-i18n="kpi-ebit-label">EBIT (прибуток до податків)</div>
          </div>
          <div class="kpi-card border-l-4 border-purple-500">
            <div id="kpi-balance" class="kpi-value">€0</div>
            <div class="kpi-label" data-i18n="kpi-balance-label">Накопичений баланс (Cash-Flow)</div>
          </div>
        </div>

        <div>
          <label for="month-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label">Оберіть місяць для аналізу:</label>
          <input id="month-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
          <div class="flex justify-between text-xs text-gray-500 mt-2">
            <span data-i18n="month-1">Місяць 1</span>
            <span id="slider-label-month" class="font-bold text-blue-600">Місяць 1</span>
            <span data-i18n="month-24">Місяць 24</span>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4" data-i18n="chart-1-title">Прогноз ліквідності (Накопичений баланс)</h3>
          <div class="chart-container"><canvas id="cashFlowChart"></canvas></div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-4" data-i18n="chart-2-title">Доходи vs. Витрати (P&L)</h3>
          <div class="chart-container"><canvas id="revenueVsExpensesChart"></canvas></div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-4" data-i18n="chart-3-title">Динаміка продажів (Авто, шт.)</h3>
          <div class="chart-container"><canvas id="salesChart"></canvas></div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-4">
            <span data-i18n="chart-4-title">Структура витрат (P&L) (Місяць </span><span class="selected-month-label">1</span>)
          </h3>
          <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
        </div>
      </div>

      <!-- Table -->
      <div class="card overflow-hidden">
        <h3 class="p-0 font-semibold text-lg" data-i18n="table-summary">Показати детальну фінансову інформацію</h3>
        <div class="p-0 border-t border-gray-200">
          <p class="text-sm text-gray-600 mb-4" data-i18n="table-description">У таблиці представлені розгорнуті дані P&L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.</p>
          <div class="overflow-x-auto">
            <table id="dataTable" class="table min-w-full text-sm text-left text-gray-600">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50"></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Detailed Analysis -->
      <div class="card mt-8">
        <h3 class="text-lg font-semibold mb-4" data-i18n="analysis-title">Детальний аналіз</h3>
        <div>
          <label for="analysis-slider" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="slider-label-analysis">Оберіть місяць для детального аналізу:</label>
          <input id="analysis-slider" type="range" min="0" max="23" value="0" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer">
          <div class="flex justify-between text-xs text-gray-500 mt-2">
            <span data-i18n="month-1">Місяць 1</span>
            <span id="slider-label-analysis-month" class="font-bold text-blue-600">Місяць 1</span>
            <span data-i18n="month-24">Місяць 24</span>
          </div>
        </div>
        <div id="analysis-content" class="text-sm text-gray-700 space-y-4 mt-6"></div>
      </div>
    </main>
  </div>

  <script>
    const TRANSLATIONS = {
      uk: {
        "title":"Професійна фінансова панель","subtitle":"Аналіз фінансового плану автодилера в Нюрнберзі",
        "input-data-title":"Введення даних для моделювання","input-group-sales":"План продажів та дохід",
        "input-avg-price":"Середня ціна продажу (€):","input-car-purchase":"Закупка авто (€/авто):",
        "input-group-funding":"Початкове фінансування","input-grant":"Безповоротний грант (€):",
        "input-savings":"Інвестиції, заощадження (€):","input-group-private":"Особисті витрати",
        "input-health-insurance":"Мед. страховка/Пенсія (€/міс):","input-personal-costs":"Особисті витрати (€/міс):",
        "input-group-costs":"Постійні витрати","input-rent":"Оренда (€/міс):","input-accounting-monthly":"Бухгалтерія (€/міс):",
        "input-insurance":"Страхування бізнесу (€/міс):","input-communication":"Зв'язок (€/міс):","input-contingency":"Інші фіксовані витрати (€/міс):",
        "input-software":"ПЗ (€/міс):","input-office-supplies":"Бюро/Кава (€/міс):","input-working-materials":"Роб. матеріали (€/міс):",
        "input-transport-costs":"Трансп. витрати (€/міс):","input-ad-costs":"Реклама загальна (€/міс):",
        "input-bank-fees":"Банківські збори (€/міс):","input-repair-costs":"Ремонт приміщення (€/міс):",
        "input-group-variable":"Змінні витрати (на авто)","input-car-wash":"Миття/детейлінг (€/авто):",
        "input-car-repair":"Діагностика/ремонт (€/авто):","input-tuv-diag":"TÜV/діагн. (€/авто):","input-logistics":"Логістика (€/авто):",
        "input-warranty":"Гарантія (€/авто):","input-car-ad":"Реклама авто (€/авто):",
        "input-group-taxes":"Податкова інформація","tax-form":"Форма оподаткування:","option-einz":"ФОП (Einzelunternehmen)",
        "ust-regime":"Режим ПДВ:","option-regular":"Стандартний (Regelbesteuerung)","option-margin":"Differenzbesteuerung (§25a UStG)","option-kleinunternehmer":"Малий підприємець (§19 UStG)",
        "ust-payment-frequency":"Частота сплати ПДВ:","option-monthly":"Щомісячно","option-quarterly":"Щоквартально",
        "business-tax-rate":"Коефіцієнт податку на торгівлю (Nuremberg):","note-gebesatz":"Офіційний Hebesatz для Нюрнберга - 467% з 2018 року.",
        "calculate-button":"Розрахувати",
        "kpi-sales-label":"Авто продано","kpi-revenue-label":"Загальний дохід (P&L)","kpi-ebit-label":"EBIT (прибуток до податків)","kpi-balance-label":"Накопичений баланс (Cash-Flow)",
        "slider-label":"Оберіть місяць для аналізу:","month-1":"Місяць 1","month-current":"Місяць ","month-24":"Місяць 24",
        "chart-1-title":"Прогноз ліквідності (Накопичений баланс)","chart-2-title":"Доходи vs. Витрати (P&L)","chart-3-title":"Динаміка продажів (Авто, шт.)","chart-4-title":"Структура витрат (P&L) (Місяць",
        "table-summary":"Показати детальну фінансову інформацію","table-description":"У таблиці представлені розгорнуті дані P&L та Cash Flow. Це дозволяє провести детальний аналіз фінансового плану.",
        "table-headers":["Міс.","Продажі","P&L","Cash Flow","ПДВ","Податок на торгівлю","Податок на дохід","Баланс"],
        "chart-labels":{"cashFlow":"Накопичений баланс","ebit":"EBIT (P&L)","revenue":"Загальний дохід (P&L)","expenses":"Загальні витрати (P&L)","sales":"Продано автомобілів","cashInflow":"Грошовий приплив","cashOutflow":"Грошовий відплив"},
        "analysis-title":"Детальний аналіз","analysis-summary-title":"Місячний P&L","analysis-month-title":"Фінансовий звіт за ",
        "analysis-revenue-title":"Доходи (P&L)","analysis-variable-costs-title":"Змінні витрати (P&L)","analysis-fixed-costs-title":"Постійні витрати (P&L)","analysis-taxes-title":"Розрахунки по податках","analysis-cash-flow-title":"Рух грошових коштів (Cash Flow)",
        "analysis-total-revenue":"Загальний дохід:","analysis-total-variable-cost":"Всього змінні витрати:","analysis-total-fixed-cost":"Всього постійні витрати:","analysis-net-profit":"Чистий дохід (EBT):",
        "analysis-ebit":"EBIT (прибуток до податків):","analysis-after-tax-profit":"Чистий дохід після податків:","analysis-taxes":"Податки:","analysis-net-cashflow":"Чистий грошовий потік:",
        "analysis-final-balance":"Накопичений баланс:","analysis-profit-per-car":"EBIT на 1 авто","pnl-note":"Прибуток/збиток до сплати податків (EBT).","ust-note":"Податок на додану вартість. Сплачується окремо від прибутку.",
        "tax-payment-month":"Податок до сплати в цьому місяці","no-tax-payment":"У цьому місяці сплата податків не передбачена.","cash-balance-before-taxes":"Баланс до сплати податків","yearly-profit-for-taxes":"Податкова база за рік:",
        "gebesatz-tax":"Податок на торгівлю:","einkommensteuer":"Податок на дохід:","koerperschaftsteuer":"Податок на прибуток корпорацій:","soli-tax":"Надбавка солідарності:","tax-credit":"Кредит податку на торгівлю по §35 EStG:","final-tax-for-year":"Разом податків за рік:","tax-paid-this-month":"Сплачено в цьому місяці:",
        "ust-margin-calculation":"Розрахунок ПДВ по Differenzbesteuerung (§25a UStG)","cost-of-goods":"Собівартість проданих товарів:","margin":"Маржа:","ust-due":"Підлягає сплаті в цьому періоді:",
        "car-purchase-cash-flow":"Закупка авто (відплив коштів):","ust-paid":"Сплачений ПДВ:","variable-costs-sold-cars":"Змінні витрати на продані авто:","ust-received":"Отриманий ПДВ:","investments-cash-flow":"Інвестиції/Грант:",
        "fixed-costs-cat":"Постійні витрати","variable-costs-cat":"Змінні витрати","taxes-cat":"Податки","ust-cash-cat":"Рух ПДВ","inventory-cat":"Закупівлі авто"
      },
      ru:{...TRANSLATIONS?.ru}, de:{...TRANSLATIONS?.de}
    };

    const NUM_MONTHS = 24;
    const FREIBETRAG_GEWST = 24500;
    const GRUNDFREIBETRAG_EST_2025 = 12096;
    const UST_RATE = 0.19;
    const UST_SATZ = 19;
    const SOLI_RATE = 0.055;
    const KST_RATE = 0.15;

    function calculateESt(taxableIncome, gewStCredit = 0) {
      let tax = 0;
      const Y = (taxableIncome - GRUNDFREIBETRAG_EST_2025) / 10000;
      if (taxableIncome < GRUNDFREIBETRAG_EST_2025) tax = 0;
      else if (taxableIncome <= 15999) tax = (980.14 * Y + 1400) * Y;
      else if (taxableIncome <= 62809) tax = (212.02 * (Y - 1.5) + 2397) * (Y - 1.5) + 1400;
      else if (taxableIncome <= 277825) tax = 0.42 * taxableIncome - 9877.94;
      else tax = 0.45 * taxableIncome - 17316.5;
      const finalTax = Math.max(0, tax - gewStCredit);
      return { tax, finalTax };
    }

    let processedData;
    let chartInstances = {};
    function formatCurrency(value){
      if (value === "TBD" || isNaN(value)) return "0 EUR";
      const lang = document.documentElement.lang === 'de' ? 'de-DE' : 'uk-UA';
      return new Intl.NumberFormat(lang,{style:'currency',currency:'EUR',minimumFractionDigits:2}).format(value);
    }

    function processData(){
      const data = [];
      const salesPlan = Array.from({length:NUM_MONTHS},(_,i)=>parseInt(document.getElementById(`salesPlan_${i}`).value)||0);
      const lagMonths = 1;

      const financialData = {
        grant: parseFloat(document.getElementById('grant').value) || 0,
        savings: parseFloat(document.getElementById('savings').value) || 0,
        avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
        carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
        gebesatz: parseFloat(document.getElementById('gebesatz').value) || 0,
        healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0,
        personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0,
        fixedCosts: {
          rent: parseFloat(document.getElementById('rent').value) || 0,
          accounting: parseFloat(document.getElementById('accounting').value) || 0,
          insurance: parseFloat(document.getElementById('insurance').value) || 0,
          communication: parseFloat(document.getElementById('communication').value) || 0,
          contingency: parseFloat(document.getElementById('contingency').value) || 0,
          software: parseFloat(document.getElementById('software').value) || 0,
          officeSupplies: parseFloat(document.getElementById('officeSupplies').value) || 0,
          workingMaterials: parseFloat(document.getElementById('workingMaterials').value) || 0,
          transportCosts: parseFloat(document.getElementById('transportCosts').value) || 0,
          adCosts: parseFloat(document.getElementById('adCosts').value) || 0,
          bankFees: parseFloat(document.getElementById('bankFees').value) || 0,
          repairCosts: parseFloat(document.getElementById('repairCosts').value) || 0,
        },
        variableCostsPerCar: {
          carWash: parseFloat(document.getElementById('carWash').value) || 0,
          carRepair: parseFloat(document.getElementById('carRepair').value) || 0,
          tuvDiag: parseFloat(document.getElementById('tuvDiag').value) || 0,
          logistics: parseFloat(document.getElementById('logistics').value) || 0,
          warranty: parseFloat(document.getElementById('warranty').value) || 0,
          carAd: parseFloat(document.getElementById('carAd').value) || 0,
        },
        taxForm: document.getElementById('taxForm').value,
        ustRegime: document.getElementById('ustRegime').value,
        ustFrequency: document.getElementById('ustFrequency').value
      };

      const totalFixedCostsPnl = Object.values(financialData.fixedCosts).reduce((s,v)=>s+v,0);
      const allVariableCostsPerCarPnl = Object.values(financialData.variableCostsPerCar).reduce((s,v)=>s+v,0);

      let accumulatedCashBalance = financialData.grant + financialData.savings;
      let yearlyEbit = 0;
      let yearly_gew_ertrag = 0;
      let ust_period_due = 0;
      let last_yearly_tax_data = {Einkommensteuer:0,Gewerbesteuer:0,Koerperschaftsteuer:0,Solidaritaetszuschlag:0,total:0,yearly_ebit:0};

      const purchasePlan = new Array(NUM_MONTHS).fill(0);
      for (let i=0;i<NUM_MONTHS;i++) if (i-lagMonths>=0) purchasePlan[i-lagMonths]=salesPlan[i];
      if (lagMonths>0) for (let i=NUM_MONTHS-lagMonths;i<NUM_MONTHS;i++) purchasePlan[i]=salesPlan[NUM_MONTHS-1];

      for (let i=0;i<NUM_MONTHS;i++){
        const carsSold = salesPlan[i];
        const carsBought = purchasePlan[i];

        const totalFixedCostsCashFlow = totalFixedCostsPnl;
        const totalVariableCostsPerCarCashFlow = allVariableCostsPerCarPnl;

        let salesRevenuePnl = carsSold * financialData.avgSalePrice;
        let ustDue=0, ustPaidThisMonth=0, ustVorsteuer=0, ustCashFlow=0;

        if (financialData.ustRegime === 'regular'){
          ustDue = salesRevenuePnl * UST_RATE;
          ustVorsteuer = (totalFixedCostsPnl + carsBought * allVariableCostsPerCarPnl) * UST_RATE;
          ustCashFlow = ustDue - ustVorsteuer;
          if (financialData.ustFrequency === 'monthly'){
            ustPaidThisMonth = ustCashFlow;
          } else {
            ust_period_due += ustCashFlow;
            if ((i+1)%3===0){ ustPaidThisMonth = ust_period_due; ust_period_due=0; }
            else ustPaidThisMonth = 0;
          }
          salesRevenuePnl -= ustDue; // P&L нетто
        } else if (financialData.ustRegime === 'margin'){
          const margin = carsSold * (financialData.avgSalePrice - financialData.carPurchase);
          if (margin>0) ustDue = margin * UST_SATZ / (100 + UST_SATZ);
          if (financialData.ustFrequency === 'monthly'){ ustPaidThisMonth=ustDue; }
          else { ust_period_due+=ustDue; if ((i+1)%3===0){ ustPaidThisMonth=ust_period_due; ust_period_due=0; } else ustPaidThisMonth=0; }
          // дохід містить USt, для P&L вилучаємо
          salesRevenuePnl -= ustDue;
        } else if (financialData.ustRegime === 'kleinunternehmer'){
          ustDue=0; ustPaidThisMonth=0; ustCashFlow=0; // без ПДВ
        }

        // P&L
        const cogs = carsSold * financialData.carPurchase;
        const totalVariableCostsPnl = cogs + carsSold * allVariableCostsPerCarPnl;
        const totalExpensesPnl = totalFixedCostsPnl + totalVariableCostsPnl;
        const ebit = salesRevenuePnl - totalExpensesPnl;
        yearlyEbit += ebit; yearly_gew_ertrag += ebit;

        let yearly_tax_data = last_yearly_tax_data;
        if ((i+1)%12===0 || i===NUM_MONTHS-1){
          yearly_tax_data = {Einkommensteuer:0,Gewerbesteuer:0,Koerperschaftsteuer:0,Solidaritaetszuschlag:0,total:0,yearly_ebit:yearlyEbit};
          let taxable_profit = yearlyEbit;
          if (taxable_profit>0){
            if (financialData.taxForm==='einz'){
              let est_taxable_income = taxable_profit - (financialData.healthInsurance*12);
              let est_tax = calculateESt(est_taxable_income).tax;
              let gewStTaxableBase = Math.max(0, yearly_gew_ertrag - FREIBETRAG_GEWST);
              let messbetrag = gewStTaxableBase * 0.035;
              let gewSt = messbetrag * (parseFloat(financialData.gebesatz)/100);
              let gewSt_credit = Math.min(est_tax, gewSt * 3.8);
              let est_final = Math.max(0, est_tax - gewSt_credit);
              yearly_tax_data.Einkommensteuer = est_final;
              yearly_tax_data.Gewerbesteuer = gewSt;
              yearly_tax_data.total = est_final + gewSt;
            } else if (financialData.taxForm==='gmbh'){
              let kst = taxable_profit * KST_RATE;
              let soli = kst * SOLI_RATE;
              let messbetrag = taxable_profit * 0.035;
              let gewSt = messbetrag * (parseFloat(financialData.gebesatz)/100);
              yearly_tax_data.Koerperschaftsteuer = kst;
              yearly_tax_data.Solidaritaetszuschlag = soli;
              yearly_tax_data.Gewerbesteuer = gewSt;
              yearly_tax_data.total = kst + soli + gewSt;
            }
          }
          yearlyEbit=0; yearly_gew_ertrag=0; last_yearly_tax_data = yearly_tax_data;
        }

        // Taxes cash (поквартально аванси)
        let taxesPaidThisMonth = 0;
        if ((i+1)%3===0) taxesPaidThisMonth = last_yearly_tax_data.total/4;

        const salesCashInflow = (financialData.ustRegime==='regular' || financialData.ustRegime==='kleinunternehmer')
                                ? (salesRevenuePnl + ustDue) : salesRevenuePnl;
        const fixedCostsCashOutflow = totalFixedCostsCashFlow + (financialData.ustRegime==='regular' ? totalFixedCostsPnl*UST_RATE : 0);
        const variableCostsCashOutflow = carsSold * totalVariableCostsPerCarCashFlow;
        const carPurchaseCashOutflow = carsBought * financialData.carPurchase;

        const netCashFlow = salesCashInflow - fixedCostsCashOutflow - variableCostsCashOutflow
                            - carPurchaseCashOutflow - ustPaidThisMonth - taxesPaidThisMonth
                            - financialData.healthInsurance - financialData.personalCosts;
        accumulatedCashBalance += netCashFlow;

        data.push({
          month:`Міс. ${i+1}`,
          carsSold,carsBought,
          totalRevenuePnl:salesRevenuePnl,
          totalExpensesPnl,
          ebit,
          netIncomeAfterTax: ebit - (last_yearly_tax_data.total>0 ? last_yearly_tax_data.total/12 : 0),
          netCashFlow,
          accumulatedBalance: accumulatedCashBalance,
          ustDue, ustPaidThisMonth, ustCashFlow,
          yearly_tax_data: last_yearly_tax_data,
          taxesPaidThisMonth,
          totalFixedCostsPnl, totalVariableCostsPnl,
          totalCashInflow: salesCashInflow + (i===0 ? (financialData.grant + financialData.savings) : 0),
          totalCashOutflow: fixedCostsCashOutflow + variableCostsCashOutflow + carPurchaseCashOutflow + ustPaidThisMonth + taxesPaidThisMonth
        });
      }
      return data;
    }

    function updateAnalysisSection(lang, monthIndex){
      const analysisContent = document.getElementById('analysis-content');
      const d = processedData[monthIndex];
      const financialData = {
        grant: parseFloat(document.getElementById('grant').value) || 0,
        savings: parseFloat(document.getElementById('savings').value) || 0,
        avgSalePrice: parseFloat(document.getElementById('avgSalePrice').value) || 0,
        carPurchase: parseFloat(document.getElementById('carPurchase').value) || 0,
        healthInsurance: parseFloat(document.getElementById('healthInsurance').value) || 0,
        personalCosts: parseFloat(document.getElementById('personalCosts').value) || 0,
        fixedCosts: {
          rent: parseFloat(document.getElementById('rent').value) || 0,
          accounting: parseFloat(document.getElementById('accounting').value) || 0,
          insurance: parseFloat(document.getElementById('insurance').value) || 0,
          communication: parseFloat(document.getElementById('communication').value) || 0,
          contingency: parseFloat(document.getElementById('contingency').value) || 0,
          software: parseFloat(document.getElementById('software').value) || 0,
          officeSupplies: parseFloat(document.getElementById('officeSupplies').value) || 0,
          workingMaterials: parseFloat(document.getElementById('workingMaterials').value) || 0,
          transportCosts: parseFloat(document.getElementById('transportCosts').value) || 0,
          adCosts: parseFloat(document.getElementById('adCosts').value) || 0,
          bankFees: parseFloat(document.getElementById('bankFees').value) || 0,
          repairCosts: parseFloat(document.getElementById('repairCosts').value) || 0,
        },
        variableCostsPerCar: {
          carWash: parseFloat(document.getElementById('carWash').value) || 0,
          carRepair: parseFloat(document.getElementById('carRepair').value) || 0,
          tuvDiag: parseFloat(document.getElementById('tuvDiag').value) || 0,
          logistics: parseFloat(document.getElementById('logistics').value) || 0,
          warranty: parseFloat(document.getElementById('warranty').value) || 0,
          carAd: parseFloat(document.getElementById('carAd').value) || 0,
        },
        taxForm: document.getElementById('taxForm').value,
        ustRegime: document.getElementById('ustRegime').value
      };
      const totalVariableCostsPerCar = Object.values(financialData.variableCostsPerCar).reduce((s,v)=>s+v,0);

      const t = TRANSLATIONS[lang];
      analysisContent.innerHTML = `
        <div class="space-y-4">
          <p class="font-bold text-lg">${t["analysis-month-title"]}${monthIndex+1}</p>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="p-4 bg-gray-50 rounded-lg col-span-1">
              <h4 class="font-bold text-lg mb-2">${t["analysis-summary-title"]}</h4>
              <ul class="space-y-1">
                <li><span class="font-bold">${t["analysis-total-revenue"]}</span> ${formatCurrency(d.totalRevenuePnl)}</li>
                <li><span class="font-bold">${t["analysis-total-variable-cost"]}</span> ${formatCurrency(d.totalVariableCostsPnl)}</li>
                <li><span class="font-bold">${t["analysis-total-fixed-cost"]}</span> ${formatCurrency(d.totalFixedCostsPnl)}</li>
                <li class="font-bold text-green-700">${t["analysis-ebit"]} ${formatCurrency(d.ebit)}</li>
                <li><span class="font-bold">${t["analysis-profit-per-car"]}:</span> ${formatCurrency(d.carsSold>0? d.ebit/d.carsSold : 0)}</li>
                <li class="font-bold text-blue-700">${t["analysis-after-tax-profit"]} ${formatCurrency(d.netIncomeAfterTax)}</li>
              </ul>
            </div>

            <div class="p-4 bg-gray-50 rounded-lg col-span-2">
              <h4 class="font-bold text-lg mb-2">${t["analysis-taxes-title"]}</h4>
              <p class="text-sm font-semibold">${t["yearly-profit-for-taxes"]} ${formatCurrency(d.yearly_tax_data.yearly_ebit)}</p>
              <ul class="space-y-1 mt-2 text-sm">
                ${d.yearly_tax_data.Einkommensteuer>0?`<li><span class="font-bold">${t["einkommensteuer"]}</span> ${formatCurrency(d.yearly_tax_data.Einkommensteuer)}</li>`:''}
                ${d.yearly_tax_data.Koerperschaftsteuer>0?`<li><span class="font-bold">${t["koerperschaftsteuer"]}</span> ${formatCurrency(d.yearly_tax_data.Koerperschaftsteuer)}</li>`:''}
                ${d.yearly_tax_data.Solidaritaetszuschlag>0?`<li><span class="font-bold">${t["soli-tax"]}</span> ${formatCurrency(d.yearly_tax_data.Solidaritaetszuschlag)}</li>`:''}
                ${d.yearly_tax_data.Gewerbesteuer>0?`<li><span class="font-bold">${t["gebesatz-tax"]}</span> ${formatCurrency(d.yearly_tax_data.Gewerbesteuer)}</li>`:''}
                ${d.yearly_tax_data.total>0?`<li class="font-bold text-blue-700 mt-2">${t["final-tax-for-year"]} ${formatCurrency(d.yearly_tax_data.total)}</li>`:''}
              </ul>
              <p class="font-semibold text-sm mt-4">${t["ust-note"]}</p>
              <p class="text-xs">USt: ${formatCurrency(d.ustDue)} ${d.ustPaidThisMonth>0?`(${t["tax-paid-this-month"]})`:''}</p>
            </div>

            <div class="p-4 bg-gray-50 rounded-lg col-span-3">
              <h4 class="font-bold text-lg mb-2">${t["analysis-cash-flow-title"]}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <h5 class="font-semibold">${t["chart-labels"]["cashInflow"]}</h5>
                  <ul class="list-disc list-inside space-y-1 mt-1">
                    <li>${t["analysis-total-revenue"]} ${formatCurrency(d.totalRevenuePnl)}</li>
                    <li>${t["investments-cash-flow"]} ${formatCurrency(monthIndex===0 ? (financialData.grant+financialData.savings) : 0)}</li>
                    <li><span class="font-bold">${t["ust-received"]}</span> ${formatCurrency(d.ustCashFlow>0 ? d.ustCashFlow : 0)}</li>
                  </ul>
                </div>
                <div>
                  <h5 class="font-semibold">${t["chart-labels"]["cashOutflow"]}</h5>
                  <ul class="list-disc list-inside space-y-1 mt-1">
                    <li>${t["car-purchase-cash-flow"]} ${formatCurrency(d.carsBought*financialData.carPurchase)}</li>
                    <li>${t["analysis-fixed-costs-title"]} ${formatCurrency(d.totalFixedCostsPnl)}</li>
                    <li>${t["variable-costs-sold-cars"]} ${formatCurrency(d.carsSold*totalVariableCostsPerCar)}</li>
                    <li>${t["analysis-taxes"]} ${formatCurrency(d.taxesPaidThisMonth)}</li>
                    <li><span class="font-bold">${t["ust-paid"]}</span> ${formatCurrency(d.ustPaidThisMonth)}</li>
                    <li><span class="font-bold">${t["input-health-insurance"]}</span> ${formatCurrency(financialData.healthInsurance)}</li>
                    <li><span class="font-bold">${t["input-personal-costs"]}</span> ${formatCurrency(financialData.personalCosts)}</li>
                  </ul>
                </div>
              </div>
              <p class="font-bold mt-4">${t["analysis-net-cashflow"]} ${formatCurrency(d.netCashFlow)}</p>
              <p class="font-bold">${t["analysis-final-balance"]} ${formatCurrency(d.accumulatedBalance)}</p>
            </div>
          </div>
        </div>`;
    }

    function recalculatePlan(){
      processedData = processData();

      if (chartInstances.cashFlowChart) chartInstances.cashFlowChart.destroy();
      if (chartInstances.revenueVsExpensesChart) chartInstances.revenueVsExpensesChart.destroy();
      if (chartInstances.salesChart) chartInstances.salesChart.destroy();
      if (chartInstances.costBreakdownChart) chartInstances.costBreakdownChart.destroy();

      createCharts();
      updateDashboard(0);
      updateDataTable(document.documentElement.lang);
      updateAnalysisSection(document.documentElement.lang, 0);
      document.getElementById('month-slider').value = 0;
      document.getElementById('analysis-slider').value = 0;
    }

    function setLanguage(lang){
      document.documentElement.lang = lang;
      updateTexts(lang);
      const m = parseInt(document.getElementById('month-slider').value);
      const a = parseInt(document.getElementById('analysis-slider').value);
      if (processedData){
        updateCharts(lang, m);
        updateDashboard(m);
        updateDataTable(lang);
        updateAnalysisSection(lang, a);
      }
    }

    function updateTexts(lang){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (!TRANSLATIONS[lang] || !TRANSLATIONS[lang][key]) return;
        // не перезаписуємо заголовок з <span class="selected-month-label">
        if (key === 'chart-4-title') return;
        el.textContent = TRANSLATIONS[lang][key];
      });
      document.getElementById('slider-label-month').textContent = TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('month-slider').value)+1);
      document.getElementById('slider-label-analysis-month').textContent = TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('analysis-slider').value)+1);
    }

    function updateCharts(lang, monthIndex){
      const labels = TRANSLATIONS[lang]["chart-labels"];
      if (!processedData || !processedData[monthIndex]) return;

      chartInstances.cashFlowChart.data.datasets[0].label = labels.cashFlow;
      chartInstances.cashFlowChart.update();

      chartInstances.revenueVsExpensesChart.data.datasets[0].label = labels.revenue;
      chartInstances.revenueVsExpensesChart.data.datasets[1].label = labels.expenses;
      chartInstances.revenueVsExpensesChart.update();

      chartInstances.salesChart.data.datasets[0].label = labels.sales;
      chartInstances.salesChart.update();

      // doughnut обновиться в updateDashboard
    }

    function createCharts(){
      const commonOptions = {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{position:'top'}, tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label||ctx.label}: ${formatCurrency(ctx.raw)}`}}},
        scales:{ y:{beginAtZero:false, ticks:{callback:(v)=>formatCurrency(v)}}}
      };
      const labels = TRANSLATIONS[document.documentElement.lang]["chart-labels"];

      chartInstances.cashFlowChart = new Chart(document.getElementById('cashFlowChart'),{
        type:'line',
        data:{ labels:Array.from({length:NUM_MONTHS},(_,i)=>TRANSLATIONS[document.documentElement.lang]["month-current"]+(i+1)),
          datasets:[{ label:labels.cashFlow, data:processedData.map(d=>d.accumulatedBalance), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.12)', fill:true, tension:.15 }]},
        options:{...commonOptions}
      });

      chartInstances.revenueVsExpensesChart = new Chart(document.getElementById('revenueVsExpensesChart'),{
        type:'bar',
        data:{ labels:Array.from({length:NUM_MONTHS},(_,i)=>TRANSLATIONS[document.documentElement.lang]["month-current"]+(i+1)),
          datasets:[
            { label:labels.revenue, data:processedData.map(d=>d.totalRevenuePnl), backgroundColor:'#22c55e' },
            { label:labels.expenses, data:processedData.map(d=>d.totalExpensesPnl), type:'line', borderColor:'#ef4444', backgroundColor:'#ef4444', fill:false, tension:.15 }
          ]},
        options:{...commonOptions, scales:{ x:{stacked:false}, y:{stacked:false, beginAtZero:true}}}
      });

      chartInstances.salesChart = new Chart(document.getElementById('salesChart'),{
        type:'bar',
        data:{ labels:Array.from({length:NUM_MONTHS},(_,i)=>TRANSLATIONS[document.documentElement.lang]["month-current"]+(i+1)),
          datasets:[{ label:labels.sales, data:processedData.map(d=>d.carsSold), backgroundColor:'#8b5cf6' }]},
        options:{...commonOptions, plugins:{...commonOptions.plugins, legend:{display:false}}, scales:{y:{beginAtZero:true}}}
      });

      const d0 = processedData[0];
      chartInstances.costBreakdownChart = new Chart(document.getElementById('costBreakdownChart'),{
        type:'doughnut',
        data:{ labels:[
            TRANSLATIONS[document.documentElement.lang]["fixed-costs-cat"],
            TRANSLATIONS[document.documentElement.lang]["variable-costs-cat"],
            TRANSLATIONS[document.documentElement.lang]["taxes-cat"],
            TRANSLATIONS[document.documentElement.lang]["ust-cash-cat"],
            TRANSLATIONS[document.documentElement.lang]["inventory-cat"]
          ],
          datasets:[{ data:[d0.totalFixedCostsPnl, d0.totalVariableCostsPnl, d0.taxesPaidThisMonth, d0.ustPaidThisMonth, d0.carsBought * (parseFloat(document.getElementById('carPurchase').value)||0)],
            backgroundColor:['#3b82f6','#f97316','#22c55e','#ef4444','#6b7280']}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${formatCurrency(ctx.parsed)}`}}}}
      });
    }

    function updateDashboard(monthIndex){
      const d = processedData[monthIndex];
      const lang = document.documentElement.lang;

      document.getElementById('slider-label-month').textContent = TRANSLATIONS[lang]["month-current"] + (parseInt(document.getElementById('month-slider').value)+1);
      document.querySelectorAll('.selected-month-label').forEach(el=>el.textContent = monthIndex+1);

      document.getElementById('kpi-sales').textContent = d.carsSold;
      document.getElementById('kpi-revenue').textContent = formatCurrency(d.totalRevenuePnl);
      document.getElementById('kpi-ebit').textContent = formatCurrency(d.ebit);
      document.getElementById('kpi-balance').textContent = formatCurrency(d.accumulatedBalance);

      const cp = parseFloat(document.getElementById('carPurchase').value)||0;
      const labels = [
        TRANSLATIONS[lang]["fixed-costs-cat"],
        TRANSLATIONS[lang]["variable-costs-cat"],
        TRANSLATIONS[lang]["taxes-cat"],
        TRANSLATIONS[lang]["ust-cash-cat"],
        TRANSLATIONS[lang]["inventory-cat"]
      ];
      const values = [d.totalFixedCostsPnl, d.totalVariableCostsPnl, d.taxesPaidThisMonth, d.ustPaidThisMonth, d.carsBought*cp];

      chartInstances.costBreakdownChart.data.labels = labels.filter((_,i)=>values[i]>0);
      chartInstances.costBreakdownChart.data.datasets[0].data = values.filter(v=>v>0);
      chartInstances.costBreakdownChart.update();
    }

    function updateDataTable(lang){
      const tableHead = document.querySelector('#dataTable thead');
      const tableBody = document.querySelector('#dataTable tbody');
      const headers = TRANSLATIONS[lang]["table-headers"];

      tableHead.innerHTML = `<tr>${headers.map(h=>`<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>`;
      tableBody.innerHTML = processedData.map(d=>`
        <tr class="bg-white border-b">
          <td class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${d.month.split(" ")[1]}</td>
          <td class="px-6 py-3">${d.carsSold}</td>
          <td class="px-6 py-3">${formatCurrency(d.ebit)}</td>
          <td class="px-6 py-3">${formatCurrency(d.netCashFlow)}</td>
          <td class="px-6 py-3">${formatCurrency(d.ustDue)}</td>
          <td class="px-6 py-3">${formatCurrency(d.yearly_tax_data.Gewerbesteuer)}</td>
          <td class="px-6 py-3">${formatCurrency(d.yearly_tax_data.Einkommensteuer)}</td>
          <td class="px-6 py-3">${formatCurrency(d.accumulatedBalance)}</td>
        </tr>`).join('');
    }

    document.addEventListener('DOMContentLoaded',()=>{
      // дефолтний план продажів
      const defaultSalesPlan = [1,1,2,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,10,10,10,10,10,10];
      for (let i=0;i<NUM_MONTHS;i++){
        const el = document.getElementById(`salesPlan_${i}`);
        if (el) el.value = defaultSalesPlan[i];
      }

      recalculatePlan();

      document.getElementById('month-slider').addEventListener('input', e=>updateDashboard(parseInt(e.target.value)));
      document.getElementById('analysis-slider').addEventListener('input', e=>updateAnalysisSection(document.documentElement.lang, parseInt(e.target.value)));

      document.getElementById('taxForm').addEventListener('change', ()=>{
        const taxFormValue = document.getElementById('taxForm').value;
        const gebesatzLabel = document.getElementById('gebesatz-label');
        if (taxFormValue==='einz'){ gebesatzLabel.style.display='block'; document.getElementById('ustRegime').disabled=false; }
        recalculatePlan();
      });

      document.getElementById('ustRegime').addEventListener('change', ()=>{
        const ustFrequencyBlock = document.getElementById('ust-frequency-block');
        if (document.getElementById('ustRegime').value==='kleinunternehmer') ustFrequencyBlock.style.display='none';
        else ustFrequencyBlock.style.display='block';
        recalculatePlan();
      });

      document.getElementById('ustFrequency').addEventListener('change', recalculatePlan);
      document.getElementById('calculate-button').addEventListener('click', recalculatePlan);

      document.querySelectorAll('input[type="number"]').forEach(inp=>inp.addEventListener('change', recalculatePlan));

      setLanguage('uk');
    });
  </script>
</body>
</html>
